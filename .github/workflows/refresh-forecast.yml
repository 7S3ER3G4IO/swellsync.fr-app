name: üåä Refresh Previsions Surf (toutes les 4h)

on:
  schedule:
    # Toutes les 4 heures : 0h, 4h, 8h, 12h, 16h, 20h UTC
    - cron: '0 0,4,8,12,16,20 * * *'
  # Permet de d√©clencher manuellement depuis GitHub ‚Üí Actions ‚Üí Run workflow
  workflow_dispatch:

jobs:
  refresh-forecast:
    name: Refresh StormGlass Cache
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: üåä Appel API Refresh Forecast
        env:
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          echo "D√©marrage du refresh des pr√©visions surf..."

          # V√©rifier que le secret est configur√©
          if [ -z "$CRON_SECRET" ]; then
            echo "‚ö†Ô∏è CRON_SECRET non configur√© dans GitHub Secrets"
            echo "   ‚Üí Va dans Settings > Secrets and variables > Actions > New repository secret"
            echo "   ‚Üí Nom: CRON_SECRET, Valeur: une cl√© secr√®te identique √† ta variable Vercel"
            exit 0
          fi

          RESPONSE=$(curl -s -o /tmp/response.json -w "%{http_code}" \
            -X GET "https://swellsync.fr/api/cron/refresh-forecast" \
            -H "Authorization: Bearer $CRON_SECRET" \
            -H "Content-Type: application/json" \
            --max-time 60 \
            --connect-timeout 15)

          echo "HTTP Status: $RESPONSE"
          echo "R√©ponse:"
          cat /tmp/response.json 2>/dev/null | python3 -m json.tool 2>/dev/null || cat /tmp/response.json 2>/dev/null || echo "(pas de r√©ponse)"

          if [ "$RESPONSE" = "200" ]; then
            echo "‚úÖ Refresh termin√© avec succ√®s !"
          elif [ "$RESPONSE" = "401" ]; then
            echo "‚ö†Ô∏è Erreur 401 ‚Äî CRON_SECRET incorrect ou non configur√© dans Vercel"
            echo "   ‚Üí Ajoute la variable CRON_SECRET dans Vercel Dashboard > Settings > Environment Variables"
          elif [ "$RESPONSE" = "404" ]; then
            echo "‚ö†Ô∏è Erreur 404 ‚Äî Endpoint /api/cron/refresh-forecast introuvable"
            echo "   ‚Üí V√©rifie que le fichier api/cron/refresh-forecast.js existe et est d√©ploy√©"
          else
            echo "‚ö†Ô∏è HTTP $RESPONSE ‚Äî Le refresh a peut-√™tre √©chou√© mais on continue (non bloquant)"
          fi
