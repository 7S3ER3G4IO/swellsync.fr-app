<!DOCTYPE html>
<html class="dark" lang="fr">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width,initial-scale=1.0,viewport-fit=cover" name="viewport" />
    <title>SwellSync - Pr√©visions 7 jours</title>
    <script src="js/theme.js"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
        <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="dns-prefetch" href="https://bxudysseskfpmlpagoid.supabase.co">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="css/transitions.css">
    <style>
        body {
            background: #000;
            color: #fff;
            font-family: 'Space Grotesk', sans-serif;
            min-height: 100dvh;
            padding-bottom: 100px
        }

        .card {
            background: #111;
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 16px
        }

        .hdr {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08)
        }

        .graph-bar {
            border-radius: 4px 4px 0 0;
            transition: height 0.5s ease
        }

        .tab-active {
            border-bottom: 2px solid #00bad6;
            color: #00bad6;
            font-weight: 700
        }

        .tab {
            padding: 10px 0;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            flex: 1;
            text-align: center;
            border-bottom: 2px solid transparent;
            transition: all 0.2s
        }
    </style>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#00bad6">
</head>

<body>
    <!-- Header -->
    <header class="hdr sticky top-0 z-30 px-4 py-3">
        <div class="flex items-center gap-3">
            <a href="home.html" class="tap"><span class="material-symbols-outlined text-white">arrow_back</span></a>
            <h1 class="text-lg font-bold flex-1">Pr√©visions <span class="text-[#00bad6]">7 jours</span></h1>
            <span class="material-symbols-outlined text-white">tune</span>
        </div>
        <!-- Tabs -->
        <div class="flex mt-2" id="tabs">
            <div class="tab tab-active" data-tab="swell">Houle</div>
            <div class="tab" data-tab="wind">Vent</div>
            <div class="tab" data-tab="tide">Mar√©e</div>
            <div class="tab" data-tab="temp">Temp√©rature</div>
        </div>
    </header>

    <main class="px-4 py-4 space-y-4 max-w-lg mx-auto page-enter">

        <!-- Current conditions -->
        <div class="card">
            <div class="flex items-center justify-between mb-3">
                <div>
                    <p class="text-xs text-white/50" id="fcLocation">Maintenant ¬∑ Chargement‚Ä¶</p>
                    <p class="text-2xl font-bold mt-1" id="fcNow">‚Äî <span class="text-sm text-white/50">@ ‚Äîs</span></p>
                </div>
                <div class="text-right">
                    <p class="text-3xl">üåä</p>
                    <p class="text-xs text-[#00bad6] font-bold">Bonnes conditions</p>
                </div>
            </div>
            <div class="flex gap-4 text-xs text-white/60">
                <span id="fcDir">üß≠ ‚Äî</span>
                <span id="fcWind">üí® ‚Äî</span>
                <span id="fcTemp">üå°Ô∏è ‚Äî</span>
            </div>
        </div>

        <!-- Swell Chart -->
        <div class="card" id="swellChart">
            <div class="flex items-center justify-between mb-4">
                <h2 class="font-bold text-sm">Hauteur de houle</h2>
                <span class="text-xs text-[#00bad6]">7 jours</span>
            </div>
            <div class="flex items-end justify-between gap-1" style="height:140px" id="chartBars">
            </div>
            <div class="flex justify-between mt-2 text-[9px] text-white/40" id="chartLabels">
            </div>
        </div>

        <!-- 7 Day Forecast Table -->
        <div class="card">
            <h2 class="font-bold text-sm mb-3">D√©tail jour par jour</h2>
            <div class="space-y-2" id="forecastTable">
            </div>
        </div>

        <!-- Wind Rose -->
        <div class="card">
            <h2 class="font-bold text-sm mb-3">Direction du vent</h2>
            <div class="flex items-center justify-center" style="height:160px">
                <svg viewBox="0 0 200 200" width="160" height="160">
                    <circle cx="100" cy="100" r="90" fill="none" stroke="rgba(255,255,255,0.08)" stroke-width="1" />
                    <circle cx="100" cy="100" r="60" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="1" />
                    <circle cx="100" cy="100" r="30" fill="none" stroke="rgba(255,255,255,0.03)" stroke-width="1" />
                    <text x="100" y="15" text-anchor="middle" fill="rgba(255,255,255,0.4)" font-size="10">N</text>
                    <text x="190" y="104" text-anchor="end" fill="rgba(255,255,255,0.4)" font-size="10">E</text>
                    <text x="100" y="195" text-anchor="middle" fill="rgba(255,255,255,0.4)" font-size="10">S</text>
                    <text x="15" y="104" fill="rgba(255,255,255,0.4)" font-size="10">O</text>
                    <!-- Wind arrow pointing NE -->
                    <line x1="100" y1="100" x2="140" y2="40" stroke="#00bad6" stroke-width="3" stroke-linecap="round" />
                    <polygon points="140,40 130,55 148,50" fill="#00bad6" />
                    <circle cx="100" cy="100" r="5" fill="#00bad6" />
                </svg>
            </div>
            <p class="text-center text-xs text-white/50 mt-2">Vent dominant: <span class="text-white font-bold">NE 12
                    km/h</span></p>
        </div>

        <!-- Tide Chart -->
        <div class="card">
            <h2 class="font-bold text-sm mb-3">Mar√©es aujourd'hui</h2>
            <svg viewBox="0 0 300 80" width="100%" height="80" style="display:block">
                <defs>
                    <linearGradient id="tideGrad" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="0%" stop-color="#00bad6" stop-opacity="0.3" />
                        <stop offset="100%" stop-color="#00bad6" stop-opacity="0" />
                    </linearGradient>
                </defs>
                <path d="M0,60 Q37,10 75,40 Q112,70 150,20 Q187,70 225,40 Q262,10 300,50" fill="none" stroke="#00bad6"
                    stroke-width="2" />
                <path d="M0,60 Q37,10 75,40 Q112,70 150,20 Q187,70 225,40 Q262,10 300,50 L300,80 L0,80Z"
                    fill="url(#tideGrad)" />
                <circle cx="75" cy="40" r="4" fill="#00bad6" />
                <circle cx="150" cy="20" r="4" fill="#fff" />
                <circle cx="225" cy="40" r="4" fill="#00bad6" />
            </svg>
            <div class="flex justify-between text-[10px] text-white/40 mt-2">
                <div>
                    <p class="text-white/70 font-bold">03:42</p>
                    <p>Basse mer</p>
                </div>
                <div class="text-center">
                    <p class="text-white/70 font-bold">09:18</p>
                    <p>Pleine mer</p>
                </div>
                <div class="text-center">
                    <p class="text-white/70 font-bold">15:54</p>
                    <p>Basse mer</p>
                </div>
                <div class="text-right">
                    <p class="text-white/70 font-bold">21:36</p>
                    <p>Pleine mer</p>
                </div>
            </div>
        </div>

    </main>

    <!-- Bottom Nav -->
    <nav class="fixed bottom-0 left-0 right-0 border-t border-white/10 pb-6 pt-2 px-2 flex justify-between items-center z-50 backdrop-blur-lg"
        style="background:rgba(0,0,0,0.95)">
        <a class="flex flex-col items-center gap-1 text-white flex-1" href="home.html"><span
                class="material-symbols-outlined">home</span><span class="text-[10px]">Home</span></a>
        <a class="flex flex-col items-center gap-1 text-white flex-1" href="map.html"><span
                class="material-symbols-outlined">travel_explore</span><span class="text-[10px]">Spots</span></a>
        <a class="flex flex-col items-center gap-1 text-white flex-1" href="alerts.html"><span
                class="material-symbols-outlined">notifications</span><span class="text-[10px]">Alertes</span></a>
        <a class="flex flex-col items-center gap-1 text-white flex-1" href="community.html"><span
                class="material-symbols-outlined">groups</span><span class="text-[10px]">Communaut√©</span></a>
        <a class="flex flex-col items-center gap-1 text-white flex-1" href="profile.html"><span
                class="material-symbols-outlined">person</span><span class="text-[10px]">Profil</span></a>
    </nav>

    <script src="js/api.js"></script>
    <script>
        const DAYS_FR = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];

        function degToCompass(deg) {
            if (deg == null) return '‚Äî';
            const dirs = ['N', 'NE', 'E', 'SE', 'S', 'SO', 'O', 'NO'];
            return dirs[Math.round(deg / 45) % 8];
        }

        function ratingStars(h) {
            if (h >= 2.5) return '‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê';
            if (h >= 1.8) return '‚≠ê‚≠ê‚≠ê‚≠ê';
            if (h >= 1.2) return '‚≠ê‚≠ê‚≠ê';
            if (h >= 0.6) return '‚≠ê‚≠ê';
            return '‚≠ê';
        }

        function weatherEmoji(h) {
            if (h >= 3) return 'üåä';
            if (h >= 2) return 'üí®';
            if (h >= 1) return 'üå§Ô∏è';
            return '‚òÄÔ∏è';
        }

        // Groupe les donn√©es horaires par jour, retourne les 7 prochains jours
        function groupByDay(data) {
            const days = {};
            const now = new Date();
            data.forEach(h => {
                const t = new Date(h.time);
                if (t < now) return; // ignorer le pass√©
                const day = t.toISOString().slice(0, 10);
                if (!days[day]) days[day] = { heights: [], periods: [], winds: [], temps: [], dirs: [] };
                if (h.waveHeight != null) days[day].heights.push(h.waveHeight);
                if (h.wavePeriod != null) days[day].periods.push(h.wavePeriod);
                if (h.windSpeed != null) days[day].winds.push(h.windSpeed);
                if (h.waterTemp != null) days[day].temps.push(h.waterTemp);
                if (h.waveDirection != null) days[day].dirs.push(h.waveDirection);
            });
            return Object.entries(days).slice(0, 7);
        }

        function avg(arr) { return arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : null; }
        function max(arr) { return arr.length ? Math.max(...arr) : null; }

        async function init() {
            // Spot par d√©faut : Hossegor La Gravi√®re (id=1) ou depuis le query string
            const spotId = new URLSearchParams(location.search).get('id') || 1;

            try {
                const fc = await API.spots.forecast(spotId);
                const data = fc.data;
                const now = new Date();

                // ‚îÄ‚îÄ Maintenant ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                const current = data.find(h => new Date(h.time) >= now) || data[0];
                if (current) {
                    const wh = current.waveHeight != null ? parseFloat(current.waveHeight).toFixed(1) : '‚Äî';
                    const wp = current.wavePeriod != null ? Math.round(current.wavePeriod) + 's' : '‚Äî';
                    const ws = current.windSpeed != null ? Math.round(current.windSpeed * 3.6) + ' km/h' : '‚Äî';
                    const wd = degToCompass(current.waveDirection);
                    const wdir = degToCompass(current.windDirection);
                    const wt = current.waterTemp != null ? Math.round(current.waterTemp) + '¬∞C eau' : '‚Äî';
                    document.getElementById('fcNow').innerHTML = `${wh}m <span class="text-sm text-white/50">@ ${wp}</span>`;
                    document.getElementById('fcDir').textContent = `üß≠ ${wd}`;
                    document.getElementById('fcWind').textContent = `üí® ${ws} ${wdir}`;
                    document.getElementById('fcTemp').textContent = `üå°Ô∏è ${wt}`;
                }

                // ‚îÄ‚îÄ Spot name ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                try {
                    const spot = await API.spots.get(spotId);
                    if (spot) document.getElementById('fcLocation').textContent = 'Maintenant ¬∑ ' + spot.name;
                } catch { }

                // ‚îÄ‚îÄ 7 jours ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                const dailyEntries = groupByDay(data);

                // Chart
                const bars = document.getElementById('chartBars');
                const labels = document.getElementById('chartLabels');
                bars.innerHTML = '';
                labels.innerHTML = '';
                const heights = dailyEntries.map(([, d]) => max(d.heights) || 0);
                const maxH = Math.max(...heights, 0.1);
                const todayStr = now.toISOString().slice(0, 10);

                dailyEntries.forEach(([date, d], i) => {
                    const h = max(d.heights);
                    const hStr = h != null ? h.toFixed(1) : '‚Äî';
                    const pct = h != null ? (h / maxH) * 100 : 0;
                    const isToday = date === todayStr;
                    const dt = new Date(date + 'T12:00:00');
                    const dayLabel = isToday ? 'Auj.' : DAYS_FR[dt.getDay()];

                    const bar = document.createElement('div');
                    bar.className = 'flex-1 flex flex-col items-center justify-end';
                    bar.innerHTML = `
                        <span class="text-[10px] ${isToday ? 'text-[#00bad6] font-bold' : 'text-white/50'} mb-1">${hStr}m</span>
                        <div class="w-full graph-bar ${isToday ? 'bg-[#00bad6]' : 'bg-white/10'}" style="height:${pct}%;min-height:8px"></div>`;
                    bars.appendChild(bar);

                    const lbl = document.createElement('span');
                    lbl.className = isToday ? 'text-[#00bad6] font-bold' : '';
                    lbl.textContent = dayLabel;
                    labels.appendChild(lbl);
                });

                // Tableau
                const table = document.getElementById('forecastTable');
                table.innerHTML = '';
                dailyEntries.forEach(([date, d], i) => {
                    const h = max(d.heights);
                    const p = avg(d.periods);
                    const w = avg(d.winds);
                    const t = avg(d.temps);
                    const dir = degToCompass(avg(d.dirs));
                    const isToday = date === todayStr;
                    const dt = new Date(date + 'T12:00:00');

                    const hStr = h != null ? h.toFixed(1) + 'm' : '‚Äî';
                    const pStr = p != null ? '@ ' + Math.round(p) + 's' : '';
                    const wStr = w != null ? Math.round(w * 3.6) + 'km/h ' + dir : '‚Äî';
                    const tStr = t != null ? Math.round(t) + '¬∞C' : '‚Äî';

                    const row = document.createElement('div');
                    row.className = `flex items-center gap-3 py-2 ${i < dailyEntries.length - 1 ? 'border-b border-white/5' : ''}`;
                    row.innerHTML = `
                        <span class="w-8 text-xs ${isToday ? 'text-[#00bad6] font-bold' : 'text-white/60'}">${isToday ? 'Auj.' : DAYS_FR[dt.getDay()]}</span>
                        <span class="text-lg">${weatherEmoji(h || 0)}</span>
                        <div class="flex-1">
                            <p class="text-sm font-bold">${hStr} <span class="text-white/40 font-normal">${pStr}</span></p>
                            <p class="text-[10px] text-white/40">üí® ${wStr} ¬∑ üå°Ô∏è ${tStr}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px]">${ratingStars(h || 0)}</p>
                        </div>`;
                    table.appendChild(row);
                });

                // Badge mock
                if (fc.mock) {
                    document.title = 'SwellSync ‚Äî Pr√©visions (estim√©es)';
                }

            } catch (err) {
                console.error('forecast.html error:', err);
                document.getElementById('fcNow').textContent = 'Donn√©es indisponibles';
            }

            // Direction du vent dans la rose SVG (statique pour l'instant ‚Äî mar√©e √† int√©grer plus tard)
        }

        // Tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('tab-active'));
                tab.classList.add('tab-active');
            });
        });

        init();
    </script>
    <script src="/js/cookie-consent.js"></script>
    <script src="/js/monitoring.js"></script>
    <!-- Footer l√©gal requis RGPD -->
    <div style="text-align:center;padding:8px 16px 100px;font-size:10px;color:#334155">
        <a href="/legal.html" style="color:#334155;text-decoration:none;margin:0 6px">Mentions l√©gales</a>¬∑
        <a href="/privacy.html" style="color:#334155;text-decoration:none;margin:0 6px">Confidentialit√©</a>¬∑
        <a href="/cgv.html" style="color:#334155;text-decoration:none;margin:0 6px">CGU</a>¬∑
        <a href="/cookies.html" style="color:#334155;text-decoration:none;margin:0 6px">Cookies</a>
    </div>
</body>

</html>