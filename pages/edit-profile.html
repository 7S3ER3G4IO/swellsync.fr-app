<!DOCTYPE html>
<html class="dark" lang="fr">

<head>
    <script src="js/app-guard.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>SwellSync ‚Äî Modifier le profil</title>
    <meta name="description" content="SwellSync ‚Äî Modifier votre profil surfeur.">
    <script src="https://cdn.tailwindcss.com"></script>
        <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="dns-prefetch" href="https://bxudysseskfpmlpagoid.supabase.co">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200">
    <style>
        * {
            font-family: 'Inter', system-ui, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: #000;
            color: #f1f5f9;
        }

        .card {
            background: #111;
            border: 1px solid rgba(0, 186, 214, .12);
        }

        .field-label {
            font-size: 11px;
            font-weight: 700;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: .06em;
            margin-bottom: 6px;
        }

        .field-input {
            width: 100%;
            background: #000;
            border: 1px solid rgba(0, 186, 214, .2);
            border-radius: 14px;
            padding: 12px 14px;
            color: #f1f5f9;
            font-size: 14px;
            outline: none;
            transition: border-color .2s;
        }

        .field-input:focus {
            border-color: #00bad6;
        }

        .field-input::placeholder {
            color: #475569;
        }

        .save-btn {
            width: 100%;
            padding: 14px;
            border-radius: 16px;
            font-weight: 900;
            font-size: 14px;
            background: linear-gradient(135deg, #00bad6, #0077cc);
            color: white;
            transition: opacity .2s, transform .1s;
            cursor: pointer;
        }

        .save-btn:hover {
            opacity: .9;
        }

        .save-btn:active {
            transform: scale(.98);
        }

        .save-btn:disabled {
            opacity: .5;
            cursor: not-allowed;
        }

        @keyframes fadeUp {
            from {
                opacity: 0;
                transform: translateY(8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-up {
            animation: fadeUp .25s ease both;
        }

        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 999;
            border-radius: 16px;
            padding: 12px 20px;
            font-size: 13px;
            font-weight: 700;
            white-space: nowrap;
            transition: all .4s ease;
            pointer-events: none;
        }
    </style>
    <script src="js/theme.js"></script>

    <style>
      :root { --bg-primary: #080f1a; --bg-card: #0f2438; --bg-nav: rgba(8,15,26,0.95); --text-primary: #f1f5f9; --text-secondary: #94a3b8; --border-color: rgba(0,186,214,0.2); }
      .light { --bg-primary: #f0f4f8; --bg-card: #ffffff; --bg-nav: rgba(255,255,255,0.95); --text-primary: #0f172a; --text-secondary: #475569; --border-color: rgba(0,186,214,0.15); }
      .light body { background: var(--bg-primary) !important; color: var(--text-primary) !important; }
      .light .card, .light [class*="bg-[#111]"] { background: var(--bg-card) !important; }
      .light [class*="bg-[#000]"] { background: var(--bg-primary) !important; }
      .light [class*="bg-[#111]"] { background: #f8fafc !important; }
      .light [class*="text-white"] { color: #0f172a !important; }
      .light [class*="text-slate-400"], .light [class*="text-slate-500"] { color: #64748b !important; }
      .light [class*="border-[#00bad6]"] { border-color: rgba(0,186,214,0.25) !important; }
      .light nav[style*="--nav-bg"] { --nav-bg: rgba(255,255,255,0.95) !important; border-color: rgba(0,186,214,0.15) !important; }
      .light .section-label { color: #334155 !important; }
      .light .setting-row:hover { background: #e2e8f0 !important; }
    </style>

    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#00bad6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="/assets/images/swellsync_logo.png?v=3">
    <!-- Splash screens iOS -->
    <link rel="apple-touch-startup-image" media="screen and (device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3)" href="/assets/splash/splash-1290x2796.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3)" href="/assets/splash/splash-1179x2556.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3)" href="/assets/splash/splash-1170x2532.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)" href="/assets/splash/splash-1125x2436.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)" href="/assets/splash/splash-750x1334.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 360px) and (device-height: 780px) and (-webkit-device-pixel-ratio: 3)" href="/assets/splash/splash-1080x2340.png">
</head>

<body class="min-h-screen pb-10">
  <a href="#main-content" class="skip-link" style="position:absolute;top:-40px;left:0;background:#0ea5e9;color:#fff;padding:8px 16px;z-index:9999;border-radius:0 0 8px 0;font-weight:600;text-decoration:none;transition:top .2s" onfocus="this.style.top='0'" onblur="this.style.top='-40px'">Aller au contenu principal</a>

    <!-- Header -->
    <header
        class="sticky top-0 z-50 backdrop-blur-xl bg-[#000]/95 border-b border-[#00bad6]/15 px-4 py-3 flex items-center gap-3">
        <a href="settings.html" class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-slate-400">
            <span class="material-symbols-outlined text-[18px]">arrow_back</span>
        </a>
        <h1 class="font-black text-base flex-1">Modifier le profil</h1>
        <div class="w-8 h-8 rounded-full bg-[#00bad6]/15 flex items-center justify-center active:scale-95 transition-transform">
            <span class="material-symbols-outlined text-[#00bad6] text-[18px]">person</span>
        </div>
    </header>

    <!-- Avatar Section -->
    <div class="flex flex-col items-center py-6 px-4">
        <div class="relative">
            <div id="avatarRing"
                class="w-24 h-24 rounded-full border-3 border-[#00bad6] flex items-center justify-center overflow-hidden"
                style="border: 3px solid #00bad6; background: rgba(0,186,214,.15);">
                <img loading="lazy" id="avatarImg" src="" alt="avatar" class="w-full h-full object-cover hidden" />
                <span id="avatarInitial" class="material-symbols-outlined text-[#00bad6] text-4xl">person</span>
            </div>
            <label for="avatarFile"
                class="absolute bottom-0 right-0 w-8 h-8 rounded-full bg-[#00bad6] flex items-center justify-center cursor-pointer shadow-lg active:scale-95 transition-transform">
                <span class="material-symbols-outlined text-[#080f1a] text-[16px]">photo_camera</span>
            </label>
            <input type="file" id="avatarFile" accept="image/*" class="hidden" onchange="handleAvatarChange(event)" />
        </div>
        <p class="text-[11px] text-slate-500 mt-2">Appuyer sur l'appareil photo pour changer</p>
    </div>

    <!-- Form -->
    <div class="px-4 space-y-4">

        <div class="card rounded-2xl p-4 space-y-4 fade-up">

            <div>
                <div class="field-label">Nom d'utilisateur</div>
                <input type="text" id="fieldName" class="field-input" placeholder="Ton nom sur SwellSync"
                    maxlength="30" />
            </div>

            <div>
                <div class="field-label">Bio</div>
                <textarea id="fieldBio" class="field-input resize-none" rows="3"
                    placeholder="Parle de toi en quelques mots‚Ä¶" maxlength="160"></textarea>
                <p class="text-[10px] text-slate-600 mt-1 text-right"><span id="bioCount">0</span>/160</p>
            </div>

            <div>
                <div class="field-label">R√©gion</div>
                <select id="fieldRegion" class="field-input">
                    <option value="">S√©lectionner une r√©gion‚Ä¶</option>
                    <option value="Pays Basque">Pays Basque</option>
                    <option value="Landes">Landes</option>
                    <option value="Bretagne">Bretagne</option>
                    <option value="Vend√©e">Vend√©e</option>
                    <option value="Normandie">Normandie</option>
                    <option value="M√©diterran√©e">M√©diterran√©e</option>
                    <option value="R√©union">R√©union</option>
                    <option value="Guadeloupe">Guadeloupe</option>
                    <option value="Martinique">Martinique</option>
                    <option value="Autre">Autre</option>
                </select>
            </div>

            <div>
                <div class="field-label">Niveau de Surf</div>
                <select id="fieldLevel" class="field-input">
                    <option value="debutant">üå± D√©butant</option>
                    <option value="intermediaire" selected>üèÑ Interm√©diaire</option>
                    <option value="avance">‚ö° Avanc√©</option>
                    <option value="expert">üî• Expert</option>
                </select>
            </div>

            <div>
                <div class="field-label">Email</div>
                <input type="email" id="fieldEmail" class="field-input" placeholder="ton@email.com" / autocomplete="email">
            </div>
        </div>

        <!-- Save Button -->
        <button type="button" id="saveBtn" class="save-btn" onclick="saveProfile()">
            <span id="saveBtnText">‚úÖ Sauvegarder les modifications</span>
        </button>

        <button type="button" onclick="history.back()" class="w-full py-3 text-slate-500 text-sm font-semibold">Annuler</button>

    </div>

    <!-- Toast -->
    <div id="toast" class="toast hidden"></div>

    <script>
        const API = '/api';
        let currentAvatar = null;

        // ‚îÄ‚îÄ Load profile data ‚îÄ‚îÄ
        async function loadProfile() {
            try {
                const r = await fetch(`${API}/auth/me`, { credentials: 'include' });
                if (!r.ok) throw new Error();
                const m = await r.json();
                const member = m.member || m;
                document.getElementById('fieldName').value = member.username || member.name || '';
                document.getElementById('fieldBio').value = member.bio || '';
                document.getElementById('fieldEmail').value = member.email || '';
                if (member.region) {
                    const sel = document.getElementById('fieldRegion');
                    for (let opt of sel.options) if (opt.value === member.region) { opt.selected = true; break; }
                }
                if (member.level) {
                    const sel = document.getElementById('fieldLevel');
                    for (let opt of sel.options) if (opt.value === member.level) { opt.selected = true; break; }
                }
                // Avatar
                if (member.avatar_url) {
                    document.getElementById('avatarImg').src = member.avatar_url;
                    document.getElementById('avatarImg').classList.remove('hidden');
                    document.getElementById('avatarInitial').classList.add('hidden');
                } else {
                    const initials = (member.username || member.name || 'S')[0].toUpperCase();
                    document.getElementById('avatarInitial').textContent = initials;
                }
                updateBioCount();
            } catch {
                // Use localStorage fallback
                const name = localStorage.getItem('sw_username') || '';
                document.getElementById('fieldName').value = name;
            }
        }

        // ‚îÄ‚îÄ Bio char count ‚îÄ‚îÄ
        document.getElementById('fieldBio').addEventListener('input', updateBioCount);
        function updateBioCount() {
            const v = document.getElementById('fieldBio').value;
            document.getElementById('bioCount').textContent = v.length;
        }

        // ‚îÄ‚îÄ Avatar preview ‚îÄ‚îÄ
        function handleAvatarChange(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = ev => {
                currentAvatar = ev.target.result;
                document.getElementById('avatarImg').src = currentAvatar;
                document.getElementById('avatarImg').classList.remove('hidden');
                document.getElementById('avatarInitial').classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }

        // ‚îÄ‚îÄ Save profile ‚îÄ‚îÄ
        async function saveProfile() {
            const btn = document.getElementById('saveBtn');
            const btnText = document.getElementById('saveBtnText');
            btn.disabled = true;
            btnText.textContent = '‚è≥ Sauvegarde‚Ä¶';

            const payload = {
                username: document.getElementById('fieldName').value.trim(),
                bio: document.getElementById('fieldBio').value.trim(),
                region: document.getElementById('fieldRegion').value,
                level: document.getElementById('fieldLevel').value,
                email: document.getElementById('fieldEmail').value.trim(),
            };

            try {
                // Update profile
                const r = await fetch(`${API}/auth/profile`, {
                    method: 'PUT',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!r.ok) {
                    const err = await r.json().catch(() => ({}));
                    throw new Error(err.error || 'Erreur serveur');
                }

                // Upload avatar if changed
                if (currentAvatar) {
                    await fetch(`${API}/auth/avatar`, {
                        method: 'POST',
                        credentials: 'include',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ avatar: currentAvatar })
                    });
                }

                // Save to localStorage too
                if (payload.username) localStorage.setItem('sw_username', payload.username);

                showToast('‚úÖ Profil mis √† jour !', '#10b981');
                btnText.textContent = '‚úÖ Sauvegarder les modifications';
                setTimeout(() => history.back(), 1200);

            } catch (err) {
                showToast('‚ùå ' + (err.message || 'Erreur de connexion'), '#ef4444');
                btnText.textContent = '‚úÖ Sauvegarder les modifications';
            } finally {
                btn.disabled = false;
            }
        }

        // ‚îÄ‚îÄ Toast ‚îÄ‚îÄ
        function showToast(msg, color = '#10b981') {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.style.background = color;
            t.style.color = '#fff';
            t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 3000);
        }

        loadProfile();
    </script>

    <!-- Bottom Nav -->
    <nav class="fixed bottom-0 left-0 right-0 border-t border-[#00bad6]/20 pb-6 pt-2 px-2 flex justify-between items-center z-50 backdrop-blur-lg transition-colors duration-300"
        style="background: var(--nav-bg, rgba(8,15,26,0.95))">
        <a class="flex flex-col items-center gap-1 text-slate-500 flex-1" href="home.html"><span
                class="material-symbols-outlined">home</span><span class="text-[10px]">Home</span>
        </a>
        <a class="flex flex-col items-center gap-1 text-slate-500 flex-1" href="map.html"><span
                class="material-symbols-outlined">travel_explore</span><span class="text-[10px]">Spots</span>
        </a>
        <a class="flex flex-col items-center gap-1 text-slate-500 flex-1" href="alerts.html"><span
                    class="material-symbols-outlined">notifications</span><span
                class="text-[10px]">Alertes</span>
        </a>
        <a class="flex flex-col items-center gap-1 text-slate-500 flex-1" href="community.html"><span
                class="material-symbols-outlined">groups</span><span class="text-[10px]">Communaut√©</span>
        </a>
        <a class="flex flex-col items-center gap-1 text-[#00bad6] flex-1" href="profile.html"><span
                class="material-symbols-outlined" style="font-variation-settings:'FILL' 1">person</span><span class="text-[10px] font-bold">Profil</span>
            <div class="w-1 h-1 bg-[#00bad6] rounded-full mt-0.5 active:scale-95 transition-transform"></div>
        </a>
    </nav>

    <script>
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js').catch(() => {});
      }
    </script>
<script src="js/adsense.js"></script>
<script src="js/share-social.js"></script>
<script src="js/ui-components.js"></script>
    <script src="js/notif-badge.js"></script>
    <script src="/js/cookie-consent.js"></script>
    <script src="/js/monitoring.js"></script>
    <!-- Footer l√©gal requis RGPD -->
    <div style="text-align:center;padding:8px 16px 100px;font-size:10px;color:#334155">
        <a href="/legal.html" style="color:#334155;text-decoration:none;margin:0 6px">Mentions l√©gales</a>¬∑
        <a href="/privacy.html" style="color:#334155;text-decoration:none;margin:0 6px">Confidentialit√©</a>¬∑
        <a href="/cgv.html" style="color:#334155;text-decoration:none;margin:0 6px">CGU</a>¬∑
        <a href="/cookies.html" style="color:#334155;text-decoration:none;margin:0 6px">Cookies</a>
    </div>
    <script src="/pages/js/auth-state.js"></script>
    <script src="/js/offline-banner.js"></script>
  <script src="/js/error-handler.js" defer></script>

<script>
// Auto aria-current="page" sur nav
(function() {
  const path = window.location.pathname.split('/').pop();
  document.querySelectorAll('nav a, .bottom-nav a, .navbar a').forEach(link => {
    const href = link.getAttribute('href') || '';
    if (href === path || href.endsWith('/' + path)) {
      link.setAttribute('aria-current', 'page');
    }
  });
})();
</script>
</body>

</html>