<!DOCTYPE html>
<html class="dark" lang="fr">

<head>
    <script src="js/app-guard.js"></script>
    <meta charset="utf-8" />
    <meta content="width=device-width,initial-scale=1.0" name="viewport" />
    <title>SwellSync - Profil</title>
    <meta property="og:type" content="website">
    <meta property="og:title" content="SwellSync ‚Äî Profil">
    <meta property="og:description" content="Ton profil surfeur SwellSync.">
    <meta property="og:image" content="https://swellsync.fr/assets/images/swellsync_logo.png?v=3">
    <meta property="og:site_name" content="SwellSync">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
        <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="dns-prefetch" href="https://bxudysseskfpmlpagoid.supabase.co">
    <link rel="apple-touch-icon" href="/assets/images/swellsync_logo.png?v=3">
    <meta name="description"
        content="SwellSync Badgesfil ‚Äî G√©rez votre profil surfeur, vos badges et votre historique de sessions.">
    <script src="js/theme.js"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <script>tailwind.config = { darkMode: "class", theme: { extend: { colors: { "primary": "#00bad6", "background-dark": "#000", "card-dark": "#111" }, fontFamily: { "display": ["Space Grotesk", "sans-serif"] } } } }</script>
    <style>
        .glass {
            background: rgba(15, 36, 56, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(0, 186, 214, 0.1)
        }

        body {
            min-height: max(884px, 100dvh)
        }

        /* Edit modal */
        #editModal {
            display: none
        }

        #editModal.open {
            display: flex
        }
    </style>

    <style>
        :root {
            --bg-primary: #000;
            --bg-card: #111;
            --bg-nav: rgba(8, 15, 26, 0.95);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: rgba(0, 186, 214, 0.2);
        }

        .light {
            --bg-primary: #f0f4f8;
            --bg-card: #ffffff;
            --bg-nav: rgba(255, 255, 255, 0.95);
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --border-color: rgba(0, 186, 214, 0.15);
        }

        .light body {
            background: var(--bg-primary) !important;
            color: var(--text-primary) !important;
        }

        .light .card,
        .light [class*="bg-[#111]"] {
            background: var(--bg-card) !important;
        }

        .light [class*="bg-[#000]"] {
            background: var(--bg-primary) !important;
        }

        .light [class*="bg-[#111]"] {
            background: #f8fafc !important;
        }

        .light [class*="text-white"] {
            color: #0f172a !important;
        }

        .light [class*="text-slate-400"],
        .light [class*="text-slate-500"] {
            color: #64748b !important;
        }

        .light [class*="border-[#00bad6]"] {
            border-color: rgba(0, 186, 214, 0.25) !important;
        }

        .light nav[style*="--nav-bg"] {
            --nav-bg: rgba(255, 255, 255, 0.95) !important;
            border-color: rgba(0, 186, 214, 0.15) !important;
        }

        .light .section-label {
            color: #334155 !important;
        }

        .light .setting-row:hover {
            background: #e2e8f0 !important;
        }
    </style>

    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#00bad6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="/assets/images/swellsync_logo.png?v=3">
</head>

<body class="bg-[#000] font-display text-slate-100 min-h-screen pb-24">

    <header class="flex items-center justify-between p-6 sticky top-0 z-10 glass">
        <a href="home.html" class="material-symbols-outlined text-slate-400 cursor-pointer">chevron_left</a>
        <h1 class="text-xl font-bold">Mon Profil</h1>
        <div class="flex items-center gap-2">
            <button onclick="document.getElementById('editModal').classList.add('open')"
                class="material-symbols-outlined text-slate-400 cursor-pointer text-[22px]">edit</button>
            <a href="settings.html"
                class="w-8 h-8 rounded-full bg-[#00bad6]/15 flex items-center justify-center active:scale-95 transition-transform">
                <span class="material-symbols-outlined text-[#00bad6] text-[20px]">add</span>
            </a>
        </div>
    </header>

    <main class="max-w-md mx-auto px-0 pt-0 pb-24 space-y-0">

        <!-- Instagram-style header -->
        <section class="px-4 pt-4 pb-3">
            <!-- Row: Avatar + Stats -->
            <div class="flex items-center gap-4">
                <!-- Avatar -->
                <div class="relative flex-shrink-0">
                    <label for="avatarInput" class="cursor-pointer block group">
                        <div id="avatarRing" class="w-20 h-20 rounded-full border-[3px] border-[#00bad6]/40 p-0.5">
                            <div id="avatarImg"
                                class="w-full h-full rounded-full bg-[#00bad6]/20 flex items-center justify-center overflow-hidden">
                                <span class="material-symbols-outlined text-[#00bad6] text-3xl"
                                    id="avatarIcon">person</span>
                            </div>
                        </div>
                        <div
                            class="absolute bottom-0 right-0 bg-[#00bad6] text-[#000] w-6 h-6 rounded-full flex items-center justify-center border-2 border-[#000] shadow-lg">
                            <span class="material-symbols-outlined text-[10px]">add</span>
                        </div>
                    </label>
                    <input type="file" id="avatarInput" accept="image/*" class="hidden"
                        onchange="uploadAvatar(event)" />
                </div>
                <!-- Stats row (Instagram-style) -->
                <div class="flex flex-1 justify-around text-center">
                    <div class="cursor-pointer">
                        <span id="statPosts" class="text-lg font-black text-white block">0</span>
                        <span class="text-[10px] text-slate-400">Posts</span>
                    </div>
                    <a href="following.html" class="cursor-pointer">
                        <span id="statFollowers" class="text-lg font-black text-white block">‚Äî</span>
                        <span class="text-[10px] text-slate-400">Abonn√©s</span>
                    </a>
                    <a href="following.html" class="cursor-pointer">
                        <span id="statFollowing" class="text-lg font-black text-white block">‚Äî</span>
                        <span class="text-[10px] text-slate-400">Abonnements</span>
                    </a>
                </div>
            </div>
            <!-- Name + Bio -->
            <div class="mt-3">
                <h2 class="text-base font-bold" id="profileName">Chargement‚Ä¶</h2>
                <p class="text-[#00bad6]/70 text-xs font-medium" id="profileLevel">‚Äî</p>
                <p id="profileBio" class="text-xs text-slate-300 mt-1 leading-relaxed">Surfeur passionn√© depuis toujours
                    ü§ô</p>
                <div id="proBadge"
                    class="hidden inline-flex items-center gap-1 mt-1.5 px-2 py-0.5 rounded-full bg-gradient-to-r from-[#00bad6]/20 to-emerald-500/20 border border-[#00bad6]/30 text-[#00bad6] text-[10px] font-bold">
                    ‚≠ê Pro
                </div>
            </div>
            <!-- Action buttons -->
            <div class="flex gap-2 mt-3">
                <button onclick="document.getElementById('editModal').classList.add('open')"
                    class="flex-1 py-2 rounded-lg bg-[#111] border border-[#00bad6]/20 text-white font-bold text-xs active:scale-95 transition-transform">
                    Modifier le profil
                </button>
                <button onclick="shareProfile(document.getElementById('profileName').textContent)"
                    class="flex-1 py-2 rounded-lg bg-[#111] border border-[#00bad6]/20 text-white font-bold text-xs active:scale-95 transition-transform">
                    Partager le profil
                </button>
                <a href="settings.html"
                    class="w-9 h-9 flex items-center justify-center rounded-lg bg-[#111] border border-[#00bad6]/20 active:scale-95 transition-transform">
                    <span class="material-symbols-outlined text-white text-lg">settings</span>
                </a>
            </div>
        </section>

        <!-- Tabs -->
        <div class="flex border-b border-[#00bad6]/15">
            <button onclick="showTab('posts')" id="tabPosts"
                class="flex-1 py-3 text-center text-xs font-bold text-[#00bad6] border-b-2 border-[#00bad6]">
                <span class="material-symbols-outlined text-lg">grid_on</span>
            </button>
            <button onclick="showTab('sessions')" id="tabSessions"
                class="flex-1 py-3 text-center text-xs font-bold text-slate-500">
                <span class="material-symbols-outlined text-lg">surfing</span>
            </button>
            <button onclick="showTab('favs')" id="tabFavs"
                class="flex-1 py-3 text-center text-xs font-bold text-slate-500">
                <span class="material-symbols-outlined text-lg">favorite</span>
            </button>
        </div>

        <!-- Tab: Posts Grid -->
        <div id="panelPosts" class="">
            <div id="postsGrid" class="grid grid-cols-3 gap-0.5 px-0">
                <!-- Filled dynamically -->
                <div class="aspect-square bg-[#111] flex items-center justify-center">
                    <span class="material-symbols-outlined text-slate-600 text-2xl">photo_camera</span>
                </div>
            </div>
            <p id="postsEmpty" class="text-center text-slate-500 text-xs py-8">Aucun post pour le moment.<br>Partage ta
                premi√®re session dans la communaut√© !</p>
        </div>

        <!-- Tab: Sessions -->
        <div id="panelSessions" class="hidden px-4 py-4 space-y-2">
            <div id="sessionsList" class="space-y-2"></div>
            <p id="sessionsEmpty" class="text-center text-slate-500 text-xs py-8">Aucune session enregistr√©e.</p>
        </div>

        <!-- Tab: Favoris -->
        <div id="panelFavs" class="hidden px-4 py-4 space-y-2">
            <div id="favsList" class="space-y-2"></div>
            <p id="favsEmpty" class="text-center text-slate-500 text-xs py-8">Aucun spot favori. Explore la carte !</p>
        </div>


        <!-- Spots Favoris -->
        <section id="favsSection" class="space-y-3 hidden">
            <h3 class="text-lg font-bold">‚≠ê Mes Spots Favoris</h3>
            <div id="favsList" class="space-y-2"></div>
        </section>

        <!-- Profil Communaut√© -->
        <section class="space-y-3">
            <div class="flex items-center justify-between px-1">
                <h3 class="text-lg font-bold">Profil Communaut√©</h3>
                <a href="community.html" class="text-[10px] text-[#00bad6] font-semibold flex items-center gap-1">
                    Voir <span class="material-symbols-outlined text-sm">chevron_right</span>
                </a>
            </div>
            <div class="glass rounded-2xl p-4 space-y-4">
                <!-- Bio -->
                <div>
                    <p class="text-[10px] text-slate-500 uppercase tracking-widest font-bold mb-1.5">Bio</p>
                    <p id="profileBio" class="text-sm text-slate-300 leading-relaxed">Surfeur passionn√© depuis toujours
                        ü§ô Je chasse les houles atlantiques et partage mes sessions avec la communaut√© SwellSync.</p>
                </div>
                <!-- Stats communaut√© -->
                <div class="grid grid-cols-3 gap-2">
                    <div class="bg-[#000] rounded-xl p-3 text-center">
                        <span class="text-lg font-black text-[#00bad6]" id="statPosts">0</span>
                        <p class="text-[9px] text-slate-500 uppercase tracking-wide mt-0.5">Posts</p>
                    </div>
                    <div class="bg-[#000] rounded-xl p-3 text-center">
                        <span class="text-lg font-black text-[#00bad6]" id="statReplies">0</span>
                        <p class="text-[9px] text-slate-500 uppercase tracking-wide mt-0.5">R√©ponses</p>
                    </div>
                    <div class="bg-[#000] rounded-xl p-3 text-center">
                        <span class="text-lg font-black text-[#00bad6]" id="statLikes">0</span>
                        <p class="text-[9px] text-slate-500 uppercase tracking-wide mt-0.5">Likes re√ßus</p>
                    </div>
                </div>
                <!-- Surf infos -->
                <div class="space-y-3 border-t border-white/5 pt-3">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2 text-sm">
                            <span class="material-symbols-outlined text-[#00bad6] text-base">surfing</span>
                            <span class="text-slate-400">Niveau</span>
                        </div>
                        <span class="text-sm font-bold" id="surfLevel">Interm√©diaire</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2 text-sm">
                            <span class="material-symbols-outlined text-[#00bad6] text-base">waves</span>
                            <span class="text-slate-400">Houle pr√©f√©r√©e</span>
                        </div>
                        <span class="text-sm font-bold" id="prefWave">1.5m ‚Äî 2.5m</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2 text-sm">
                            <span class="material-symbols-outlined text-[#00bad6] text-base">calendar_today</span>
                            <span class="text-slate-400">Depuis</span>
                        </div>
                        <span class="text-sm font-bold" id="surfSince">2018</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2 text-sm">
                            <span class="material-symbols-outlined text-[#00bad6] text-base">place</span>
                            <span class="text-slate-400">Spot signature</span>
                        </div>
                        <span class="text-sm font-bold" id="sigSpot">Hossegor üî•</span>
                    </div>
                </div>
                <!-- Lien communaut√© -->
                <a href="community.html"
                    class="flex items-center justify-center gap-2 mt-2 w-full py-2.5 rounded-xl border border-[#00bad6]/30 text-[#00bad6] text-sm font-bold hover:bg-[#00bad6]/10 transition-colors active:scale-95 transition-transform">
                    <span class="material-symbols-outlined text-[18px]">groups</span>
                    Rejoindre la discussion communaut√©
                </a>
            </div>
        </section>

        <!-- Param√®tres -->
        <section class="space-y-3">
            <h3 class="text-lg font-bold px-1">Param√®tres</h3>
            <div class="glass rounded-xl overflow-hidden divide-y divide-[#00bad6]/10">
                <!-- Mode sombre/clair -->
                <div class="flex items-center justify-between p-4 cursor-pointer hover:bg-[#00bad6]/5 transition-colors active:scale-95 transition-transform"
                    onclick="swToggleTheme()">
                    <div class="flex items-center gap-3">
                        <span class="material-symbols-outlined text-[#00bad6]" id="themeIcon">dark_mode</span>
                        <span class="font-medium" id="themeLabel">Mode Sombre</span>
                    </div>
                    <div id="themeToggle"
                        class="w-12 h-6 bg-[#00bad6] rounded-full relative p-1 cursor-pointer transition-all active:scale-95 transition-transform">
                        <div id="themeThumb" class="w-4 h-4 bg-[#000] rounded-full translate-x-6 transition-transform">
                        </div>
                    </div>
                </div>

                <!-- Langue -->
                <div class="flex items-center justify-between p-4">
                    <div class="flex items-center gap-3"><span
                            class="material-symbols-outlined text-[#00bad6]">language</span><span
                            class="font-medium">Langue</span></div>
                    <div class="flex items-center gap-1 bg-[#00bad6]/10 p-1 rounded-xl">
                        <button class="px-3 py-1.5 text-xs font-bold rounded-lg transition-all" id="langFR"
                            onclick="setLang('fr')">üá´üá∑ FR</button>
                        <button class="px-3 py-1.5 text-xs font-bold rounded-lg transition-all" id="langEN"
                            onclick="setLang('en')">üá¨üáß EN</button>
                    </div>
                </div>

                <a href="alerts.html"
                    class="flex items-center justify-between p-4 hover:bg-[#00bad6]/5 transition-colors active:scale-95 transition-transform">
                    <div class="flex items-center gap-3"><span
                            class="material-symbols-outlined text-[#00bad6]">notifications_active</span><span
                            class="font-medium">Mes Alertes Houle</span></div>
                    <span class="material-symbols-outlined text-slate-500">chevron_right</span>
                </a>

                <div class="flex items-center justify-between p-4 hover:bg-[#00bad6]/5 transition-colors cursor-pointer active:scale-95 transition-transform"
                    onclick="currentUser ? document.getElementById('editModal').classList.add('open') : window.location.href='home.html'">
                    <div class="flex items-center gap-3"><span
                            class="material-symbols-outlined text-[#00bad6]">manage_accounts</span><span
                            class="font-medium">Modifier le profil</span></div>
                    <span class="material-symbols-outlined text-slate-500">chevron_right</span>
                </div>

                <div class="flex items-center justify-between p-4 hover:bg-[#00bad6]/5 transition-colors cursor-pointer active:scale-95 transition-transform"
                    onclick="enablePush()">
                    <div class="flex items-center gap-3"><span
                            class="material-symbols-outlined text-[#00bad6]">notifications_active</span><span
                            class="font-medium">Notifications Push</span></div>
                    <span id="pushStatus"
                        class="text-xs px-2 py-1 rounded-full bg-slate-700 text-slate-400">Inactif</span>
                </div>
            </div>
        </section>

        <!-- Sessions Journal -->
        <section id="sessionsSection" class="space-y-3 hidden">
            <h3 class="text-lg font-bold">üèÑ Mes Sessions</h3>
            <div id="sessionsList" class="space-y-2"></div>
        </section>

        <!-- Sign Out -->
        <button onclick="signOut()"
            class="w-full py-4 text-red-400 font-bold border border-red-400/20 rounded-xl hover:bg-red-400/10 transition-colors flex items-center justify-center gap-2">
            <span class="material-symbols-outlined">logout</span> Se d√©connecter
        </button>

    </main>

    <!-- Edit Modal -->
    <div id="editModal" class="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-end justify-center">
        <div class="glass w-full max-w-md rounded-t-3xl p-6 space-y-4 border-t border-[#00bad6]/20">
            <div class="w-12 h-1.5 bg-slate-700 rounded-full mx-auto"></div>
            <h2 class="text-xl font-bold text-center">Modifier le Profil</h2>

            <div>
                <label class="text-xs text-slate-400 uppercase tracking-widest mb-2 block">Pr√©nom / Pseudo</label>
                <input id="editName" type="text" placeholder="Lucas Dupont"
                    class="w-full bg-[#000] border border-[#00bad6]/20 rounded-xl p-3 text-white text-sm focus:outline-none focus:border-[#00bad6]" />
            </div>

            <div>
                <label class="text-xs text-slate-400 uppercase tracking-widest mb-2 block">Bio / Description</label>
                <textarea id="editBio" rows="3"
                    placeholder="Surfeur passionn√© depuis toujours ü§ô Partage tes sessions..."
                    class="w-full bg-[#000] border border-[#00bad6]/20 rounded-xl p-3 text-white text-sm focus:outline-none focus:border-[#00bad6] resize-none"></textarea>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="text-xs text-slate-400 uppercase tracking-widest mb-2 block">Niveau</label>
                    <select id="editLevel"
                        class="w-full bg-[#000] border border-[#00bad6]/20 rounded-xl p-3 text-white text-sm focus:outline-none focus:border-[#00bad6]">
                        <option value="debutant">üåä D√©butant</option>
                        <option value="intermediaire">‚ö° Interm√©diaire</option>
                        <option value="avance">üî• Avanc√©</option>
                        <option value="pro">‚≠ê Pro / Comp√©tition</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs text-slate-400 uppercase tracking-widest mb-2 block">Ann√©e de d√©but</label>
                    <input id="editSince" type="number" placeholder="2018" min="1970" max="2025"
                        class="w-full bg-[#000] border border-[#00bad6]/20 rounded-xl p-3 text-white text-sm focus:outline-none focus:border-[#00bad6]" />
                </div>
            </div>

            <div>
                <label class="text-xs text-slate-400 uppercase tracking-widest mb-2 block">Houle pr√©f√©r√©e</label>
                <select id="editPrefWave"
                    class="w-full bg-[#000] border border-[#00bad6]/20 rounded-xl p-3 text-white text-sm focus:outline-none focus:border-[#00bad6]">
                    <option>
                        < 1m ‚Äî Petites et sympas</option>
                    <option>1m ‚Äî 1.5m ‚Äî Ideales</option>
                    <option selected>1.5m ‚Äî 2.5m ‚Äî Bien roul√©es</option>
                    <option>2.5m+ ‚Äî Grosses sessions</option>
                </select>
            </div>

            <div>
                <label class="text-xs text-slate-400 uppercase tracking-widest mb-2 block">Spot signature</label>
                <input id="editSigSpot" type="text" placeholder="Ex: Hossegor, La Torche..."
                    class="w-full bg-[#000] border border-[#00bad6]/20 rounded-xl p-3 text-white text-sm focus:outline-none focus:border-[#00bad6]" />
            </div>

            <div class="flex gap-3 pt-2">
                <button onclick="document.getElementById('editModal').classList.remove('open')"
                    class="flex-1 py-3 rounded-xl border border-slate-700 text-slate-400 font-semibold">Annuler</button>
                <button onclick="saveProfile()"
                    class="flex-1 py-3 rounded-xl bg-[#00bad6] text-[#000] font-bold active:scale-95 transition-transform">Sauvegarder</button>
            </div>
        </div>
    </div>

    <!-- Bottom Nav -->
    <nav class="fixed bottom-0 left-0 right-0 border-t border-[#00bad6]/20 pb-6 pt-2 px-2 flex justify-between items-center z-50 backdrop-blur-lg transition-colors duration-300"
        style="background: var(--nav-bg, rgba(8,15,26,0.95))">
        <a class="flex flex-col items-center gap-1 text-slate-500 flex-1" href="home.html"><span
                class="material-symbols-outlined">home</span><span class="text-[10px]">Home</span>

        </a>
        <a class="flex flex-col items-center gap-1 text-slate-500 flex-1" href="map.html"><span
                class="material-symbols-outlined">travel_explore</span><span class="text-[10px]">Spots</span></a>
        <a class="flex flex-col items-center gap-1 text-slate-500 flex-1" href="alerts.html"><span
                class="material-symbols-outlined">notifications</span><span class="text-[10px]">Alertes</span></a>
        <a class="flex flex-col items-center gap-1 text-slate-500 flex-1" href="community.html"><span
                class="material-symbols-outlined">groups</span><span class="text-[10px]">Communaut√©</span></a>
        <a class="flex flex-col items-center gap-1 text-[#00bad6] flex-1" href="profile.html"><span
                class="material-symbols-outlined" style="font-variation-settings:\'FILL\' 1">person</span><span
                class="text-[10px] font-bold">Profil</span>
            <div class="w-1 h-1 bg-[#00bad6] rounded-full mt-0.5 active:scale-95 transition-transform"></div>
        </a>
    </nav>


    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="js/api.js"></script>
    <script>
        let me = null;

        // Tab switching
        function showTab(tab) {
            ['posts', 'sessions', 'favs'].forEach(t => {
                document.getElementById('panel' + t.charAt(0).toUpperCase() + t.slice(1)).classList.toggle('hidden', t !== tab);
                const btn = document.getElementById('tab' + t.charAt(0).toUpperCase() + t.slice(1));
                btn.className = t === tab
                    ? 'flex-1 py-3 text-center text-xs font-bold text-[#00bad6] border-b-2 border-[#00bad6]'
                    : 'flex-1 py-3 text-center text-xs font-bold text-slate-500';
            });
        }

        async function init() {
            try {
                me = await API.auth.me();
                document.getElementById('profileName').textContent = me.name || me.email?.split('@')[0] || 'Surfeur';
                document.getElementById('profileLevel').textContent = levelLabel(me.level);
                document.getElementById('editName').value = me.name || '';
                document.getElementById('editLevel').value = me.level || 'debutant';
                if (me.is_pro) document.getElementById('proBadge').classList.remove('hidden');
                if (me.avatar_url) showAvatar(me.avatar_url);
                loadPostsGrid();
            } catch {
                document.getElementById('profileName').textContent = 'Non connect√©';
                document.getElementById('profileLevel').textContent = '';
            }

            // Stats en parall√®le
            loadStats();
            loadFavorites();
            swSyncThemeOnLoad();
            initLangUI();
        }

        async function loadPostsGrid() {
            try {
                const posts = await API.community.posts();
                const myPosts = posts.filter(p => p.member_id === me?.id && p.image_url);
                const grid = document.getElementById('postsGrid');
                const empty = document.getElementById('postsEmpty');
                if (myPosts.length > 0) {
                    grid.innerHTML = myPosts.map(p => `
                        <div class="aspect-square bg-[#111] overflow-hidden cursor-pointer" onclick="window.location.href='community.html#post-${p.id}'">
                            <img src="${p.image_url}" class="w-full h-full object-cover" loading="lazy"/>
                        </div>`).join('');
                    empty.classList.add('hidden');
                }
            } catch { }
        }

        function levelLabel(lvl) {
            return { debutant: 'D√©butant üåä', intermediaire: 'Interm√©diaire ‚ö°', avance: 'Avanc√© üî•', pro: 'Pro ‚≠ê' }[lvl] || lvl || '‚Äî';
        }

        async function loadStats() {
            const SB_URL = 'https://bxudysseskfpmlpagoid.supabase.co';
            const SB_KEY = 'sb_publishable_8UPKYf9eOQjX9-5bBGl1CA_XRu8ZkiU';

            // Sessions Supabase
            try {
                const sbClient = window.supabase?.createClient?.(SB_URL, SB_KEY);
                const { data: { session } } = sbClient ? await sbClient.auth.getSession() : { data: {} };
                const token = session?.access_token || SB_KEY;
                const res = await fetch(
                    `${SB_URL}/rest/v1/surf_sessions?select=id&order=started_at.desc`,
                    { headers: { 'apikey': SB_KEY, 'Authorization': 'Bearer ' + token } }
                );
                if (res.ok) {
                    const rows = await res.json();
                    const count = Array.isArray(rows) ? rows.length : 0;
                    // Mettre √† jour les 2 endroits o√π statSessions est affich√©
                    document.querySelectorAll('#statSessions').forEach(el => el.textContent = count);
                    document.querySelectorAll('#statsSessions').forEach(el => el.textContent = count);
                    loadJournalSection(rows);
                }
            } catch { document.querySelectorAll('#statSessions').forEach(el => el.textContent = '0'); }

            // Posts et likes communaut√©
            try {
                const posts = await API.community.posts();
                const myPosts = posts.filter(p => p.member_id === me?.id);
                const totalLikes = myPosts.reduce((s, p) => s + (p.likes_count || 0), 0);
                const totalReplies = myPosts.reduce((s, p) => s + (p.comments_count || 0), 0);
                document.querySelectorAll('#statPosts').forEach(el => el.textContent = myPosts.length);
                document.querySelectorAll('#statReplies').forEach(el => el.textContent = totalReplies);
                document.querySelectorAll('#statLikes').forEach(el => el.textContent = totalLikes);
            } catch { }

            // Alertes
            try {
                const alerts = await API.alerts.list();
                document.querySelectorAll('#statAlerts').forEach(el => el.textContent = alerts.length);
            } catch { }
        }

        function loadJournalSection(sessions) {
            if (!sessions?.length) return;
            const sec = document.getElementById('sessionsSection');
            sec.classList.remove('hidden');
            const stars = n => '‚òÖ'.repeat(n) + '‚òÜ'.repeat(5 - n);
            document.getElementById('sessionsList').innerHTML = sessions.slice(0, 5).map(s => `
              <div class="glass p-4 rounded-xl flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <span class="material-symbols-outlined text-emerald-400">sports_score</span>
                  <div>
                    <p class="font-bold text-sm">${s.spot_name || 'Spot'}</p>
                    <p class="text-[10px] text-slate-400">${s.date || ''} ¬∑ ${s.duration_min || '?'}min</p>
                  </div>
                </div>
                <span class="text-yellow-400 text-xs font-bold">${stars(s.rating || 3)}</span>
              </div>`).join('');
        }

        async function loadFavorites() {
            try {
                const favs = await API.favorites.list();
                document.getElementById('statFavs').textContent = favs.length;
                if (favs.length > 0) {
                    document.getElementById('favsSection').classList.remove('hidden');
                    document.getElementById('favsList').innerHTML = favs.map(f => `
        <div class="glass p-4 rounded-xl flex items-center justify-between">
          <div class="flex items-center gap-3">
            <span class="material-symbols-outlined text-[#00bad6]">waves</span>
            <div>
              <p class="font-bold text-sm">${f.name}</p>
              <p class="text-xs text-slate-400">${f.location}</p>
            </div>
          </div>
          <a href="spot_detail.html?id=${f.spot_id}" class="text-[#00bad6] text-xs font-bold">Voir</a>
        </div>`).join('');
                }
            } catch { document.getElementById('statFavs').textContent = '0'; }
        }

        function showAvatar(src) {
            const wrap = document.getElementById('avatarImg');
            wrap.innerHTML = `<img loading="lazy" src="${src}" class="w-full h-full object-cover" alt="avatar"/>`;
        }

        async function uploadAvatar(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async ev => {
                const b64 = ev.target.result;
                showAvatar(b64);
                try {
                    await API.auth.uploadAvatar(b64);
                    toast('üì∑ Photo de profil mise √† jour !');
                } catch { toast('Connecte-toi pour changer ta photo', 'err'); }
            };
            reader.readAsDataURL(file);
        }

        async function saveProfile() {
            const name = document.getElementById('editName').value.trim();
            const level = document.getElementById('editLevel').value;
            try {
                await API.auth.updateProfile({ name, level });
                document.getElementById('profileName').textContent = name || me?.email?.split('@')[0] || 'Surfeur';
                document.getElementById('profileLevel').textContent = levelLabel(level);
                document.getElementById('editModal').classList.remove('open');
                toast('‚úÖ Profil mis √† jour !');
            } catch { toast('Connecte-toi pour modifier le profil', 'err'); }
        }

        async function signOut() {
            try {
                await API.auth.logout();
                toast('√Ä bient√¥t ! ü§ô');
                setTimeout(() => { location.href = '/'; }, 1000);
            } catch { location.href = '/'; }
        }

        const I18N = {
            fr: { sessions: 'SESSIONS', favoris: 'FAVORIS', alertes: 'ALERTES', parametres: 'Param√®tres', modeSombre: 'Mode Sombre', modeClair: 'Mode Clair', langue: 'Langue', mesAlertes: 'Mes Alertes Houle', modifierProfil: 'Modifier le profil', notifications: 'Notifications Push', deconnexion: 'Se d√©connecter', navHome: 'Home', navSpots: 'Spots', navAlertes: 'Alertes', navNews: 'News', navProfil: 'Profil', abonnement: 'Abonnement Pro', nonConnecte: 'Non connect√©' },
            en: { sessions: 'SESSIONS', favoris: 'FAVORITES', alertes: 'ALERTS', parametres: 'Settings', modeSombre: 'Dark Mode', modeClair: 'Light Mode', langue: 'Language', mesAlertes: 'My Swell Alerts', modifierProfil: 'Edit Profile', notifications: 'Push Notifications', deconnexion: 'Sign Out', navHome: 'Home', navSpots: 'Spots', navAlertes: 'Alerts', navNews: 'News', navProfil: 'Profile', abonnement: 'Pro Plan', nonConnecte: 'Not logged in' },
            es: { sessions: 'SESIONES', favoris: 'FAVORITOS', alertes: 'ALERTAS', parametres: 'Ajustes', modeSombre: 'Modo Oscuro', modeClair: 'Modo Claro', langue: 'Idioma', mesAlertas: 'Mis Alertas de Oleaje', modifierProfil: 'Editar Perfil', notifications: 'Notificaciones Push', deconnexion: 'Cerrar Sesi√≥n', navHome: 'Inicio', navSpots: 'Spots', navAlertes: 'Alertas', navNews: 'Noticias', navProfil: 'Perfil', abonnement: 'Plan Pro', nonConnecte: 'Sin sesi√≥n' },
            pt: { sessions: 'SESS√ïES', favoris: 'FAVORITOS', alertes: 'ALERTAS', parametres: 'Configura√ß√µes', modeSombre: 'Modo Escuro', modeClaro: 'Modo Claro', langue: 'Idioma', mesAlertas: 'Minhas Alertas de Ondas', modifierProfil: 'Editar Perfil', notifications: 'Notifica√ß√µes Push', deconnexion: 'Sair', navHome: 'In√≠cio', navSpots: 'Spots', navAlertes: 'Alertas', navNews: 'Not√≠cias', navProfil: 'Perfil', abonnement: 'Plano Pro', nonConnecte: 'Sem sess√£o' }
        };

        function applyI18n(l) {
            const t = I18N[l] || I18N.fr;
            const set = (id, key) => { const el = document.getElementById(id); if (el) el.textContent = t[key]; };
            // Stats labels
            document.querySelectorAll('[data-label="sessions"]').forEach(e => e.textContent = t.sessions);
            document.querySelectorAll('[data-label="favoris"]').forEach(e => e.textContent = t.favoris);
            document.querySelectorAll('[data-label="alertes"]').forEach(e => e.textContent = t.alertes);
            // Nav items
            document.querySelectorAll('[data-label="navHome"]').forEach(e => e.textContent = t.navHome);
            document.querySelectorAll('[data-label="navSpots"]').forEach(e => e.textContent = t.navSpots);
            document.querySelectorAll('[data-label="navAlertes"]').forEach(e => e.textContent = t.navAlertes);
            document.querySelectorAll('[data-label="navNews"]').forEach(e => e.textContent = t.navNews);
            document.querySelectorAll('[data-label="navProfil"]').forEach(e => e.textContent = t.navProfil);
            // Theme labels
            const isLight = document.documentElement.classList.contains('light');
            const themeLabel = document.getElementById('themeLabel');
            if (themeLabel) themeLabel.textContent = isLight ? t.modeClair : t.modeSombre;
        }

        function setLang(l) {
            ['langFR', 'langEN', 'langES', 'langPT'].forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                el.classList.remove('bg-[#00bad6]', 'text-[#000]');
                el.classList.add('text-[#00bad6]');
            });
            const el = document.getElementById('lang' + l.toUpperCase());
            if (el) { el.classList.add('bg-[#00bad6]', 'text-[#000]'); el.classList.remove('text-[#00bad6]'); }
            localStorage.setItem('sw_lang', l);
            document.documentElement.lang = l;
            applyI18n(l);
            toast('Langue : ' + l.toUpperCase());
        }


        // Lang sync on load
        function initLangUI() {
            const lang = localStorage.getItem('sw_lang') || 'fr';
            setLang(lang);
        }


        // Fermer modal
        document.getElementById('editModal').addEventListener('click', e => {
            if (e.target === document.getElementById('editModal')) document.getElementById('editModal').classList.remove('open');
        });

        // Push Notifications ‚Äî Flow VAPID complet
        async function enablePush() {
            const statusEl = document.getElementById('pushStatus');
            if (!('Notification' in window) || !('serviceWorker' in navigator)) {
                statusEl.textContent = 'Non support√©';
                return;
            }

            // V√©rifier si d√©j√† actif
            const existing = await navigator.serviceWorker.ready.then(sw =>
                sw.pushManager.getSubscription()
            ).catch(() => null);
            if (existing) {
                statusEl.textContent = 'Actif ‚úÖ';
                statusEl.className = 'text-xs px-2 py-1 rounded-full bg-emerald-500/20 text-emerald-400';
                return;
            }

            const permission = await Notification.requestPermission();
            if (permission !== 'granted') {
                statusEl.textContent = 'Refus√©';
                return;
            }

            try {
                const sw = await navigator.serviceWorker.ready;
                // Cl√© VAPID publique (dev)
                const VAPID_PUBLIC = 'BEl62iUYgUivxIkv69yViEuiBIa-Ib9-SkvMeAtA3LFgDzkrxZJjSgSnfckjZJlg0efkiAzE9O7-bACEA1yvXMA';
                function urlBase64ToUint8Array(b64) {
                    const pad = '='.repeat((4 - b64.length % 4) % 4);
                    const base64 = (b64 + pad).replace(/-/g, '+').replace(/_/g, '/');
                    return Uint8Array.from(atob(base64), c => c.charCodeAt(0));
                }
                const sub = await sw.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC)
                });

                // Sauvegarder dans Supabase push_subscriptions
                await fetch('https://bxudysseskfpmlpagoid.supabase.co/rest/v1/push_subscriptions', {
                    method: 'POST',
                    headers: {
                        'apikey': 'sb_publishable_8UPKYf9eOQjX9-5bBGl1CA_XRu8ZkiU',
                        'Authorization': 'Bearer sb_publishable_8UPKYf9eOQjX9-5bBGl1CA_XRu8ZkiU',
                        'Content-Type': 'application/json',
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify({
                        user_id: me?.id || null,
                        subscription: sub.toJSON()
                    })
                });

                statusEl.textContent = 'Actif ‚úÖ';
                statusEl.className = 'text-xs px-2 py-1 rounded-full bg-emerald-500/20 text-emerald-400';
                toast('üîî Notifications activ√©es !');
            } catch (e) {
                statusEl.textContent = 'Erreur';
                toast('Erreur lors de l\'activation', 'err');
            }
        }

        // V√©rifier l'√©tat du push au chargement
        (async () => {
            const statusEl = document.getElementById('pushStatus');
            if (!statusEl || !('serviceWorker' in navigator)) return;
            try {
                const sub = await (await navigator.serviceWorker.ready).pushManager.getSubscription();
                if (sub) {
                    statusEl.textContent = 'Actif ‚úÖ';
                    statusEl.className = 'text-xs px-2 py-1 rounded-full bg-emerald-500/20 text-emerald-400';
                }
            } catch { }
        })();

        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = atob(base64);
            return Uint8Array.from([...rawData].map(c => c.charCodeAt(0)));
        }

        init();
    </script>
    <script src="js/adsense.js"></script>
    <script src="js/share-social.js"></script>
    <script src="js/ui-components.js"></script>
    <script src="js/notif-badge.js"></script>
    <script src="/js/i18n.js"></script>
    <script src="/js/push_notifs.js" defer></script>
    <script src="/js/cookie-consent.js"></script>
    <script src="/js/monitoring.js"></script>
    <!-- Footer l√©gal requis RGPD -->
    <div style="text-align:center;padding:8px 16px 100px;font-size:10px;color:#334155">
        <a href="/legal.html" style="color:#334155;text-decoration:none;margin:0 6px">Mentions l√©gales</a>¬∑
        <a href="/privacy.html" style="color:#334155;text-decoration:none;margin:0 6px">Confidentialit√©</a>¬∑
        <a href="/cgv.html" style="color:#334155;text-decoration:none;margin:0 6px">CGU</a>¬∑
        <a href="/cookies.html" style="color:#334155;text-decoration:none;margin:0 6px">Cookies</a>
    </div>
</body>

</html>