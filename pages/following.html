<!DOCTYPE html>
<html class="dark" lang="fr">

<head>
    <script src="js/app-guard.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>SwellSync ‚Äî Mes abonnements</title>
    <meta name="description" content="SwellSync ‚Äî G√©rez les surfeurs que vous suivez.">
    <script src="https://cdn.tailwindcss.com"></script>
        <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="dns-prefetch" href="https://bxudysseskfpmlpagoid.supabase.co">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200">
    <style>
        * {
            font-family: 'Inter', system-ui, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: #000;
            color: #f1f5f9;
        }

        .card {
            background: #111;
            border: 1px solid rgba(0, 186, 214, .12);
        }

        .user-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, .04);
            transition: background .15s;
            cursor: pointer;
        }

        .user-row:hover {
            background: rgba(0, 186, 214, .04);
        }

        .unfollow-btn {
            flex-shrink: 0;
            font-size: 11px;
            font-weight: 700;
            border: 1px solid rgba(255, 255, 255, .15);
            color: #94a3b8;
            border-radius: 12px;
            padding: 5px 12px;
            transition: all .15s;
        }

        .unfollow-btn:hover {
            border-color: #ef4444;
            color: #f87171;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .slide-in {
            animation: slideIn .2s ease both;
        }
    </style>
    <script src="js/theme.js"></script>

    <style>
      :root { --bg-primary: #080f1a; --bg-card: #0f2438; --bg-nav: rgba(8,15,26,0.95); --text-primary: #f1f5f9; --text-secondary: #94a3b8; --border-color: rgba(0,186,214,0.2); }
      .light { --bg-primary: #f0f4f8; --bg-card: #ffffff; --bg-nav: rgba(255,255,255,0.95); --text-primary: #0f172a; --text-secondary: #475569; --border-color: rgba(0,186,214,0.15); }
      .light body { background: var(--bg-primary) !important; color: var(--text-primary) !important; }
      .light .card, .light [class*="bg-[#111]"] { background: var(--bg-card) !important; }
      .light [class*="bg-[#000]"] { background: var(--bg-primary) !important; }
      .light [class*="bg-[#111]"] { background: #f8fafc !important; }
      .light [class*="text-white"] { color: #0f172a !important; }
      .light [class*="text-slate-400"], .light [class*="text-slate-500"] { color: #64748b !important; }
      .light [class*="border-[#00bad6]"] { border-color: rgba(0,186,214,0.25) !important; }
      .light nav[style*="--nav-bg"] { --nav-bg: rgba(255,255,255,0.95) !important; border-color: rgba(0,186,214,0.15) !important; }
      .light .section-label { color: #334155 !important; }
      .light .setting-row:hover { background: #e2e8f0 !important; }
    </style>

    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#00bad6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="/assets/images/swellsync_logo.png?v=3">
    <!-- Splash screens iOS -->
    <link rel="apple-touch-startup-image" media="screen and (device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3)" href="/assets/splash/splash-1290x2796.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3)" href="/assets/splash/splash-1179x2556.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3)" href="/assets/splash/splash-1170x2532.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)" href="/assets/splash/splash-1125x2436.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)" href="/assets/splash/splash-750x1334.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 360px) and (device-height: 780px) and (-webkit-device-pixel-ratio: 3)" href="/assets/splash/splash-1080x2340.png">
</head>

<body class="min-h-screen pb-10">
  <a href="#main-content" class="skip-link" style="position:absolute;top:-40px;left:0;background:#0ea5e9;color:#fff;padding:8px 16px;z-index:9999;border-radius:0 0 8px 0;font-weight:600;text-decoration:none;transition:top .2s" onfocus="this.style.top='0'" onblur="this.style.top='-40px'">Aller au contenu principal</a>

    <!-- Header -->
    <header
        class="sticky top-0 z-50 backdrop-blur-xl bg-[#000]/95 border-b border-[#00bad6]/15 px-4 py-3 flex items-center gap-3">
        <a href="javascript:history.back()"
            class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-slate-400">
            <span class="material-symbols-outlined text-[18px]">arrow_back</span>
        </a>
        <h1 class="font-black text-base flex-1">Mes abonnements</h1>
        <span id="countBadge"
            class="text-[11px] bg-[#00bad6]/20 text-[#00bad6] px-2.5 py-1 rounded-full font-bold active:scale-95 transition-transform">0</span>
    </header>

    <!-- Tabs: Following / Followers -->
    <div class="flex border-b border-white/5">
        <button type="button" class="flex-1 py-3 text-sm font-bold text-[#00bad6] border-b-2 border-[#00bad6]" id="tabAbonnements"
            onclick="switchTab('following')">
            Abonnements
        </button>
        <button type="button" class="flex-1 py-3 text-sm font-bold text-slate-500 border-b-2 border-transparent" id="tabAbonnes"
            onclick="switchTab('followers')">
            Abonn√©s
        </button>
    </div>

    <!-- Following list -->
    <div id="followingSection">
        <div id="followingList" class="card mx-4 mt-4 rounded-2xl overflow-hidden"></div>
        <div id="followingEmpty" class="hidden text-center py-12 px-4">
            <div class="text-4xl mb-3">üåä</div>
            <p class="font-bold text-slate-300">Pas encore d'abonnements</p>
            <p class="text-slate-500 text-sm mt-1">Suis d'autres surfeurs depuis la communaut√© ou la recherche.</p>
            <a href="community.html"
                class="inline-flex items-center gap-2 mt-4 px-4 py-2 rounded-xl bg-[#00bad6]/15 text-[#00bad6] font-bold text-sm active:scale-95 transition-transform">
                D√©couvrir la communaut√©
            </a>
        </div>
    </div>

    <!-- Followers list (static demo) -->
    <div id="followersSection" class="hidden">
        <div class="card mx-4 mt-4 rounded-2xl overflow-hidden" id="followersList"></div>
        <p class="text-center text-[10px] text-slate-600 mt-3 px-4">Tes abonn√©s sont les personnes qui te suivent sur
            SwellSync.</p>
    </div>

    <script>
        const SB_URL = 'https://bxudysseskfpmlpagoid.supabase.co';
        const SB_KEY = 'sb_publishable_8UPKYf9eOQjX9-5bBGl1CA_XRu8ZkiU';
        let currentTab = 'following';
        let followingCount = 0, followersCount = 0;

        async function getToken() {
            try {
                if (!window.supabase?.createClient) return null;
                const sb = window.supabase.createClient(SB_URL, SB_KEY);
                const { data } = await sb.auth.getSession();
                return data?.session?.access_token || null;
            } catch { return null; }
        }

        async function loadFollowing() {
            const list = document.getElementById('followingList');
            const empty = document.getElementById('followingEmpty');
            list.innerHTML = `<div class="p-4 space-y-3">${[1,2,3].map(() => `<div class="flex items-center gap-3 animate-pulse"><div class="w-10 h-10 rounded-full bg-white/5 shrink-0"></div><div class="flex-1 space-y-1.5"><div class="h-3 bg-white/5 rounded w-2/3"></div><div class="h-2.5 bg-white/5 rounded w-1/3"></div></div></div>`).join('')}</div>`;
            list.classList.remove('hidden'); empty.classList.add('hidden');

            try {
                const token = await getToken();
                if (!token) { list.classList.add('hidden'); empty.classList.remove('hidden'); return; }

                // R√©cup√©rer la liste des personnes suivies
                const res = await fetch(`${SB_URL}/rest/v1/follows?select=followed_id,members!follows_followed_id_fkey(id,pseudo,region,avatar_url,sessions_count)&follower_id=eq.${await getCurrentUserId(token)}`, {
                    headers: { 'apikey': SB_KEY, 'Authorization': `Bearer ${token}` }
                });
                const data = res.ok ? await res.json() : [];
                followingCount = data.length;
                document.getElementById('countBadge').textContent = followingCount;

                if (!data.length) { list.classList.add('hidden'); empty.classList.remove('hidden'); return; }

                list.classList.remove('hidden'); empty.classList.add('hidden');
                list.innerHTML = data.map((row, i) => {
                    const u = row.members || {};
                    const initiale = (u.pseudo || u.email || '?')[0].toUpperCase();
                    return `<div class="user-row slide-in" style="animation-delay:${i*.04}s" onclick="window.location.href='user-profile.html?id=${u.id}'">
                        <div class="w-10 h-10 rounded-full bg-[#00bad6]/20 flex items-center justify-center font-black text-sm shrink-0 overflow-hidden">
                            ${u.avatar_url ? `<img src="${u.avatar_url}" class="w-full h-full object-cover" loading="lazy" decoding="async">` : `<span class="text-[#00bad6]">${initiale}</span>`}
                        </div>
                        <div class="flex-1 min-w-0">
                            <span class="font-bold text-sm">${u.pseudo || 'Surfeur'}</span>
                            <p class="text-[11px] text-slate-500">${u.region || '‚Äî'} ¬∑ ${u.sessions_count || 0} sessions</p>
                        </div>
                        <button type="button" class="unfollow-btn" onclick="event.stopPropagation();unfollow('${u.id}',this)">Se d√©sabonner</button>
                    </div>`;
                }).join('');
            } catch { list.classList.add('hidden'); empty.classList.remove('hidden'); }
        }

        async function loadFollowers() {
            const list = document.getElementById('followersList');
            list.innerHTML = `<p class="p-4 text-center text-slate-500 text-sm animate-pulse">Chargement‚Ä¶</p>`;

            try {
                const token = await getToken();
                if (!token) { list.innerHTML = `<p class="p-4 text-center text-slate-500 text-sm">Connecte-toi pour voir tes abonn√©s.</p>`; return; }

                const userId = await getCurrentUserId(token);
                const res = await fetch(`${SB_URL}/rest/v1/follows?select=follower_id,members!follows_follower_id_fkey(id,pseudo,region,avatar_url)&followed_id=eq.${userId}`, {
                    headers: { 'apikey': SB_KEY, 'Authorization': `Bearer ${token}` }
                });
                const data = res.ok ? await res.json() : [];
                followersCount = data.length;
                if (currentTab === 'followers') document.getElementById('countBadge').textContent = followersCount;

                if (!data.length) {
                    list.innerHTML = `<div class="p-6 text-center"><div class="text-3xl mb-2">üåä</div><p class="text-sm text-slate-400">Pas encore d'abonn√©s. Partage tes sessions pour en avoir !</p></div>`;
                    return;
                }

                list.innerHTML = data.map((row, i) => {
                    const u = row.members || {};
                    const initiale = (u.pseudo || '?')[0].toUpperCase();
                    return `<div class="user-row slide-in" style="animation-delay:${i*.04}s" onclick="window.location.href='user-profile.html?id=${u.id}'">
                        <div class="w-10 h-10 rounded-full bg-slate-700/60 flex items-center justify-center font-black text-sm shrink-0 overflow-hidden">
                            ${u.avatar_url ? `<img src="${u.avatar_url}" class="w-full h-full object-cover" loading="lazy" decoding="async">` : `<span class="text-slate-300">${initiale}</span>`}
                        </div>
                        <div class="flex-1 min-w-0">
                            <span class="font-bold text-sm">${u.pseudo || 'Surfeur'}</span>
                            <p class="text-[11px] text-slate-500">${u.region || '‚Äî'}</p>
                        </div>
                        <a href="user-profile.html?id=${u.id}" class="text-[11px] bg-[#00bad6]/15 text-[#00bad6] font-bold px-3 py-1.5 rounded-xl active:scale-95 transition-transform">Voir</a>
                    </div>`;
                }).join('');
            } catch { list.innerHTML = `<p class="p-4 text-center text-slate-500 text-sm">Erreur de chargement.</p>`; }
        }

        async function getCurrentUserId(token) {
            const r = await fetch(`${SB_URL}/auth/v1/user`, { headers: { 'apikey': SB_KEY, 'Authorization': `Bearer ${token}` } });
            const d = await r.json(); return d.id;
        }

        async function unfollow(userId, btn) {
            btn.textContent = '‚è≥'; btn.disabled = true;
            const token = await getToken();
            if (!token) return;
            const myId = await getCurrentUserId(token);
            await fetch(`${SB_URL}/rest/v1/follows?follower_id=eq.${myId}&followed_id=eq.${userId}`, {
                method: 'DELETE', headers: { 'apikey': SB_KEY, 'Authorization': `Bearer ${token}` }
            });
            loadFollowing();
        }

        function switchTab(tab) {
            currentTab = tab;
            document.getElementById('followingSection').classList.toggle('hidden', tab !== 'following');
            document.getElementById('followersSection').classList.toggle('hidden', tab !== 'followers');
            document.getElementById('tabAbonnements').classList.toggle('text-[#00bad6]', tab === 'following');
            document.getElementById('tabAbonnements').classList.toggle('text-slate-500', tab !== 'following');
            document.getElementById('tabAbonnements').style.borderBottomColor = tab === 'following' ? '#00bad6' : 'transparent';
            document.getElementById('tabAbonnes').classList.toggle('text-[#00bad6]', tab === 'followers');
            document.getElementById('tabAbonnes').classList.toggle('text-slate-500', tab !== 'followers');
            document.getElementById('tabAbonnes').style.borderBottomColor = tab === 'followers' ? '#00bad6' : 'transparent';
            document.getElementById('countBadge').textContent = tab === 'following' ? followingCount : followersCount;
        }

        // Charger les deux tabs en parall√®le
        loadFollowing();
        loadFollowers();
    </script>

    <script>
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js').catch(() => {});
      }
    </script>
<script src="js/adsense.js"></script>
<script src="js/share-social.js"></script>
<script src="js/ui-components.js"></script>
    <script src="js/notif-badge.js"></script>
    <script src="/js/cookie-consent.js"></script>
    <script src="/js/monitoring.js"></script>
    <!-- Footer l√©gal requis RGPD -->
    <div style="text-align:center;padding:8px 16px 100px;font-size:10px;color:#334155">
        <a href="/legal.html" style="color:#334155;text-decoration:none;margin:0 6px">Mentions l√©gales</a>¬∑
        <a href="/privacy.html" style="color:#334155;text-decoration:none;margin:0 6px">Confidentialit√©</a>¬∑
        <a href="/cgv.html" style="color:#334155;text-decoration:none;margin:0 6px">CGU</a>¬∑
        <a href="/cookies.html" style="color:#334155;text-decoration:none;margin:0 6px">Cookies</a>
    </div>
    <script src="/pages/js/auth-state.js"></script>
    <script src="/js/offline-banner.js"></script>
  <script src="/js/error-handler.js" defer></script>

<script>
// Auto aria-current="page" sur nav
(function() {
  const path = window.location.pathname.split('/').pop();
  document.querySelectorAll('nav a, .bottom-nav a, .navbar a').forEach(link => {
    const href = link.getAttribute('href') || '';
    if (href === path || href.endsWith('/' + path)) {
      link.setAttribute('aria-current', 'page');
    }
  });
})();
</script>
</body>

</html>