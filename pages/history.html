<!DOCTYPE html>
<html class="dark" lang="fr">

<head>
    <script src="js/app-guard.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>SwellSync ‚Äî Historique d'activit√©</title>
    <meta name="description" content="SwellSync ‚Äî Historique de vos activit√©s et sessions de surf.">
    <script src="https://cdn.tailwindcss.com"></script>
        <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="dns-prefetch" href="https://bxudysseskfpmlpagoid.supabase.co">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200">
    <style>
        * {
            font-family: 'Inter', system-ui, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: #000;
            color: #f1f5f9;
        }

        .card {
            background: #111;
            border: 1px solid rgba(0, 186, 214, .12);
        }

        .activity-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, .04);
            transition: background .15s;
        }

        .activity-row:last-child {
            border: none;
        }

        .activity-row:hover {
            background: rgba(0, 186, 214, .03);
        }

        .activity-icon {
            width: 36px;
            height: 36px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 16px;
        }

        .activity-time {
            font-size: 10px;
            color: #475569;
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            font-size: 11px;
            font-weight: 700;
            transition: all .2s;
            border-bottom: 2px solid transparent;
        }

        .tab-btn.active {
            color: #00bad6;
            border-bottom-color: #00bad6;
        }

        .tab-btn:not(.active) {
            color: #64748b;
        }

        @keyframes fadeUp {
            from {
                opacity: 0;
                transform: translateY(6px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-up {
            animation: fadeUp .2s ease both;
        }
    </style>
    <script src="js/theme.js"></script>

    <style>
        :root {
            --bg-primary: #000;
            --bg-card: #111;
            --bg-nav: rgba(8, 15, 26, 0.95);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: rgba(0, 186, 214, 0.2);
        }

        .light {
            --bg-primary: #f0f4f8;
            --bg-card: #ffffff;
            --bg-nav: rgba(255, 255, 255, 0.95);
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --border-color: rgba(0, 186, 214, 0.15);
        }

        .light body {
            background: var(--bg-primary) !important;
            color: var(--text-primary) !important;
        }

        .light .card,
        .light [class*="bg-[#111]"] {
            background: var(--bg-card) !important;
        }

        .light [class*="bg-[#000]"] {
            background: var(--bg-primary) !important;
        }

        .light [class*="bg-[#111]"] {
            background: #f8fafc !important;
        }

        .light [class*="text-white"] {
            color: #0f172a !important;
        }

        .light [class*="text-slate-400"],
        .light [class*="text-slate-500"] {
            color: #64748b !important;
        }

        .light [class*="border-[#00bad6]"] {
            border-color: rgba(0, 186, 214, 0.25) !important;
        }

        .light nav[style*="--nav-bg"] {
            --nav-bg: rgba(255, 255, 255, 0.95) !important;
            border-color: rgba(0, 186, 214, 0.15) !important;
        }

        .light .section-label {
            color: #334155 !important;
        }

        .light .setting-row:hover {
            background: #e2e8f0 !important;
        }
    </style>

    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#00bad6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="/assets/images/swellsync_logo.png?v=3">
    <!-- Splash screens iOS -->
    <link rel="apple-touch-startup-image" media="screen and (device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3)" href="/assets/splash/splash-1290x2796.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3)" href="/assets/splash/splash-1179x2556.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3)" href="/assets/splash/splash-1170x2532.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)" href="/assets/splash/splash-1125x2436.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)" href="/assets/splash/splash-750x1334.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 360px) and (device-height: 780px) and (-webkit-device-pixel-ratio: 3)" href="/assets/splash/splash-1080x2340.png">
</head>

<body class="min-h-screen pb-20">

    <!-- Header -->
    <header
        class="sticky top-0 z-50 backdrop-blur-xl bg-[#000]/95 border-b border-[#00bad6]/15 px-4 py-3 flex items-center gap-3">
        <a href="javascript:history.back()"
            class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-slate-400">
            <span class="material-symbols-outlined text-[18px]">arrow_back</span>
        </a>
        <h1 class="font-black text-base flex-1">Historique d'activit√©</h1>
        <div
            class="w-8 h-8 rounded-full bg-[#00bad6]/15 flex items-center justify-center active:scale-95 transition-transform">
            <span class="material-symbols-outlined text-[#00bad6] text-[18px]">history</span>
        </div>
    </header>

    <!-- Tabs -->
    <div class="flex border-b border-white/5">
        <button class="tab-btn active" id="tabLikes" onclick="switchTab('likes')">‚ù§Ô∏è Likes</button>
        <button class="tab-btn" id="tabSessions" onclick="switchTab('sessions')">üèÑ Sessions</button>
        <button class="tab-btn" id="tabFollows" onclick="switchTab('follows')">üë• Abonnements</button>
        <button class="tab-btn" id="tabVues" onclick="switchTab('vues')">üëÅÔ∏è Vus</button>
    </div>

    <!-- Stats -->
    <div class="grid grid-cols-3 gap-3 px-4 mt-4 mb-4">
        <div class="card rounded-2xl p-3 text-center">
            <div class="text-xl font-black text-red-400" id="statsLikes">0</div>
            <div class="text-[9px] text-slate-500 font-bold mt-0.5">Likes donn√©s</div>
        </div>
        <div class="card rounded-2xl p-3 text-center">
            <div class="text-xl font-black text-[#00bad6]" id="statsSessions">0</div>
            <div class="text-[9px] text-slate-500 font-bold mt-0.5">Sessions</div>
        </div>
        <div class="card rounded-2xl p-3 text-center">
            <div class="text-xl font-black text-purple-400" id="statsFollows">0</div>
            <div class="text-[9px] text-slate-500 font-bold mt-0.5">Suivis</div>
        </div>
    </div>

    <!-- Content -->
    <div class="px-4" id="historyContent"></div>

    <script>
        const API_URL = '/api';
        const SB_URL = 'https://bxudysseskfpmlpagoid.supabase.co';
        const SB_KEY = 'sb_publishable_8UPKYf9eOQjX9-5bBGl1CA_XRu8ZkiU';
        let sessions = [];

        // ‚îÄ‚îÄ Data from localStorage & API ‚îÄ‚îÄ
        const likeHistory = JSON.parse(localStorage.getItem('sw_likeHistory') || '[]');
        const homeLikes = JSON.parse(localStorage.getItem('sw_homeLikes') || '{}');
        const followed = JSON.parse(localStorage.getItem('sw_followed') || '[]');

        // Build like list from homeLikes
        const likeEntries = Object.keys(homeLikes).map(key => ({
            type: 'like',
            postId: key.replace('p', ''),
            user: key === 'p1' ? 'Jer√¥meS' : key === 'p2' ? 'MarieLR' : 'Post ' + key,
            text: key === 'p1' ? 'Session incroyable √† Hossegor‚Ä¶' : key === 'p2' ? 'Quelqu\'un a des infos sur La Torche‚Ä¶' : 'Post communaut√©',
            time: 'Aujourd\'hui',
            color: 'bg-red-500/15',
            icon: '‚ù§Ô∏è'
        }));

        // Mock viewed profiles
        const mockVues = [
            { user: 'SurfGuide64', region: 'Landes', time: 'Il y a 2h', avatar: 'S', color: 'bg-amber-400/20 text-amber-400' },
            { user: 'Jer√¥meS', region: 'Pays Basque', time: 'Hier', avatar: 'J', color: 'bg-[#00bad6]/20 text-[#00bad6]' },
            { user: 'MarieLR', region: 'Bretagne', time: 'Il y a 3j', avatar: 'M', color: 'bg-purple-500/20 text-purple-400' },
        ];

        // ‚îÄ‚îÄ Fetch real sessions from Supabase ‚îÄ‚îÄ
        async function fetchSessions() {
            try {
                // R√©cup√©rer le token Supabase depuis la session active
                const sbClient = window.supabase?.createClient?.(SB_URL, SB_KEY);
                const { data: { session } } = sbClient ? await sbClient.auth.getSession() : { data: {} };
                const token = session?.access_token || SB_KEY;

                const res = await fetch(
                    `${SB_URL}/rest/v1/surf_sessions?select=*&order=started_at.desc&limit=50`,
                    { headers: { 'apikey': SB_KEY, 'Authorization': 'Bearer ' + token } }
                );
                if (res.ok) {
                    sessions = await res.json();
                    document.getElementById('statsSessions').textContent = sessions.length;
                    // Si on est sur l'onglet sessions, re-render
                    const activeTab = document.querySelector('.tab-btn.active');
                    if (activeTab?.id === 'tabSessions') renderTab('sessions');
                }
            } catch { }
        }

        // ‚îÄ‚îÄ Update stats ‚îÄ‚îÄ
        document.getElementById('statsLikes').textContent = likeEntries.length + likeHistory.length;
        document.getElementById('statsSessions').textContent = '‚Ä¶';
        document.getElementById('statsFollows').textContent = followed.length;

        fetchSessions();

        function switchTab(tab) {
            ['likes', 'sessions', 'follows', 'vues'].forEach(t => {
                const btn = document.getElementById('tab' + t[0].toUpperCase() + t.slice(1));
                btn.classList.toggle('active', t === tab);
                btn.style.borderBottomColor = t === tab ? '#00bad6' : 'transparent';
                btn.style.color = t === tab ? '#00bad6' : '#64748b';
            });
            renderTab(tab);
        }

        function renderTab(tab) {
            const c = document.getElementById('historyContent');
            if (tab === 'likes') {
                if (likeEntries.length === 0) {
                    c.innerHTML = emptyState('‚ù§Ô∏è', 'Pas encore de likes', 'Tes likes sur la communaut√© appara√Ætront ici.');
                    return;
                }
                c.innerHTML = `<div class="card rounded-2xl overflow-hidden">` +
                    likeEntries.map((e, i) => `
                <div class="activity-row fade-up" style="animation-delay:${i * .04}s" onclick="window.location.href='community.html#post-${e.postId}'">
                    <div class="activity-icon" style="background:rgba(239,68,68,.15)">‚ù§Ô∏è</div>
                    <div class="flex-1 min-w-0">
                        <p class="text-xs font-bold">Tu as lik√© un post de <span class="text-[#00bad6]">${e.user}</span></p>
                        <p class="text-[10px] text-slate-500 truncate">${e.text}</p>
                        <p class="activity-time mt-0.5">${e.time}</p>
                    </div>
                    <span class="material-symbols-outlined text-slate-600 text-[16px]">chevron_right</span>
                </div>`
                    ).join('') + `</div>`;
            } else if (tab === 'sessions') {
                if (sessions.length === 0) {
                    c.innerHTML = emptyState('üèÑ', 'Aucune session enregistr√©e', 'Lance une session depuis l\'app pour la voir ici !');
                    return;
                }
                const slist = sessions.map(s => ({
                    spot: s.spot_name || 'Spot',
                    date: s.started_at ? new Date(s.started_at).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', year: 'numeric' }) : '‚Äî',
                    duration: s.duration ? (Math.floor(s.duration / 60) + 'min') : '‚Äî',
                    score: s.score ?? '‚Äî',
                    waves: s.waves ?? '‚Äî'
                }));
                c.innerHTML = `<div class="card rounded-2xl overflow-hidden">` +
                    slist.map((s, i) => `
                <div class="activity-row fade-up" style="animation-delay:${i * .04}s">
                    <div class="activity-icon" style="background:rgba(0,186,214,.15)">üèÑ</div>
                    <div class="flex-1 min-w-0">
                        <p class="text-xs font-bold">${s.spot}</p>
                        <div class="flex items-center gap-2 mt-0.5">
                            <span class="text-[10px] text-slate-400">‚è±Ô∏è ${s.duration}</span>
                            <span class="text-[10px] text-emerald-400">üåä ${s.waves} vagues</span>
                            <span class="text-[10px] text-amber-400 font-bold">Score ${s.score}</span>
                        </div>
                        <p class="activity-time mt-0.5">${s.date}</p>
                    </div>
                </div>`
                    ).join('') + `</div>`;
            } else if (tab === 'follows') {
                if (followed.length === 0) {
                    c.innerHTML = emptyState('üë•', 'Pas d\'abonnements', 'Suis des surfeurs dans la communaut√© pour les voir ici.');
                    return;
                }
                const followUsers = {
                    jeromesS: { name: 'Jer√¥meS', time: 'Aujourd\'hui', avatar: 'J', color: 'bg-[#00bad6]/20 text-[#00bad6]' },
                    marieLR: { name: 'MarieLR', time: 'Il y a 2j', avatar: 'M', color: 'bg-purple-500/20 text-purple-400' },
                };
                c.innerHTML = `<div class="card rounded-2xl overflow-hidden">` +
                    followed.map((id, i) => {
                        const u = followUsers[id] || { name: id, time: 'R√©cemment', avatar: id[0]?.toUpperCase() || '?', color: 'bg-slate-700 text-slate-300' };
                        return `<div class="activity-row fade-up" style="animation-delay:${i * .04}s" onclick="window.location.href='user-profile.html?id=${id}'">
                    <div class="activity-icon ${u.color} !w-10 !h-10 !text-base font-black !rounded-full">${u.avatar}</div>
                    <div class="flex-1">
                        <p class="text-xs font-bold">Tu suis <span class="text-purple-400">${u.name}</span></p>
                        <p class="activity-time">${u.time}</p>
                    </div>
                    <span class="material-symbols-outlined text-slate-600 text-[16px]">chevron_right</span>
                </div>`;
                    }).join('') + `</div>`;
            } else if (tab === 'vues') {
                c.innerHTML = `<div class="card rounded-2xl overflow-hidden">` +
                    mockVues.map((u, i) => `
                <div class="activity-row fade-up" style="animation-delay:${i * .04}s" onclick="window.location.href='user-profile.html?id=${u.user.toLowerCase()}'">
                    <div class="w-10 h-10 rounded-full ${u.color} flex items-center justify-center font-black text-sm shrink-0">${u.avatar}</div>
                    <div class="flex-1">
                        <p class="text-xs font-bold">Profil consult√© : <span class="text-slate-300">${u.user}</span></p>
                        <p class="text-[10px] text-slate-500">${u.region}</p>
                        <p class="activity-time mt-0.5">${u.time}</p>
                    </div>
                    <span class="material-symbols-outlined text-slate-600 text-[16px]">chevron_right</span>
                </div>`
                    ).join('') + `</div>`;
            }
        }

        function emptyState(icon, title, desc) {
            return `<div class="text-center py-12"><div class="text-4xl mb-3">${icon}</div><p class="font-bold text-slate-300">${title}</p><p class="text-slate-500 text-sm mt-1">${desc}</p></div>`;
        }

        renderTab('likes');
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(() => { });
        }
    </script>
    <script src="js/adsense.js"></script>
    <script src="js/share-social.js"></script>
    <script src="js/ui-components.js"></script>
    <script src="js/notif-badge.js"></script>
    <script src="/js/cookie-consent.js"></script>
    <script src="/js/monitoring.js"></script>
    <!-- Footer l√©gal requis RGPD -->
    <div style="text-align:center;padding:8px 16px 100px;font-size:10px;color:#334155">
        <a href="/legal.html" style="color:#334155;text-decoration:none;margin:0 6px">Mentions l√©gales</a>¬∑
        <a href="/privacy.html" style="color:#334155;text-decoration:none;margin:0 6px">Confidentialit√©</a>¬∑
        <a href="/cgv.html" style="color:#334155;text-decoration:none;margin:0 6px">CGU</a>¬∑
        <a href="/cookies.html" style="color:#334155;text-decoration:none;margin:0 6px">Cookies</a>
    </div>
    <script src="/pages/js/auth-state.js"></script>
    <script src="/js/offline-banner.js"></script>
</body>

</html>