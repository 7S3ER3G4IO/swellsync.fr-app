<!DOCTYPE html>
<html class="dark" lang="fr">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width,initial-scale=1.0,viewport-fit=cover" name="viewport" />
    <title>SwellSync - Session Live</title>
    <script src="js/theme.js"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
        <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="dns-prefetch" href="https://bxudysseskfpmlpagoid.supabase.co">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="css/transitions.css">
    <script>tailwind.config = { darkMode: "class", theme: { extend: { colors: { "primary": "#00bad6" }, fontFamily: { "display": ["Space Grotesk", "sans-serif"] } } } }</script>
    <style>
        body {
            background: #000;
            color: #fff;
            font-family: 'Space Grotesk', sans-serif;
            min-height: 100dvh
        }

        .card {
            background: #111;
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 16px
        }

        .timer {
            font-size: 64px;
            font-weight: 800;
            letter-spacing: -2px;
            font-variant-numeric: tabular-nums
        }

        .pulse-ring {
            animation: pulseRing 2s ease infinite
        }

        @keyframes pulseRing {
            0% {
                box-shadow: 0 0 0 0 rgba(0, 186, 214, 0.4)
            }

            70% {
                box-shadow: 0 0 0 15px rgba(0, 186, 214, 0)
            }

            100% {
                box-shadow: 0 0 0 0 rgba(0, 186, 214, 0)
            }
        }

        .stat-card {
            background: #111;
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 14px;
            padding: 14px;
            text-align: center
        }

        .wave-count {
            animation: waveIn 0.3s ease
        }

        @keyframes waveIn {
            from {
                transform: scale(1.3);
                opacity: 0
            }

            to {
                transform: scale(1);
                opacity: 1
            }
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="sticky top-0 z-30 px-4 py-3 backdrop-blur-xl"
        style="background:rgba(0,0,0,0.92);border-bottom:1px solid rgba(255,255,255,0.06)">
        <div class="flex items-center gap-3">
            <a href="home.html" class="tap"><span class="material-symbols-outlined text-white">close</span></a>
            <h1 class="text-lg font-bold flex-1">Session <span class="text-[#00bad6]">Live</span></h1>
            <div class="flex items-center gap-1.5">
                <span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
                <span class="text-xs text-red-400 font-bold" id="liveLabel">EN DIRECT</span>
            </div>
        </div>
    </header>

    <main class="px-4 py-4 space-y-4 max-w-lg mx-auto page-enter">

        <!-- Timer -->
        <div class="flex flex-col items-center py-6">
            <div class="w-40 h-40 rounded-full border-4 border-[#00bad6] flex items-center justify-center pulse-ring"
                id="timerRing">
                <div class="text-center">
                    <p class="timer" id="timer">00:00</p>
                    <p class="text-xs text-white/50 mt-1">Dur√©e de session</p>
                </div>
            </div>
        </div>

        <!-- Spot info -->
        <div class="card flex items-center gap-3">
            <span class="material-symbols-outlined text-[#00bad6]">location_on</span>
            <div class="flex-1">
                <p class="text-sm font-bold" id="spotName">D√©tection du spot...</p>
                <p class="text-[10px] text-white/40" id="coords">GPS en cours</p>
            </div>
            <div class="text-right">
                <p class="text-xs text-white/50">Conditions</p>
                <p class="text-sm font-bold text-[#00bad6]">‚≠ê‚≠ê‚≠ê‚≠ê</p>
            </div>
        </div>

        <!-- Live Stats -->
        <div class="grid grid-cols-3 gap-2">
            <div class="stat-card">
                <p class="text-2xl font-bold text-[#00bad6]" id="waveCount">0</p>
                <p class="text-[10px] text-white/50 mt-1">üåä Vagues</p>
            </div>
            <div class="stat-card">
                <p class="text-2xl font-bold" id="maxSpeed">0</p>
                <p class="text-[10px] text-white/50 mt-1">‚ö° km/h max</p>
            </div>
            <div class="stat-card">
                <p class="text-2xl font-bold" id="distance">0</p>
                <p class="text-[10px] text-white/50 mt-1">üìè m√®tres</p>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-2">
            <div class="stat-card">
                <p class="text-lg font-bold" id="waterTempDisplay">‚Äî</p>
                <p class="text-[10px] text-white/50 mt-1">üå°Ô∏è Eau</p>
            </div>
            <div class="stat-card">
                <p class="text-lg font-bold" id="waveDisplay">‚Äî</p>
                <p class="text-[10px] text-white/50 mt-1">üåä Houle</p>
            </div>
        </div>

        <!-- Wave log -->
        <div class="card">
            <div class="flex items-center justify-between mb-3">
                <h2 class="font-bold text-sm">Journal de vagues</h2>
                <button onclick="logWave()"
                    class="bg-[#00bad6] text-black font-bold text-xs px-4 py-2 rounded-xl tap flex items-center gap-1">
                    <span class="material-symbols-outlined text-sm">add</span>Vague !
                </button>
            </div>
            <div class="space-y-1.5 max-h-[200px] overflow-y-auto" id="waveLog">
                <p class="text-xs text-white/30 text-center py-4">Appuie sur "Vague !" pour chaque vague surf√©e üèÑ</p>
            </div>
        </div>

        <!-- Controls -->
        <div class="flex gap-3">
            <button onclick="toggleSession()" id="startBtn"
                class="flex-1 bg-[#00bad6] text-black font-black py-4 rounded-2xl text-sm tap flex items-center justify-center gap-2">
                <span class="material-symbols-outlined">play_arrow</span>D√©marrer la session
            </button>
            <button onclick="endSession()" id="endBtn"
                class="hidden flex-1 bg-red-500/20 text-red-400 border border-red-500/30 font-black py-4 rounded-2xl text-sm tap flex items-center justify-center gap-2">
                <span class="material-symbols-outlined">stop</span>Terminer
            </button>
        </div>

    </main>

    <!-- Bottom Nav -->
    <nav class="fixed bottom-0 left-0 right-0 border-t border-white/10 pb-6 pt-2 px-2 flex justify-between items-center z-50 backdrop-blur-lg"
        style="background:rgba(0,0,0,0.95)">
        <a class="flex flex-col items-center gap-1 text-white flex-1" href="home.html"><span
                class="material-symbols-outlined">home</span><span class="text-[10px]">Home</span></a>
        <a class="flex flex-col items-center gap-1 text-white flex-1" href="map.html"><span
                class="material-symbols-outlined">travel_explore</span><span class="text-[10px]">Spots</span></a>
        <a class="flex flex-col items-center gap-1 text-white flex-1" href="alerts.html"><span
                class="material-symbols-outlined">notifications</span><span class="text-[10px]">Alertes</span></a>
        <a class="flex flex-col items-center gap-1 text-white flex-1" href="community.html"><span
                class="material-symbols-outlined">groups</span><span class="text-[10px]">Communaut√©</span></a>
        <a class="flex flex-col items-center gap-1 text-white flex-1" href="profile.html"><span
                class="material-symbols-outlined">person</span><span class="text-[10px]">Profil</span></a>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="js/api.js"></script>
    <script>
        const SB_URL = 'https://bxudysseskfpmlpagoid.supabase.co';
        const SB_KEY = 'sb_publishable_8UPKYf9eOQjX9-5bBGl1CA_XRu8ZkiU';
        const SPOTS = [
            { id: 1, name: 'La Gravi√®re', lat: 43.664, lng: -1.448 },
            { id: 2, name: 'La Nord', lat: 43.670, lng: -1.450 },
            { id: 16, name: 'C√¥te des Basques', lat: 43.476, lng: -1.568 },
            { id: 17, name: 'Grande Plage Biarritz', lat: 43.483, lng: -1.558 },
            { id: 36, name: 'La Torche', lat: 47.842, lng: -4.348 },
            { id: 29, name: 'Lacanau Oc√©an', lat: 45.002, lng: -1.197 },
            { id: 58, name: 'Biscarrosse Plage', lat: 44.454, lng: -1.268 },
            { id: 15, name: 'Mimizan Plage', lat: 44.201, lng: -1.306 },
        ];

        let running = false, seconds = 0, interval = null, waves = 0;
        let detectedSpot = null, currentForecast = null;

        // Distance en km entre 2 points GPS
        function distKm(lat1, lng1, lat2, lng2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLng / 2) ** 2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        // Trouver le spot le plus proche
        function nearestSpot(lat, lng) {
            return SPOTS.reduce((best, s) => {
                const d = distKm(lat, lng, s.lat, s.lng);
                return d < best.dist ? { spot: s, dist: d } : best;
            }, { spot: SPOTS[0], dist: Infinity }).spot;
        }

        // Charger les donn√©es m√©t√©o du spot
        async function loadWeather(spotId) {
            try {
                const fc = await API.spots.forecast(spotId);
                currentForecast = fc;
                const now = new Date();
                const current = fc?.data?.find(h => new Date(h.time) >= now) || fc?.data?.[0];
                if (current) {
                    const wh = parseFloat(current.waveHeight)?.toFixed(1) || '‚Äî';
                    const wt = current.waterTemp != null ? Math.round(current.waterTemp) + '¬∞C' : '‚Äî';
                    document.getElementById('waveDisplay').textContent = wh !== 'NaN' ? wh + 'm' : '‚Äî';
                    document.getElementById('waterTempDisplay').textContent = wt;
                }
            } catch { }
        }

        // G√©olocalisation r√©elle
        function detectSpot() {
            if (!navigator.geolocation) {
                document.getElementById('spotName').textContent = 'GPS non disponible';
                return;
            }
            navigator.geolocation.getCurrentPosition(
                pos => {
                    const { latitude: lat, longitude: lng } = pos.coords;
                    document.getElementById('coords').textContent = lat.toFixed(4) + '¬∞ N, ' + Math.abs(lng).toFixed(4) + '¬∞ W';
                    detectedSpot = nearestSpot(lat, lng);
                    document.getElementById('spotName').textContent = detectedSpot.name;
                    loadWeather(detectedSpot.id);
                },
                () => {
                    document.getElementById('spotName').textContent = 'Localisation refus√©e';
                    document.getElementById('coords').textContent = 'Active le GPS pour d√©tecter ton spot';
                },
                { enableHighAccuracy: true, timeout: 8000 }
            );
        }

        function toggleSession() {
            if (!running) {
                running = true;
                document.getElementById('startBtn').innerHTML = '<span class="material-symbols-outlined">pause</span>Pause';
                document.getElementById('endBtn').classList.remove('hidden');
                document.getElementById('liveLabel').textContent = 'EN DIRECT';
                detectSpot(); // GPS r√©el
                interval = setInterval(() => {
                    seconds++;
                    const m = String(Math.floor(seconds / 60)).padStart(2, '0');
                    const s = String(seconds % 60).padStart(2, '0');
                    document.getElementById('timer').textContent = m + ':' + s;
                    document.getElementById('distance').textContent = Math.floor(seconds * 1.2);
                    if (seconds % 15 === 0) {
                        const spd = Math.floor(12 + Math.random() * 10);
                        const cur = parseInt(document.getElementById('maxSpeed').textContent);
                        if (spd > cur) document.getElementById('maxSpeed').textContent = spd;
                    }
                }, 1000);
            } else {
                running = false;
                clearInterval(interval);
                document.getElementById('startBtn').innerHTML = '<span class="material-symbols-outlined">play_arrow</span>Reprendre';
                document.getElementById('liveLabel').textContent = 'PAUSE';
            }
        }

        function logWave() {
            if (!running) return;
            waves++;
            const el = document.getElementById('waveCount');
            el.textContent = waves;
            el.classList.remove('wave-count');
            void el.offsetWidth;
            el.classList.add('wave-count');

            const log = document.getElementById('waveLog');
            if (waves === 1) log.innerHTML = '';
            const m = String(Math.floor(seconds / 60)).padStart(2, '0');
            const s = String(seconds % 60).padStart(2, '0');
            const rating = ['üî• Tube!', 'üí™ Bonne', 'ü§ô Nice', '‚ú® Clean'][Math.floor(Math.random() * 4)];
            const entry = document.createElement('div');
            entry.className = 'flex items-center justify-between py-1.5 border-b border-white/5';
            entry.innerHTML = `
            <div class="flex items-center gap-2">
                <span class="text-xs font-bold text-[#00bad6]">#${waves}</span>
                <span class="text-xs text-white/60">${m}:${s}</span>
            </div>
            <span class="text-xs font-bold">${rating}</span>`;
            log.prepend(entry);
            if (waves === 10) showCombo('üî• 10 VAGUES COMBO !');
            else if (waves === 25) showCombo('‚ö° 25 VAGUES ‚Äî MACHINE !');
            else if (waves === 50) showCombo('üèÜ 50 VAGUES ‚Äî L√âGENDE !');
        }

        function showCombo(text) {
            const toast = document.createElement('div');
            toast.style.cssText = 'position:fixed;top:80px;left:50%;transform:translateX(-50%);background:#00bad6;color:#000;font-weight:900;padding:12px 24px;border-radius:16px;z-index:999;font-size:14px';
            toast.textContent = text;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2500);
        }

        async function endSession() {
            running = false;
            clearInterval(interval);
            const duration = seconds;
            const spotName = document.getElementById('spotName').textContent;
            const waveH = parseFloat(document.getElementById('waveDisplay').textContent) || null;
            const windSpd = parseInt(document.getElementById('maxSpeed').textContent) || null;
            const score = Math.min(100, Math.round((waves * 3) + (duration / 60)));

            const sessionData = {
                spot_id: detectedSpot?.id || null,
                spot_name: spotName,
                duration,
                waves,
                wave_height: waveH,
                wind_speed: windSpd,
                score,
                started_at: new Date(Date.now() - duration * 1000).toISOString(),
                ended_at: new Date().toISOString()
            };

            // Sauvegarder en Supabase
            let saved = false;
            try {
                const user = await API.auth.me();
                if (user?.id) {
                    const res = await fetch(`${SB_URL}/rest/v1/surf_sessions`, {
                        method: 'POST',
                        headers: {
                            'apikey': SB_KEY,
                            'Authorization': 'Bearer ' + SB_KEY,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify({ ...sessionData, user_id: user.id })
                    });
                    saved = res.ok;
                }
            } catch { }

            // Fallback localStorage
            const local = JSON.parse(localStorage.getItem('sw_sessions') || '[]');
            local.push(sessionData);
            localStorage.setItem('sw_sessions', JSON.stringify(local));

            const msg = saved
                ? `‚úÖ Session sauvegard√©e ! ${waves} vagues en ${Math.floor(duration / 60)}min`
                : `üíæ Session locale ‚Äî connecte-toi pour la sync`;
            showCombo(msg);
            setTimeout(() => { window.location.href = 'home.html'; }, 2500);
        }
    </script>
    <script src="/js/cookie-consent.js"></script>
    <script src="/js/monitoring.js"></script>
    <!-- Footer l√©gal requis RGPD -->
    <div style="text-align:center;padding:8px 16px 100px;font-size:10px;color:#334155">
        <a href="/legal.html" style="color:#334155;text-decoration:none;margin:0 6px">Mentions l√©gales</a>¬∑
        <a href="/privacy.html" style="color:#334155;text-decoration:none;margin:0 6px">Confidentialit√©</a>¬∑
        <a href="/cgv.html" style="color:#334155;text-decoration:none;margin:0 6px">CGU</a>¬∑
        <a href="/cookies.html" style="color:#334155;text-decoration:none;margin:0 6px">Cookies</a>
    </div>
</body>

</html>