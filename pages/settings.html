<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>SwellSync ‚Äî Param√®tres</title>
    <meta name="description"
        content="SwellSync Param√®tres ‚Äî Personnalisez votre exp√©rience, notifications et pr√©f√©rences.">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200">
    <style>
        * {
            font-family: 'Inter', system-ui, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: #080f1a;
            color: #f1f5f9;
        }

        .card {
            background: #0f2438;
            border: 1px solid rgba(0, 186, 214, .12);
        }

        .section-label {
            font-size: 10px;
            font-weight: 900;
            letter-spacing: .1em;
            text-transform: uppercase;
            color: #64748b;
            padding: 14px 16px 6px;
        }

        .setting-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 13px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, .04);
            cursor: pointer;
            transition: background .15s;
            background: transparent;
        }

        .setting-row:hover {
            background: rgba(0, 186, 214, .03);
        }

        .icon-box {
            width: 32px;
            height: 32px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(40px)
            }

            to {
                opacity: 1;
                transform: translateX(0)
            }
        }

        .slide-in {
            animation: slideIn .25s ease both;
        }

        @keyframes fadeUp {
            from {
                opacity: 0;
                transform: translateY(6px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        .fade-up {
            animation: fadeUp .2s ease both;
        }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            border-radius: 12px;
            background: #1e3148;
            border: 1px solid rgba(0, 186, 214, .2);
            cursor: pointer;
            transition: background .3s ease, border-color .3s ease, box-shadow .3s ease;
            flex-shrink: 0;
        }

        .toggle-switch.on {
            background: #00bad6;
            border-color: #00bad6;
            box-shadow: 0 0 12px rgba(0, 186, 214, 0.3);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            transition: transform .35s cubic-bezier(.34, 1.56, .64, 1);
            box-shadow: 0 1px 3px rgba(0, 0, 0, .3);
        }

        .toggle-switch.on::after {
            transform: translateX(20px);
        }

        .search-box {
            background: #0f2438;
            border: 1px solid rgba(0, 186, 214, .2);
            border-radius: 14px;
            padding: 10px 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 8px 16px;
        }

        .search-box input {
            background: transparent;
            border: none;
            outline: none;
            color: #f1f5f9;
            font-size: 13px;
            flex: 1;
        }
    </style>
    <script src="js/theme.js"></script>

    <style>
        :root {
            --bg-primary: #080f1a;
            --bg-card: #0f2438;
            --bg-nav: rgba(8, 15, 26, 0.95);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: rgba(0, 186, 214, 0.2);
        }

        .light {
            --bg-primary: #f0f4f8;
            --bg-card: #ffffff;
            --bg-nav: rgba(255, 255, 255, 0.95);
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --border-color: rgba(0, 186, 214, 0.15);
        }

        .light body {
            background: var(--bg-primary) !important;
            color: var(--text-primary) !important;
        }

        .light .card,
        .light [class*="bg-[#0f2438]"] {
            background: var(--bg-card) !important;
        }

        .light [class*="bg-[#080f1a]"] {
            background: var(--bg-primary) !important;
        }

        .light [class*="bg-[#0b1929]"] {
            background: #f8fafc !important;
        }

        .light [class*="text-white"] {
            color: #0f172a !important;
        }

        .light [class*="text-slate-400"],
        .light [class*="text-slate-500"] {
            color: #64748b !important;
        }

        .light [class*="border-[#00bad6]"] {
            border-color: rgba(0, 186, 214, 0.25) !important;
        }

        .light nav[style*="--nav-bg"] {
            --nav-bg: rgba(255, 255, 255, 0.95) !important;
            border-color: rgba(0, 186, 214, 0.15) !important;
        }

        .light .section-label {
            color: #334155 !important;
        }

        .light .setting-row:hover {
            background: #e2e8f0 !important;
        }
    </style>

    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#00bad6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="/assets/images/swellsync_logo.png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="js/api.js"></script>
</head>

<body class="min-h-screen pb-10">

    <!-- Header -->
    <header
        class="sticky top-0 z-50 backdrop-blur-xl bg-[#080f1a]/95 border-b border-[#00bad6]/15 px-4 py-3 flex items-center gap-3">
        <a href="javascript:history.back()"
            class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-slate-400">
            <span class="material-symbols-outlined text-[18px]">arrow_back</span>
        </a>
        <h1 class="font-black text-base flex-1">Param√®tres</h1>
        <div
            class="w-8 h-8 rounded-full bg-[#00bad6]/15 flex items-center justify-center active:scale-95 transition-transform">
            <span class="material-symbols-outlined text-[#00bad6] text-[18px]">settings</span>
        </div>
    </header>

    <!-- Search settings -->
    <div class="search-box">
        <span class="material-symbols-outlined text-slate-500 text-[18px]">search</span>
        <input type="search" placeholder="Rechercher dans les param√®tres‚Ä¶" oninput="filterSettings(this.value)" />
    </div>

    <!-- Profile info -->
    <div class="flex items-center gap-3 px-4 py-3 card mx-4 mb-2 rounded-2xl">
        <div
            class="w-14 h-14 rounded-full bg-[#00bad6]/20 flex items-center justify-center font-black text-[#00bad6] text-2xl border-2 border-[#00bad6]/30 active:scale-95 transition-transform">
            S</div>
        <div class="flex-1">
            <p class="font-black text-base" id="settingsName">Mon Profil</p>
            <p class="text-[11px] text-slate-400">Voir mon profil SwellSync</p>
        </div>
        <a href="profile.html" class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-slate-400">
            <span class="material-symbols-outlined text-[18px]">chevron_right</span>
        </a>
    </div>

    <div id="settingsList">
        <!-- COMPTE -->
        <div data-section="compte">
            <div class="section-label">üë§ Compte</div>
            <div class="card mx-4 rounded-2xl overflow-hidden">
                <div class="setting-row" onclick="go('edit-profile.html')">
                    <div class="icon-box" style="background:rgba(0,186,214,.15)"><span
                            class="material-symbols-outlined text-[#00bad6] text-[18px]">person</span></div>
                    <div class="flex-1">
                        <p class="font-semibold text-sm">Modifier le profil</p>
                        <p class="text-[10px] text-slate-500">Nom, bio, photo de profil</p>
                    </div>
                    <span class="material-symbols-outlined text-slate-600 text-[18px]">chevron_right</span>
                </div>
                <div class="setting-row" onclick="go('badges.html')">
                    <div class="icon-box" style="background:rgba(168,85,247,.15)"><span
                            class="material-symbols-outlined text-purple-400 text-[18px]">badge</span></div>
                    <div class="flex-1">
                        <p class="font-semibold text-sm">Badges & Cosm√©tiques</p>
                        <p class="text-[10px] text-slate-500">Acheter des badges de r√©gion, styles</p>
                    </div>
                    <span class="material-symbols-outlined text-slate-600 text-[18px]">chevron_right</span>
                </div>
                <div class="setting-row" onclick="go('abonnement.html')">
                    <div class="icon-box" style="background:rgba(245,158,11,.15)"><span
                            class="material-symbols-outlined text-amber-400 text-[18px]">star</span></div>
                    <div class="flex-1">
                        <p class="font-semibold text-sm">SwellSync Pro</p>
                        <p class="text-[10px] text-slate-500">G√©rer votre abonnement</p>
                    </div>
                    <span class="text-[10px] text-amber-400 font-bold mr-1">Voir ‚Üí</span>
                </div>
                <div class="setting-row" onclick="checkProThenGo('alerts.html')">
                    <div class="icon-box" style="background:rgba(0,186,214,.1)"><span
                            class="material-symbols-outlined text-[#00bad6] text-[18px]">notifications</span></div>
                    <div class="flex-1">
                        <p class="font-semibold text-sm">Mes Alertes de Houle</p>
                        <p class="text-[10px] text-slate-500">G√©rer les alertes vagues</p>
                    </div>
                    <span class="material-symbols-outlined text-slate-600 text-[18px]">chevron_right</span>
                </div>
            </div>
        </div>

        <!-- CONFIDENTIALIT√â -->
        <div data-section="confidentialite">
            <div class="section-label">üîí Confidentialit√© & S√©curit√©</div>
            <div class="card mx-4 rounded-2xl overflow-hidden">
                <div class="setting-row" onclick="togglePrivacy(this)">
                    <div class="icon-box" style="background:rgba(16,185,129,.15)"><span
                            class="material-symbols-outlined text-emerald-400 text-[18px]">lock</span></div>
                    <div class="flex-1">
                        <p class="font-semibold text-sm">Compte priv√©</p>
                        <p class="text-[10px] text-slate-500">Seuls tes abonn√©s voient tes posts</p>
                    </div>
                    <div class="toggle-switch" id="toggle-private"></div>
                </div>
                <div class="setting-row" onclick="toggleActivity(this)">
                    <div class="icon-box" style="background:rgba(16,185,129,.1)"><span
                            class="material-symbols-outlined text-emerald-400 text-[18px]">visibility</span></div>
                    <div class="flex-1">
                        <p class="font-semibold text-sm">Afficher mon activit√©</p>
                        <p class="text-[10px] text-slate-500">Visible dans le feed communaut√©</p>
                    </div>
                    <div class="toggle-switch on" id="toggle-activity"></div>
                </div>
                <div class="setting-row" onclick="openBlockedAccounts()">
                    <div class="icon-box" style="background:rgba(244,63,94,.1)"><span
                            class="material-symbols-outlined text-red-400 text-[18px]">block</span></div>
                    <div class="flex-1">
                        <p class="font-semibold text-sm">Comptes bloqu√©s</p>
                        <p class="text-[10px] text-slate-500">G√©rer les comptes bloqu√©s</p>
                    </div>
                    <span class="material-symbols-outlined text-slate-600 text-[18px]">chevron_right</span>
                </div>
                <div class="setting-row" onclick="open2FAModal()">
                    <div class="icon-box" style="background:rgba(245,158,11,.1)"><span
                            class="material-symbols-outlined text-amber-400 text-[18px]">security</span></div>
                    <div class="flex-1">
                        <p class="font-semibold text-sm">Authentification √† 2 facteurs</p>
                        <p class="text-[10px] text-slate-500">Renforcer la s√©curit√© du compte</p>
                    </div>
                    <span id="2faStatus" class="text-[10px] font-bold text-slate-500 mr-1">V√©rification...</span>
                    <span class="material-symbols-outlined text-slate-600 text-[18px]">chevron_right</span>
                </div>
                <div class="setting-row" onclick="openChangePassword()">
                    <div class="icon-box" style="background:rgba(0,186,214,.1)"><span
                            class="material-symbols-outlined text-[#00bad6] text-[18px]">key</span></div>
                    <div class="flex-1">
                        <p class="font-semibold text-sm">Changer le mot de passe</p>
                        <p class="text-[10px] text-slate-500">Modifier vos identifiants</p>
                    </div>
                    <span class="material-symbols-outlined text-slate-600 text-[18px]">chevron_right</span>
                </div>
            </div>
        </div>

        <!-- NOTIFICATIONS -->
        <div data-section="notifications">
            <div class="section-label">üîî Notifications</div>
            <div class="card mx-4 rounded-2xl overflow-hidden">
                <div class="setting-row" onclick="toggleRow(this,'Nouveaux abonn√©s')">
                    <div class="icon-box" style="background:rgba(0,186,214,.15)"><span
                            class="material-symbols-outlined text-[#00bad6] text-[18px]">person_add</span></div>
                    <div class="flex-1">
                        <p class="font-semibold text-sm">Nouvel abonn√©</p>
                        <p class="text-[10px] text-slate-500">Quand quelqu'un te suit</p>
                    </div>
                    <div class="toggle-switch on" id="toggle-followers-notif"></div>
                </div>
                <div class="setting-row" onclick="toggleRow(this,'Likes')">
                    <div class="icon-box" style="background:rgba(244,63,94,.15)"><span
                            class="material-symbols-outlined text-red-400 text-[18px]">favorite</span></div>
                    <div class="flex-1">
                        <p class="font-semibold text-sm">Likes sur tes posts</p>
                        <p class="text-[10px] text-slate-500">Notifs quand tu obtiens un ‚ù§Ô∏è</p>
                    </div>
                    <div class="toggle-switch on" id="toggle-likes-notif"></div>
                </div>
                <div class="setting-row" onclick="toggleRow(this,'Commentaires')">
                    <div class="icon-box" style="background:rgba(168,85,247,.15)"><span
                            class="material-symbols-outlined text-purple-400 text-[18px]">chat_bubble</span></div>
                    <div class="flex-1">
                        <p class="font-semibold text-sm">Commentaires & R√©ponses</p>
                        <p class="text-[10px] text-slate-500">Notifs quand on te r√©pond</p>
                    </div>
                    <div class="toggle-switch on" id="toggle-comments-notif"></div>
                </div>
                <div class="setting-row" onclick="toggleRow(this,'Alertes vagues')">
                    <div class="icon-box" style="background:rgba(16,185,129,.15)"><span
                            class="material-symbols-outlined text-emerald-400 text-[18px]">water</span></div>
                    <div class="flex-1">
                        <p class="font-semibold text-sm">Alertes de Houle Pro</p>
                        <p class="text-[10px] text-slate-500">Conditions parfaites sur tes spots</p>
                    </div>
                    <div class="toggle-switch on" id="toggle-waves-notif"></div>
                </div>
                <div class="setting-row" onclick="toggleRow(this,'Push marketing')">
                    <div class="icon-box" style="background:rgba(245,158,11,.1)"><span
                            class="material-symbols-outlined text-amber-400 text-[18px]">campaign</span></div>
                    <div class="flex-1">
                        <p class="font-semibold text-sm">Notifications SwellSync</p>
                        <p class="text-[10px] text-slate-500">Actualit√©s, offres, nouveaut√©s</p>
                    </div>
                    <div class="toggle-switch" id="toggle-push-notif"></div>
                </div>
            </div>
        </div>

        <!-- ACTIVIT√â & ARCHIVES -->
        <div data-section="activite archives">
            <div class="section-label">üìÅ Activit√© & Archives</div>
            <div class="card mx-4 rounded-2xl overflow-hidden">
                <div class="setting-row" onclick="openArchivesProGate()">
                    <div class="icon-box" style="background:rgba(0,186,214,.1)"><span
                            class="material-symbols-outlined text-[#00bad6] text-[18px]">archive</span></div>
                    <div class="flex-1">
                        <p class="font-semibold text-sm">Archive des Posts</p>
                        <p class="text-[10px] text-slate-500">Posts archiv√©s, stories sauvegard√©es</p>
                    </div>
                    <span class="material-symbols-outlined text-slate-600 text-[18px]">chevron_right</span>
                </div>
                <div class="setting-row"
                    onclick="openProGateOrPage('','Tes enregistrements de posts et de sessions sont accessibles uniquement avec SwellSync Pro ‚≠ê')">
                    <div class="icon-box" style="background:rgba(245,158,11,.1)"><span
                            class="material-symbols-outlined text-amber-400 text-[18px]">bookmark</span></div>
                    <div class="flex-1">
                        <p class="font-semibold text-sm">Enregistrements</p>
                        <p class="text-[10px] text-slate-500">Posts et sessions sauvegard√©s</p>
                    </div>
                    <span class="material-symbols-outlined text-slate-600 text-[18px]">chevron_right</span>
                </div>
                <div class="setting-row" onclick="go('history.html')">
                    <div class="icon-box" style="background:rgba(168,85,247,.1)"><span
                            class="material-symbols-outlined text-purple-400 text-[18px]">history</span></div>
                    <div class="flex-1">
                        <p class="font-semibold text-sm">Historique d'activit√©</p>
                        <p class="text-[10px] text-slate-500">Likes, commentaires, vus r√©cents</p>
                    </div>
                    <span class="material-symbols-outlined text-slate-600 text-[18px]">chevron_right</span>
                </div>
                <div class="setting-row" onclick="requestDataExport()">
                    <div class="icon-box" style="background:rgba(16,185,129,.1)"><span
                            class="material-symbols-outlined text-emerald-400 text-[18px]">download</span></div>
                    <div class="flex-1">
                        <p class="font-semibold text-sm">T√©l√©charger mes donn√©es</p>
                        <p class="text-[10px] text-slate-500">Exporter l'historique de votre compte</p>
                    </div>
                    <span class="material-symbols-outlined text-slate-600 text-[18px]">chevron_right</span>
                </div>
            </div>
        </div>

        <!-- ACC√àS & AUTORISATIONS -->
        <div data-section="acces autorisations localisation">
            <div class="section-label">üìç Acc√®s & Autorisations</div>
            <div class="card mx-4 rounded-2xl overflow-hidden">
                <div class="setting-row" onclick="requestLocation(this)">
                    <div class="icon-box" style="background:rgba(0,186,214,.15)"><span
                            class="material-symbols-outlined text-[#00bad6] text-[18px]">location_on</span></div>
                    <div class="flex-1">
                        <p class="font-semibold text-sm">Localisation</p>
                        <p class="text-[10px] text-slate-500">D√©tection auto du spot le plus proche</p>
                    </div>
                    <div class="toggle-switch on" id="toggle-location"></div>
                </div>
                <div class="setting-row" onclick="toggleRow(this,'Cam√©ra')">
                    <div class="icon-box" style="background:rgba(168,85,247,.1)"><span
                            class="material-symbols-outlined text-purple-400 text-[18px]">camera_alt</span></div>
                    <div class="flex-1">
                        <p class="font-semibold text-sm">Cam√©ra</p>
                        <p class="text-[10px] text-slate-500">Pour les photos de profil et posts</p>
                    </div>
                    <div class="toggle-switch on" id="toggle-camera"></div>
                </div>
                <div class="setting-row" onclick="requestPushNotif(this)">
                    <div class="icon-box" style="background:rgba(245,158,11,.1)"><span
                            class="material-symbols-outlined text-amber-400 text-[18px]">notifications_active</span>
                    </div>
                    <div class="flex-1">
                        <p class="font-semibold text-sm">Notifications Push</p>
                        <p class="text-[10px] text-slate-500">Alertes en temps r√©el</p>
                    </div>
                    <div class="toggle-switch on" id="toggle-push-access"></div>
                </div>
            </div>
        </div>

        <!-- PR√âF√âRENCES -->
        <div data-section="preferences langue theme">
            <div class="section-label">üé® Pr√©f√©rences</div>
            <div class="card mx-4 rounded-2xl overflow-hidden">
                <div class="setting-row" onclick="openLangSheet()">
                    <div class="icon-box" style="background:rgba(0,186,214,.1)"><span
                            class="material-symbols-outlined text-[#00bad6] text-[18px]">language</span></div>
                    <div class="flex-1">
                        <p class="font-semibold text-sm">Langue</p>
                        <p class="text-[10px] text-slate-500">Fran√ßais</p>
                    </div>
                    <span class="material-symbols-outlined text-slate-600 text-[18px]">chevron_right</span>
                </div>
                <div class="setting-row" onclick="toggleRow(this,'Mode sombre')">
                    <div class="icon-box" style="background:rgba(100,116,139,.2)"><span
                            class="material-symbols-outlined text-slate-400 text-[18px]">dark_mode</span></div>
                    <div class="flex-1">
                        <p class="font-semibold text-sm">Mode sombre</p>
                        <p class="text-[10px] text-slate-500" id="darkmodeLabel">Interface sombre (activ√©)</p>
                    </div>
                    <div class="toggle-switch on" id="toggle-darkmode"></div>
                </div>
                <div class="setting-row" onclick="openTextSizeSheet()">
                    <div class="icon-box" style="background:rgba(245,158,11,.1)"><span
                            class="material-symbols-outlined text-amber-400 text-[18px]">format_size</span></div>
                    <div class="flex-1">
                        <p class="font-semibold text-sm">Taille du texte</p>
                        <p class="text-[10px] text-slate-500">Normal</p>
                    </div>
                    <span class="material-symbols-outlined text-slate-600 text-[18px]">chevron_right</span>
                </div>
                <div class="setting-row" onclick="openAccessibilitySheet()">
                    <div class="icon-box" style="background:rgba(16,185,129,.1)"><span
                            class="material-symbols-outlined text-emerald-400 text-[18px]">accessibility</span></div>
                    <div class="flex-1">
                        <p class="font-semibold text-sm">Accessibilit√©</p>
                        <p class="text-[10px] text-slate-500">Contraste, animations, lecteur d'√©cran</p>
                    </div>
                    <span class="material-symbols-outlined text-slate-600 text-[18px]">chevron_right</span>
                </div>
            </div>
        </div>

        <!-- SPOTS & SURF -->
        <div data-section="spots surf region preferences">
            <div class="section-label">üåä Spots & Surf</div>
            <div class="card mx-4 rounded-2xl overflow-hidden">
                <div class="setting-row" onclick="go('map.html')">
                    <div class="icon-box" style="background:rgba(0,186,214,.15)"><span
                            class="material-symbols-outlined text-[#00bad6] text-[18px]">travel_explore</span></div>
                    <div class="flex-1">
                        <p class="font-semibold text-sm">Mes Spots Favoris</p>
                        <p class="text-[10px] text-slate-500">G√©rer les spots sauvegard√©s</p>
                    </div>
                    <span class="material-symbols-outlined text-slate-600 text-[18px]">chevron_right</span>
                </div>
                <div class="setting-row" onclick="openDefaultSpotSheet()">
                    <div class="icon-box" style="background:rgba(16,185,129,.15)"><span
                            class="material-symbols-outlined text-emerald-400 text-[18px]">place</span></div>
                    <div class="flex-1">
                        <p class="font-semibold text-sm">Spot par d√©faut</p>
                        <p class="text-[10px] text-slate-500">Hossegor ‚Äî La Gravi√®re</p>
                    </div>
                    <span class="material-symbols-outlined text-slate-600 text-[18px]">chevron_right</span>
                </div>
                <div class="setting-row" onclick="openUnitsSheet()">
                    <div class="icon-box" style="background:rgba(245,158,11,.1)"><span
                            class="material-symbols-outlined text-amber-400 text-[18px]">waves</span></div>
                    <div class="flex-1">
                        <p class="font-semibold text-sm">Unit√©s de mesure</p>
                        <p class="text-[10px] text-slate-500">M√®tres / Pieds, km/h / N≈ìuds</p>
                    </div>
                    <span class="material-symbols-outlined text-slate-600 text-[18px]">chevron_right</span>
                </div>
                <div class="setting-row" onclick="openLevelSheet()">
                    <div class="icon-box" style="background:rgba(168,85,247,.1)"><span
                            class="material-symbols-outlined text-purple-400 text-[18px]">surfing</span></div>
                    <div class="flex-1">
                        <p class="font-semibold text-sm">Niveau de surf</p>
                        <p class="text-[10px] text-slate-500">Interm√©diaire</p>
                    </div>
                    <span class="material-symbols-outlined text-slate-600 text-[18px]">chevron_right</span>
                </div>
            </div>
        </div>

        <!-- ABONNEMENTS & SUIVIS -->
        <div data-section="abonnements suivi followers following">
            <div class="section-label">üë• Abonnements & Communaut√©</div>
            <div class="card mx-4 rounded-2xl overflow-hidden">
                <div class="setting-row" onclick="go('following.html')">
                    <div class="icon-box" style="background:rgba(0,186,214,.1)"><span
                            class="material-symbols-outlined text-[#00bad6] text-[18px]">group</span></div>
                    <div class="flex-1">
                        <p class="font-semibold text-sm">Mes abonnements</p>
                        <p class="text-[10px] text-slate-500" id="followingCount">0 surfeurs suivis</p>
                    </div>
                    <span class="material-symbols-outlined text-slate-600 text-[18px]">chevron_right</span>
                </div>
                <div class="setting-row" onclick="go('community.html')">
                    <div class="icon-box" style="background:rgba(168,85,247,.1)"><span
                            class="material-symbols-outlined text-purple-400 text-[18px]">groups</span></div>
                    <div class="flex-1">
                        <p class="font-semibold text-sm">Feed Communaut√©</p>
                        <p class="text-[10px] text-slate-500">Voir les posts des surfeurs suivis</p>
                    </div>
                    <span class="material-symbols-outlined text-slate-600 text-[18px]">chevron_right</span>
                </div>
                <div class="setting-row" onclick="toggleRow(this,'Partage abonnements')">
                    <div class="icon-box" style="background:rgba(16,185,129,.1)"><span
                            class="material-symbols-outlined text-emerald-400 text-[18px]">share</span></div>
                    <div class="flex-1">
                        <p class="font-semibold text-sm">Partager mon profil</p>
                        <p class="text-[10px] text-slate-500">Afficher dans les r√©sultats de recherche</p>
                    </div>
                    <div class="toggle-switch on" id="toggle-share-profile"></div>
                </div>
            </div>
        </div>

        <!-- AIDE & SUPPORT -->
        <div data-section="aide support contact">
            <div class="section-label">üí¨ Aide & Support</div>
            <div class="card mx-4 rounded-2xl overflow-hidden">
                <div class="setting-row" onclick="go('support.html')">
                    <div class="icon-box" style="background:rgba(0,186,214,.1)"><span
                            class="material-symbols-outlined text-[#00bad6] text-[18px]">help</span></div>
                    <div class="flex-1">
                        <p class="font-semibold text-sm">Centre d'aide</p>
                        <p class="text-[10px] text-slate-500">FAQ, guides, tutoriels</p>
                    </div>
                    <span class="material-symbols-outlined text-slate-600 text-[18px]">chevron_right</span>
                </div>
                <div class="setting-row" onclick="go('support.html')">
                    <div class="icon-box" style="background:rgba(245,158,11,.1)"><span
                            class="material-symbols-outlined text-amber-400 text-[18px]">bug_report</span></div>
                    <div class="flex-1">
                        <p class="font-semibold text-sm">Signaler un probl√®me</p>
                        <p class="text-[10px] text-slate-500">Bug, contenu inappropri√©</p>
                    </div>
                    <span class="material-symbols-outlined text-slate-600 text-[18px]">chevron_right</span>
                </div>
                <div class="setting-row" onclick="rateApp()">
                    <div class="icon-box" style="background:rgba(16,185,129,.1)"><span
                            class="material-symbols-outlined text-emerald-400 text-[18px]">rate_review</span></div>
                    <div class="flex-1">
                        <p class="font-semibold text-sm">√âvaluer l'application</p>
                        <p class="text-[10px] text-slate-500">Laisser un avis sur l'App Store</p>
                    </div>
                    <span class="material-symbols-outlined text-slate-600 text-[18px]">chevron_right</span>
                </div>
            </div>
        </div>

        <!-- √Ä PROPOS -->
        <div data-section="a propos version">
            <div class="section-label">‚ÑπÔ∏è √Ä propos</div>
            <div class="card mx-4 rounded-2xl overflow-hidden">
                <div class="setting-row" onclick="showAbout()">
                    <div class="icon-box" style="background:rgba(0,186,214,.1)"><span
                            class="material-symbols-outlined text-[#00bad6] text-[18px]">info</span></div>
                    <div class="flex-1">
                        <p class="font-semibold text-sm">√Ä propos de SwellSync</p>
                        <p class="text-[10px] text-slate-500">Version 2.1.0</p>
                    </div>
                    <span class="material-symbols-outlined text-slate-600 text-[18px]">chevron_right</span>
                </div>
                <div class="setting-row" onclick="window.open('../cgv.html','_self')">
                    <div class="icon-box" style="background:rgba(100,116,139,.2)"><span
                            class="material-symbols-outlined text-slate-400 text-[18px]">policy</span></div>
                    <div class="flex-1">
                        <p class="font-semibold text-sm">Conditions d'utilisation</p>
                    </div>
                    <span class="material-symbols-outlined text-slate-600 text-[18px]">chevron_right</span>
                </div>
                <div class="setting-row" onclick="window.open('../privacy.html','_self')">
                    <div class="icon-box" style="background:rgba(100,116,139,.2)"><span
                            class="material-symbols-outlined text-slate-400 text-[18px]">privacy_tip</span></div>
                    <div class="flex-1">
                        <p class="font-semibold text-sm">Politique de confidentialit√©</p>
                    </div>
                    <span class="material-symbols-outlined text-slate-600 text-[18px]">chevron_right</span>
                </div>
                <div class="setting-row" onclick="window.open('../legal.html','_self')">
                    <div class="icon-box" style="background:rgba(100,116,139,.2)"><span
                            class="material-symbols-outlined text-slate-400 text-[18px]">gavel</span></div>
                    <div class="flex-1">
                        <p class="font-semibold text-sm">Mentions l√©gales</p>
                    </div>
                    <span class="material-symbols-outlined text-slate-600 text-[18px]">chevron_right</span>
                </div>
            </div>
        </div>

        <!-- D√âCONNEXION -->
        <div data-section="deconnexion">
            <div class="section-label"></div>
            <div class="card mx-4 rounded-2xl overflow-hidden">
                <div class="setting-row" onclick="showLogout()">
                    <div class="icon-box" style="background:rgba(244,63,94,.15)"><span
                            class="material-symbols-outlined text-red-400 text-[18px]">logout</span></div>
                    <div class="flex-1">
                        <p class="font-semibold text-sm text-red-400">Se d√©connecter</p>
                    </div>
                </div>
                <div class="setting-row" onclick="confirmDeleteAccount()">
                    <div class="icon-box" style="background:rgba(244,63,94,.1)"><span
                            class="material-symbols-outlined text-red-600 text-[18px]">delete_forever</span></div>
                    <div class="flex-1">
                        <p class="font-semibold text-sm text-red-600">Supprimer le compte</p>
                        <p class="text-[10px] text-slate-500">Action irr√©versible</p>
                    </div>
                </div>
            </div>
        </div>

        <p class="text-center text-[10px] text-slate-700 py-6">SwellSync v2.1.0 ¬∑ Fait avec ‚ù§Ô∏è pour les surfeurs</p>
    </div><!-- /settingsList -->

    <!-- Archive sheet -->
    <div id="infoSheet" class="fixed inset-0 z-[200] hidden items-end justify-center bg-black/60 backdrop-blur-sm">
        <div class="w-full max-w-lg bg-[#0b1929] rounded-t-3xl border-t border-[#00bad6]/20 p-5">
            <div class="flex items-center justify-between mb-4">
                <h3 id="infoSheetTitle" class="font-black text-base"></h3>
                <button onclick="closeSheet('infoSheet')" class="text-slate-400"><span
                        class="material-symbols-outlined">close</span></button>
            </div>
            <p id="infoSheetBody" class="text-slate-400 text-sm leading-relaxed py-2 whitespace-pre-line"></p>
            <button onclick="closeSheet('infoSheet')"
                class="w-full mt-4 py-3 rounded-2xl bg-[#00bad6]/15 text-[#00bad6] font-bold text-sm active:scale-95 transition-transform">OK</button>
        </div>
    </div>

    <!-- Archive sheet -->
    <div id="archiveSheet" class="fixed inset-0 z-[200] hidden items-end justify-center bg-black/60 backdrop-blur-sm">
        <div class="w-full max-w-lg bg-[#0b1929] rounded-t-3xl border-t border-[#00bad6]/20 p-5">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-black text-base">üìÅ Archive</h3>
                <button onclick="closeSheet('archiveSheet')" class="text-slate-400"><span
                        class="material-symbols-outlined">close</span></button>
            </div>
            <p class="text-slate-400 text-sm text-center py-8">Tes posts archiv√©s appara√Ætront ici.<br />Fonctionnalit√©
                disponible avec SwellSync Pro ‚≠ê</p>
            <a href="abonnement.html"
                class="flex items-center justify-center gap-2 w-full py-3 rounded-2xl font-black text-sm text-black"
                style="background:linear-gradient(135deg,#f59e0b,#d97706)">
                ‚≠ê Passer Pro
            </a>
        </div>
    </div>


    <!-- Password Change Sheet -->
    <div id="pwdSheet" class="fixed inset-0 z-[300] hidden items-end justify-center bg-black/70 backdrop-blur-sm">
        <div class="w-full max-w-lg bg-[#0b1929] rounded-t-3xl border-t border-[#00bad6]/20 p-5">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-black text-base">üîë Changer le mot de passe</h3>
                <button onclick="closeSheet('pwdSheet')" class="text-slate-400"><span
                        class="material-symbols-outlined">close</span></button>
            </div>
            <form id="pwdForm" onsubmit="event.preventDefault();submitChangePassword()" class="space-y-3">
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Mot de passe
                        actuel</label>
                    <input id="pwdCurrent" type="password" placeholder="Ton mot de passe actuel"
                        class="w-full bg-[#080f1a] border border-[#00bad6]/20 rounded-xl p-3 text-sm text-slate-200 outline-none mt-1 focus:border-[#00bad6]"
                        required />
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Nouveau mot de
                        passe</label>
                    <input id="pwdNew" type="password" placeholder="8 caract√®res minimum"
                        class="w-full bg-[#080f1a] border border-[#00bad6]/20 rounded-xl p-3 text-sm text-slate-200 outline-none mt-1 focus:border-[#00bad6]"
                        required minlength="8" />
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Confirmer le nouveau
                        MDP</label>
                    <input id="pwdConfirm" type="password" placeholder="R√©p√®te le nouveau mot de passe"
                        class="w-full bg-[#080f1a] border border-[#00bad6]/20 rounded-xl p-3 text-sm text-slate-200 outline-none mt-1 focus:border-[#00bad6]"
                        required />
                </div>
                <p id="pwdError" class="text-red-400 text-xs min-h-[16px]"></p>
                <button id="pwdSubmitBtn" type="submit"
                    class="w-full py-3 rounded-2xl bg-[#00bad6] font-black text-sm text-[#080f1a] active:scale-95 transition-transform">‚úÖ
                    Confirmer</button>
            </form>
        </div>
    </div>

    <!-- Blocked Accounts Sheet -->
    <div id="blockedSheet" class="fixed inset-0 z-[300] hidden items-end justify-center bg-black/70 backdrop-blur-sm">
        <div class="w-full max-w-lg bg-[#0b1929] rounded-t-3xl border-t border-red-500/20 p-5">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-black text-base">üö´ Comptes bloqu√©s</h3>
                <button onclick="closeSheet('blockedSheet')" class="text-slate-400"><span
                        class="material-symbols-outlined">close</span></button>
            </div>
            <div id="blockedList" class="max-h-64 overflow-y-auto rounded-xl bg-[#080f1a]"></div>
            <p class="text-[10px] text-slate-600 text-center mt-3">Pour bloquer un utilisateur, allez sur son profil
                dans la Communaut√©.</p>
        </div>
    </div>

    <!-- Language Sheet -->
    <div id="langSheet" class="fixed inset-0 z-[300] hidden items-end justify-center bg-black/70 backdrop-blur-sm">
        <div class="w-full max-w-lg bg-[#0b1929] rounded-t-3xl border-t border-[#00bad6]/20 p-5">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-black text-base">üåê Langue / Language</h3>
                <button onclick="closeSheet('langSheet')" class="text-slate-400"><span
                        class="material-symbols-outlined">close</span></button>
            </div>
            <div class="space-y-2 mb-4">
                <label class="flex items-center gap-3 p-3 rounded-xl bg-[#0f2438] cursor-pointer">
                    <input type="radio" id="langFR" name="lang" value="fr" class="accent-[#00bad6]" checked />
                    <span class="font-bold text-sm">üá´üá∑ Fran√ßais</span>
                </label>
                <label class="flex items-center gap-3 p-3 rounded-xl bg-[#0f2438] cursor-pointer">
                    <input type="radio" id="langEN" name="lang" value="en" class="accent-[#00bad6]" />
                    <span class="font-bold text-sm">üá¨üáß English</span>
                </label>
            </div>
            <button onclick="applyLanguage()"
                class="w-full py-3 rounded-2xl bg-[#00bad6] font-black text-sm text-[#080f1a] active:scale-95 transition-transform">Appliquer</button>
        </div>
    </div>

    <!-- Units Sheet -->
    <div id="unitsSheet" class="fixed inset-0 z-[300] hidden items-end justify-center bg-black/70 backdrop-blur-sm">
        <div class="w-full max-w-lg bg-[#0b1929] rounded-t-3xl border-t border-[#00bad6]/20 p-5">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-black text-base">üìè Unit√©s de mesure</h3>
                <button onclick="closeSheet('unitsSheet')" class="text-slate-400"><span
                        class="material-symbols-outlined">close</span></button>
            </div>
            <p class="text-[10px] font-bold text-slate-500 uppercase tracking-wide mb-2">Hauteur des vagues</p>
            <div class="flex gap-2 mb-4">
                <label
                    class="flex-1 text-center p-3 rounded-xl bg-[#0f2438] cursor-pointer border border-transparent has-[:checked]:border-[#00bad6]">
                    <input type="radio" id="unitWaveM" name="unitWave" value="m" checked class="sr-only" />üåä M√®tres (m)
                </label>
                <label
                    class="flex-1 text-center p-3 rounded-xl bg-[#0f2438] cursor-pointer border border-transparent has-[:checked]:border-[#00bad6]">
                    <input type="radio" id="unitWaveFt" name="unitWave" value="ft" class="sr-only" />üìê Pieds (ft)
                </label>
            </div>
            <p class="text-[10px] font-bold text-slate-500 uppercase tracking-wide mb-2">Vitesse du vent</p>
            <div class="flex gap-2 mb-4">
                <label
                    class="flex-1 text-center p-3 rounded-xl bg-[#0f2438] cursor-pointer border border-transparent has-[:checked]:border-[#00bad6]">
                    <input type="radio" id="unitWindKmh" name="unitWind" value="kmh" checked class="sr-only" />üí® km/h
                </label>
                <label
                    class="flex-1 text-center p-3 rounded-xl bg-[#0f2438] cursor-pointer border border-transparent has-[:checked]:border-[#00bad6]">
                    <input type="radio" id="unitWindKts" name="unitWind" value="kts" class="sr-only" />‚öì N≈ìuds (kts)
                </label>
            </div>
            <button onclick="applyUnits()"
                class="w-full py-3 rounded-2xl bg-[#00bad6] font-black text-sm text-[#080f1a] active:scale-95 transition-transform">‚úÖ
                Appliquer</button>
        </div>
    </div>

    <!-- Level Sheet -->
    <div id="levelSheet" class="fixed inset-0 z-[300] hidden items-end justify-center bg-black/70 backdrop-blur-sm">
        <div class="w-full max-w-lg bg-[#0b1929] rounded-t-3xl border-t border-[#00bad6]/20 p-5">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-black text-base">üèÑ Niveau de surf</h3>
                <button onclick="closeSheet('levelSheet')" class="text-slate-400"><span
                        class="material-symbols-outlined">close</span></button>
            </div>
            <div class="space-y-2 mb-4">
                <label class="flex items-center gap-3 p-3 rounded-xl bg-[#0f2438] cursor-pointer"><input type="radio"
                        name="surfLevel" value="debutant" class="accent-[#00bad6]" /> ÔøΩÔøΩ D√©butant</label>
                <label class="flex items-center gap-3 p-3 rounded-xl bg-[#0f2438] cursor-pointer"><input type="radio"
                        name="surfLevel" value="intermediaire" checked class="accent-[#00bad6]" /> üèÑ
                    Interm√©diaire</label>
                <label class="flex items-center gap-3 p-3 rounded-xl bg-[#0f2438] cursor-pointer"><input type="radio"
                        name="surfLevel" value="avance" class="accent-[#00bad6]" /> ‚ö° Avanc√©</label>
                <label class="flex items-center gap-3 p-3 rounded-xl bg-[#0f2438] cursor-pointer"><input type="radio"
                        name="surfLevel" value="expert" class="accent-[#00bad6]" /> üî• Expert</label>
            </div>
            <button onclick="applyLevel()"
                class="w-full py-3 rounded-2xl bg-[#00bad6] font-black text-sm text-[#080f1a] active:scale-95 transition-transform">‚úÖ
                Confirmer</button>
        </div>
    </div>

    <!-- Default Spot Sheet -->
    <div id="defaultSpotSheet"
        class="fixed inset-0 z-[300] hidden items-end justify-center bg-black/70 backdrop-blur-sm">
        <div class="w-full max-w-lg bg-[#0b1929] rounded-t-3xl border-t border-emerald-500/20 p-5">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-black text-base">üìç Spot par d√©faut</h3>
                <button onclick="closeSheet('defaultSpotSheet')" class="text-slate-400"><span
                        class="material-symbols-outlined">close</span></button>
            </div>
            <div id="defaultSpotList" class="max-h-64 overflow-y-auto rounded-xl bg-[#080f1a] mb-4"></div>
            <button onclick="applyDefaultSpot()"
                class="w-full py-3 rounded-2xl bg-emerald-500 font-black text-sm text-white">‚úÖ Confirmer</button>
        </div>
    </div>

    <!-- Logout confirm -->
    <div id="logoutSheet" class="fixed inset-0 z-[200] hidden items-end justify-center bg-black/60 backdrop-blur-sm">
        <div class="w-full max-w-lg bg-[#0b1929] rounded-t-3xl border-t border-red-500/20 p-5 text-center">
            <h3 class="font-black text-base text-red-400 mb-2">Se d√©connecter ?</h3>
            <p class="text-slate-400 text-sm mb-5">Tu devras te reconnecter avec tes identifiants SwellSync.</p>
            <button onclick="window.location.href='home.html'"
                class="w-full py-3 rounded-2xl font-black text-sm text-white mb-2" style="background:#ef4444">Oui, me
                d√©connecter</button>
            <button onclick="closeSheet('logoutSheet')" class="w-full py-3 text-slate-400 text-sm">Annuler</button>
        </div>
    </div>

    <!-- 2FA Modal ‚Äî Multi-m√©thode -->
    <div id="twoFASheet" class="fixed inset-0 z-[300] hidden items-end justify-center bg-black/70 backdrop-blur-sm">
        <div
            class="w-full max-w-lg bg-[#0b1929] rounded-t-3xl border-t border-amber-500/20 p-5 max-h-[85vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-black text-base">üîê Authentification √† 2 facteurs</h3>
                <button onclick="closeSheet('twoFASheet')" class="text-slate-400"><span
                        class="material-symbols-outlined">close</span></button>
            </div>

            <!-- Statut actuel -->
            <div id="twoFA_currentStatus" class="flex items-center gap-3 p-3 rounded-xl bg-[#0f2438] mb-4">
                <span class="material-symbols-outlined text-amber-400">shield</span>
                <div class="flex-1">
                    <p class="font-bold text-sm" id="twoFA_statusText">Statut : Chargement...</p>
                    <p class="text-[10px] text-slate-500" id="twoFA_statusDesc">V√©rification en cours</p>
                </div>
            </div>

            <!-- S√©lection de m√©thode -->
            <div id="twoFA_methods" class="space-y-2 mb-4">
                <p class="text-[10px] font-bold text-slate-500 uppercase tracking-wide mb-2">Choisir une m√©thode :</p>

                <!-- Email -->
                <div class="flex items-center gap-3 p-3 rounded-xl bg-[#0f2438] border border-transparent cursor-pointer hover:border-amber-500/30 transition-colors"
                    onclick="select2FAMethod('email')" id="method_email">
                    <div class="w-10 h-10 rounded-xl bg-amber-500/15 flex items-center justify-center"><span
                            class="material-symbols-outlined text-amber-400 text-xl">mail</span></div>
                    <div class="flex-1">
                        <p class="font-bold text-sm">Email OTP</p>
                        <p class="text-[10px] text-slate-500">Code √† 6 chiffres par email</p>
                    </div>
                    <span class="method-badge text-[9px] font-bold px-2 py-0.5 rounded-full hidden">Actif</span>
                </div>

                <!-- TOTP -->
                <div class="flex items-center gap-3 p-3 rounded-xl bg-[#0f2438] border border-transparent cursor-pointer hover:border-purple-500/30 transition-colors"
                    onclick="select2FAMethod('totp')" id="method_totp">
                    <div class="w-10 h-10 rounded-xl bg-purple-500/15 flex items-center justify-center"><span
                            class="material-symbols-outlined text-purple-400 text-xl">qr_code_2</span></div>
                    <div class="flex-1">
                        <p class="font-bold text-sm">Google Authenticator</p>
                        <p class="text-[10px] text-slate-500">Code TOTP via appli (le plus s√©curis√©)</p>
                    </div>
                    <span class="method-badge text-[9px] font-bold px-2 py-0.5 rounded-full hidden">Actif</span>
                </div>

                <!-- SMS -->
                <div class="flex items-center gap-3 p-3 rounded-xl bg-[#0f2438] border border-transparent cursor-pointer hover:border-emerald-500/30 transition-colors"
                    onclick="select2FAMethod('sms')" id="method_sms">
                    <div class="w-10 h-10 rounded-xl bg-emerald-500/15 flex items-center justify-center"><span
                            class="material-symbols-outlined text-emerald-400 text-xl">sms</span></div>
                    <div class="flex-1">
                        <p class="font-bold text-sm">SMS</p>
                        <p class="text-[10px] text-slate-500">Code √† 6 chiffres par SMS</p>
                    </div>
                    <span class="method-badge text-[9px] font-bold px-2 py-0.5 rounded-full hidden">Actif</span>
                </div>

                <!-- Passkey -->
                <div class="flex items-center gap-3 p-3 rounded-xl bg-[#0f2438] border border-transparent cursor-pointer hover:border-cyan-500/30 transition-colors"
                    onclick="select2FAMethod('passkey')" id="method_passkey">
                    <div class="w-10 h-10 rounded-xl bg-cyan-500/15 flex items-center justify-center"><span
                            class="material-symbols-outlined text-cyan-400 text-xl">fingerprint</span></div>
                    <div class="flex-1">
                        <p class="font-bold text-sm">Passkey / Biom√©trie</p>
                        <p class="text-[10px] text-slate-500">Face ID, Touch ID, Windows Hello</p>
                    </div>
                    <span class="method-badge text-[9px] font-bold px-2 py-0.5 rounded-full hidden">Actif</span>
                    <span id="passkey_count" class="text-[9px] text-cyan-400 font-bold hidden">0 cl√©s</span>
                </div>
            </div>

            <!-- Panel Email OTP -->
            <div id="twoFA_panel_email" class="hidden">
                <div class="bg-[#0f2438] rounded-xl p-4 border border-amber-500/10">
                    <h4 class="font-bold text-sm mb-2">üìß V√©rification par Email</h4>
                    <p class="text-[11px] text-slate-400 mb-3">Un code sera envoy√© √† ton adresse email.</p>
                    <button id="email_sendBtn" onclick="send2FACode()"
                        class="w-full py-2.5 rounded-xl bg-amber-500 font-black text-sm text-[#080f1a] active:scale-95 transition-transform">Envoyer
                        le code</button>
                    <div id="email_codeInput" class="hidden mt-3">
                        <input id="email_code" type="text" maxlength="6" inputmode="numeric"
                            class="w-full text-center text-2xl font-black tracking-[0.5em] py-3 bg-[#080f1a] border border-white/10 rounded-xl text-white focus:outline-none focus:border-amber-500/50"
                            placeholder="000000" />
                        <p id="email_debug" class="text-[10px] text-emerald-400 text-center mt-2 hidden"></p>
                        <p id="email_error" class="text-[10px] text-red-400 text-center mt-2 hidden"></p>
                        <button onclick="verifyEmailCode()"
                            class="w-full py-2.5 mt-3 rounded-xl bg-amber-500 font-black text-sm text-[#080f1a] active:scale-95 transition-transform">V√©rifier</button>
                    </div>
                </div>
                <button onclick="hideAllPanels()" class="w-full py-2 mt-2 text-slate-400 text-sm">‚Üê Retour</button>
            </div>

            <!-- Panel TOTP -->
            <div id="twoFA_panel_totp" class="hidden">
                <div class="bg-[#0f2438] rounded-xl p-4 border border-purple-500/10">
                    <h4 class="font-bold text-sm mb-2">üì± Google Authenticator / Authy</h4>
                    <p class="text-[11px] text-slate-400 mb-3">Scanne le QR code avec ton appli d'authentification.</p>
                    <div id="totp_qr" class="flex justify-center mb-3"></div>
                    <p id="totp_secret_display" class="text-[10px] text-center text-slate-500 font-mono mb-3"></p>
                    <button id="totp_generateBtn" onclick="setupTOTP()"
                        class="w-full py-2.5 rounded-xl bg-purple-500 font-black text-sm text-white active:scale-95 transition-transform">G√©n√©rer
                        le QR Code</button>
                    <div id="totp_verifySection" class="hidden mt-3">
                        <p class="text-[11px] text-slate-400 mb-2">Entre le code affich√© dans ton appli :</p>
                        <input id="totp_code" type="text" maxlength="6" inputmode="numeric"
                            class="w-full text-center text-2xl font-black tracking-[0.5em] py-3 bg-[#080f1a] border border-white/10 rounded-xl text-white focus:outline-none focus:border-purple-500/50"
                            placeholder="000000" />
                        <p id="totp_error" class="text-[10px] text-red-400 text-center mt-2 hidden"></p>
                        <button onclick="verifyTOTP()"
                            class="w-full py-2.5 mt-3 rounded-xl bg-purple-500 font-black text-sm text-white active:scale-95 transition-transform">Activer
                            TOTP</button>
                    </div>
                </div>
                <button onclick="hideAllPanels()" class="w-full py-2 mt-2 text-slate-400 text-sm">‚Üê Retour</button>
            </div>

            <!-- Panel SMS -->
            <div id="twoFA_panel_sms" class="hidden">
                <div class="bg-[#0f2438] rounded-xl p-4 border border-emerald-500/10">
                    <h4 class="font-bold text-sm mb-2">üì± V√©rification par SMS</h4>
                    <div id="sms_phoneSection">
                        <p class="text-[11px] text-slate-400 mb-2">Entre ton num√©ro de t√©l√©phone :</p>
                        <input id="sms_phone" type="tel"
                            class="w-full py-3 px-4 bg-[#080f1a] border border-white/10 rounded-xl text-white text-sm focus:outline-none focus:border-emerald-500/50"
                            placeholder="+33 6 12 34 56 78" />
                        <button onclick="setupSMS()"
                            class="w-full py-2.5 mt-3 rounded-xl bg-emerald-500 font-black text-sm text-[#080f1a] active:scale-95 transition-transform">Enregistrer
                            & Envoyer le code</button>
                    </div>
                    <div id="sms_codeSection" class="hidden mt-3">
                        <p class="text-[11px] text-slate-400 mb-2">Entre le code re√ßu par SMS :</p>
                        <input id="sms_code" type="text" maxlength="6" inputmode="numeric"
                            class="w-full text-center text-2xl font-black tracking-[0.5em] py-3 bg-[#080f1a] border border-white/10 rounded-xl text-white focus:outline-none focus:border-emerald-500/50"
                            placeholder="000000" />
                        <p id="sms_debug" class="text-[10px] text-emerald-400 text-center mt-2 hidden"></p>
                        <p id="sms_error" class="text-[10px] text-red-400 text-center mt-2 hidden"></p>
                        <button onclick="verifySMS()"
                            class="w-full py-2.5 mt-3 rounded-xl bg-emerald-500 font-black text-sm text-[#080f1a] active:scale-95 transition-transform">V√©rifier</button>
                    </div>
                </div>
                <button onclick="hideAllPanels()" class="w-full py-2 mt-2 text-slate-400 text-sm">‚Üê Retour</button>
            </div>

            <!-- Panel Passkey -->
            <div id="twoFA_panel_passkey" class="hidden">
                <div class="bg-[#0f2438] rounded-xl p-4 border border-cyan-500/10">
                    <h4 class="font-bold text-sm mb-2">üîë Passkeys / Biom√©trie</h4>
                    <p class="text-[11px] text-slate-400 mb-3">Utilise Face ID, Touch ID ou Windows Hello pour te
                        connecter.</p>
                    <div id="passkey_list" class="space-y-2 mb-3"></div>
                    <button onclick="registerPasskey()"
                        class="w-full py-2.5 rounded-xl bg-cyan-500 font-black text-sm text-[#080f1a] active:scale-95 transition-transform flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined text-sm">add</span> Ajouter une Passkey
                    </button>
                    <p id="passkey_error" class="text-[10px] text-red-400 text-center mt-2 hidden"></p>
                </div>
                <button onclick="hideAllPanels()" class="w-full py-2 mt-2 text-slate-400 text-sm">‚Üê Retour</button>
            </div>

            <!-- Bouton d√©sactiver (si activ√©) -->
            <div id="twoFA_disableSection" class="hidden mt-3">
                <button onclick="disable2FA()"
                    class="w-full py-2.5 rounded-xl bg-red-500/15 text-red-400 font-bold text-sm border border-red-500/20 active:scale-95 transition-transform">
                    D√©sactiver l'A2F
                </button>
            </div>
        </div>
    </div>

    <script>
        function go(url) { if (url !== '#') window.location.href = url; }

        function showInfo(title, body) {
            document.getElementById('infoSheetTitle').textContent = title;
            document.getElementById('infoSheetBody').textContent = body;
            document.getElementById('infoSheet').classList.replace('hidden', 'flex');
        }

        function rateApp() {
            const overlay = document.createElement('div');
            overlay.className = 'sw-confirm-overlay';
            overlay.innerHTML = `
                <div class="sw-confirm-box" style="text-align:center">
                    <img src="/assets/images/swellsync_logo.png" alt="SwellSync" style="width:64px;height:64px;border-radius:16px;margin:0 auto 12px">
                    <div class="sw-confirm-title">√âvaluer SwellSync</div>
                    <div class="sw-confirm-msg">Merci de ta confiance ! üèÑ<br>Chaque avis compte pour une app ind√©pendante.</div>
                    <div style="display:flex;gap:8px;justify-content:center;font-size:32px;margin-bottom:16px;cursor:pointer" id="rateStars">
                        ${'‚òÖ'.repeat(5).split('').map((s, i) => `<span data-v="${i + 1}" onmouseover="rateHover(${i + 1})" onclick="rateSelect(${i + 1})" style="color:#334155;transition:color .2s">${s}</span>`).join('')}
                    </div>
                    <div class="sw-confirm-btns">
                        <button class="sw-confirm-cancel" onclick="this.closest('.sw-confirm-overlay').remove()">Plus tard</button>
                        <button class="sw-confirm-ok" onclick="showToast('Merci pour ton avis ! ‚≠ê','success');this.closest('.sw-confirm-overlay').remove()">Envoyer</button>
                    </div>
                </div>`;
            document.body.appendChild(overlay);
            requestAnimationFrame(() => overlay.classList.add('show'));
            overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); });
        }
        window.rateHover = function (n) {
            document.querySelectorAll('#rateStars span').forEach((s, i) => s.style.color = i < n ? '#f59e0b' : '#334155');
        };
        window.rateSelect = function (n) {
            document.querySelectorAll('#rateStars span').forEach((s, i) => { s.style.color = i < n ? '#f59e0b' : '#334155'; });
        };

        function showAbout() {
            const overlay = document.createElement('div');
            overlay.className = 'sw-confirm-overlay';
            overlay.innerHTML = `
                <div class="sw-confirm-box" style="text-align:center">
                    <img src="/assets/images/swellsync_logo.png" alt="SwellSync" style="width:72px;height:72px;border-radius:18px;margin:0 auto 12px;box-shadow:0 4px 20px rgba(0,186,214,0.3)">
                    <div class="sw-confirm-title">SwellSync</div>
                    <div style="display:inline-block;background:rgba(0,186,214,0.15);color:#00bad6;font-size:11px;font-weight:700;padding:3px 10px;border-radius:8px;margin-bottom:12px">v2.1.0</div>
                    <div class="sw-confirm-msg">
                        Application de pr√©visions surf en temps r√©el.<br>
                        D√©velopp√©e avec ‚ù§Ô∏è pour les surfeurs.<br><br>
                        <span style="font-size:11px;color:#475569">¬© 2026 SwellSync ‚Äî Tous droits r√©serv√©s</span>
                    </div>
                    <div class="sw-confirm-btns">
                        <button class="sw-confirm-cancel" onclick="this.closest('.sw-confirm-overlay').remove()">Fermer</button>
                    </div>
                </div>`;
            document.body.appendChild(overlay);
            requestAnimationFrame(() => overlay.classList.add('show'));
            overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); });
        }

        function toggleRow(row, name) {
            const toggle = row.querySelector('.toggle-switch');
            if (!toggle) return;
            toggle.classList.toggle('on');
            const isOn = toggle.classList.contains('on');
            // Visual feedback
            row.style.background = 'rgba(0,186,214,.06)';
            setTimeout(() => row.style.background = '', 400);
            // Dark mode specific
            if (name === 'Mode sombre') {
                if (typeof swToggleTheme === 'function') swToggleTheme();
                const label = document.getElementById('darkmodeLabel');
                if (label) label.textContent = isOn ? 'Interface sombre (activ√©)' : 'Interface claire (activ√©)';
            }
        }

        function openArchives() { document.getElementById('archiveSheet').classList.replace('hidden', 'flex'); }
        function showLogout() { document.getElementById('logoutSheet').classList.replace('hidden', 'flex'); }
        function closeSheet(id) { document.getElementById(id).classList.replace('flex', 'hidden'); }

        function filterSettings(q) {
            const nq = q.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            document.querySelectorAll('[data-section]').forEach(sec => {
                const txt = sec.querySelector('[data-section]')?.dataset?.section || sec.dataset.section || '';
                const rows = sec.querySelectorAll('.setting-row');
                let visible = 0;
                rows.forEach(row => {
                    const rowText = row.textContent.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                    const show = !nq || rowText.includes(nq) || txt.includes(nq);
                    row.style.display = show ? '' : 'none';
                    if (show) visible++;
                });
                sec.style.display = (!nq || visible > 0) ? '' : 'none';
            });
        }

        // Load follow count
        const followed = JSON.parse(localStorage.getItem('sw_followed') || '[]');
        document.getElementById('followingCount').textContent = `${followed.length} surfeurs suivis`;

        // Load username if stored
        const storedName = localStorage.getItem('sw_username');
        if (storedName) document.getElementById('settingsName').textContent = storedName;

        // ‚îÄ‚îÄ Pro-gate check ‚îÄ‚îÄ
        let memberPlan = 'free';
        API.auth.me()
            .then(m => {
                memberPlan = m?.is_pro === 1 || m?.is_pro === true ? 'pro' : 'free';
                if (m?.name) document.getElementById('settingsName').textContent = m.name;
                if (m?.email) document.getElementById('settingsEmail') && (document.getElementById('settingsEmail').textContent = m.email);
            })
            .catch(() => { });

        function checkProThenGo(url) {
            if (memberPlan === 'pro') { window.location.href = url; }
            else { openProGateOrPage(url, 'Cette fonctionnalit√© est r√©serv√©e aux membres SwellSync Pro ‚≠ê'); }
        }

        function openProGateOrPage(url, msg) {
            // Modale √©l√©gante au lieu de confirm()
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-[999] flex items-center justify-center bg-black/70 backdrop-blur-sm';
            modal.innerHTML = `
                <div class="bg-[#0f2438] rounded-3xl border border-amber-500/20 p-6 max-w-sm mx-4 text-center shadow-2xl">
                    <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center mx-auto mb-4">
                        <span class="material-symbols-outlined text-2xl text-white" style="font-variation-settings:'FILL' 1">workspace_premium</span>
                    </div>
                    <h3 class="text-lg font-black mb-2">SwellSync Pro ‚≠ê</h3>
                    <p class="text-sm text-slate-400 mb-5">${msg}</p>
                    <button onclick="window.location.href='abonnement.html'" class="w-full py-3 rounded-2xl bg-gradient-to-r from-amber-400 to-orange-500 font-black text-sm text-[#080f1a] mb-2 active:scale-95 transition-transform">Passer √† Pro</button>
                    <button onclick="this.closest('.fixed').remove()" class="w-full py-2 text-slate-400 text-sm">Plus tard</button>
                </div>`;
            document.body.appendChild(modal);
            modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
        }

        // ‚îÄ‚îÄ Archive pro gate ‚îÄ‚îÄ
        function openArchivesProGate() {
            if (memberPlan === 'pro') {
                document.getElementById('archiveSheet').classList.replace('hidden', 'flex');
            } else {
                openProGateOrPage('', 'L\'archive de tes posts est disponible avec SwellSync Pro. Retrouve tes posts supprim√©s et archiv√©s facilement.');
            }
        }

        // ‚îÄ‚îÄ Toggle compte priv√© (API r√©elle) ‚îÄ‚îÄ
        function togglePrivacy(row) {
            const toggle = row.querySelector('.toggle-switch');
            if (!toggle) return;
            toggle.classList.toggle('on');
            const isPrivate = toggle.classList.contains('on');
            API.auth.updateProfile({ is_private: isPrivate }).catch(() => { });
            showToasty(isPrivate ? 'üîí Compte mis en priv√©' : 'üîì Compte mis en public');
        }

        // ‚îÄ‚îÄ Toggle afficher activit√© (API r√©elle) ‚îÄ‚îÄ
        function toggleActivity(row) {
            const toggle = row.querySelector('.toggle-switch');
            if (!toggle) return;
            toggle.classList.toggle('on');
            const show = toggle.classList.contains('on');
            API.auth.updateProfile({ show_activity: show }).catch(() => { });
            showToasty(show ? '‚úÖ Activit√© visible' : 'üôà Activit√© masqu√©e');
        }

        // ‚îÄ‚îÄ Notification toggles (DB) ‚îÄ‚îÄ
        const NOTIF_KEYS = {
            'toggle-followers-notif': 'notif_followers',
            'toggle-likes-notif': 'notif_likes',
            'toggle-comments-notif': 'notif_comments',
            'toggle-waves-notif': 'notif_waves',
            'toggle-push-notif': 'notif_marketing',
        };

        // Load notification prefs from API
        // Load prefs from localStorage (no server needed)
        try {
            const prefs = JSON.parse(localStorage.getItem('sw_notif_prefs') || '{}');
            const map = {
                notif_followers: 'toggle-followers-notif',
                notif_likes: 'toggle-likes-notif',
                notif_comments: 'toggle-comments-notif',
                notif_waves: 'toggle-waves-notif',
                notif_marketing: 'toggle-push-notif',
            };
            Object.entries(map).forEach(([key, id]) => {
                const el = document.getElementById(id);
                if (el) { if (prefs[key]) el.classList.add('on'); else el.classList.remove('on'); }
            });
        } catch { }

        // Save notif prefs debounced
        let notifSaveTimeout = null;
        function saveNotifPrefs() {
            clearTimeout(notifSaveTimeout);
            notifSaveTimeout = setTimeout(() => {
                const prefs = {};
                Object.entries(NOTIF_KEYS).forEach(([id, key]) => {
                    const el = document.getElementById(id);
                    if (el) prefs[key] = el.classList.contains('on');
                });
                localStorage.setItem('sw_notif_prefs', JSON.stringify(prefs));
            }, 800);
        }

        // Override toggleRow for notif toggles
        const origToggleRow = toggleRow;
        function toggleRow(row, name) {
            origToggleRow(row, name);
            const toggle = row.querySelector('.toggle-switch');
            if (toggle && Object.keys(NOTIF_KEYS).includes(toggle.id)) {
                saveNotifPrefs();
            }
        }

        // ‚îÄ‚îÄ Language modal ‚îÄ‚îÄ
        function openLanguage() {
            const current = localStorage.getItem('sw_lang') || 'fr';
            document.getElementById('langFR').checked = current === 'fr';
            document.getElementById('langEN').checked = current === 'en';
            document.getElementById('langSheet').classList.replace('hidden', 'flex');
        }
        function applyLanguage() {
            const lang = document.getElementById('langEN').checked ? 'en' : 'fr';
            localStorage.setItem('sw_lang', lang);
            document.getElementById('langSheet').classList.replace('flex', 'hidden');
            showToasty(lang === 'en' ? 'üåê Language set to English ‚Äî reload pages to apply' : 'üåê Langue fran√ßaise activ√©e ‚Äî rechargez les pages');
        }

        // ‚îÄ‚îÄ Change password modal ‚îÄ‚îÄ
        function openChangePassword() {
            document.getElementById('pwdForm').reset();
            document.getElementById('pwdError').textContent = '';
            document.getElementById('pwdSheet').classList.replace('hidden', 'flex');
        }
        async function submitChangePassword() {
            const curr = document.getElementById('pwdCurrent').value;
            const newP = document.getElementById('pwdNew').value;
            const conf = document.getElementById('pwdConfirm').value;
            const errEl = document.getElementById('pwdError');
            errEl.textContent = '';
            if (newP.length < 8) { errEl.textContent = '‚ùå Le nouveau MDP doit faire au moins 8 caract√®res.'; return; }
            if (newP !== conf) { errEl.textContent = '‚ùå Les mots de passe ne correspondent pas.'; return; }
            const btn = document.getElementById('pwdSubmitBtn');
            btn.textContent = '‚è≥ Modification‚Ä¶'; btn.disabled = true;
            try {
                const r = await fetch('/api/auth/password', {
                    method: 'PUT', credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ currentPassword: curr, newPassword: newP })
                });
                const data = await r.json();
                if (!r.ok) throw new Error(data.error || 'Erreur serveur');
                closeSheet('pwdSheet');
                showToasty('‚úÖ Mot de passe mis √† jour !');
            } catch (e) {
                errEl.textContent = '‚ùå ' + e.message;
            } finally {
                btn.textContent = '‚úÖ Confirmer'; btn.disabled = false;
            }
        }

        // ‚îÄ‚îÄ Blocked accounts modal ‚îÄ‚îÄ
        async function openBlockedAccounts() {
            document.getElementById('blockedSheet').classList.replace('hidden', 'flex');
            const list = document.getElementById('blockedList');
            list.innerHTML = '<p class="text-slate-500 text-sm text-center py-4">Chargement‚Ä¶</p>';
            try {
                const r = await fetch('/api/members/blocked', { credentials: 'include' });
                const data = await r.json();
                if (!Array.isArray(data) || data.length === 0) {
                    list.innerHTML = '<p class="text-slate-500 text-xs text-center py-6">‚úÖ Aucun compte bloqu√©</p>';
                } else {
                    list.innerHTML = data.map(u => `
                        <div class="flex items-center gap-3 p-3 border-b border-white/5">
                            <div class="w-9 h-9 rounded-full bg-slate-700 flex items-center justify-center font-bold text-slate-300 text-sm">${(u.name || '?')[0].toUpperCase()}</div>
                            <div class="flex-1"><p class="font-bold text-sm">${u.name || u.email || 'Utilisateur'}</p></div>
                            <button onclick="unblockUser(${u.blocked_id}, this)" class="text-[11px] text-emerald-400 border border-emerald-400/30 px-3 py-1.5 rounded-xl font-bold">D√©bloquer</button>
                        </div>`).join('');
                }
            } catch { list.innerHTML = '<p class="text-red-400 text-xs text-center py-4">Erreur de chargement</p>'; }
        }
        async function unblockUser(id, btn) {
            btn.textContent = '‚è≥';
            try {
                await fetch('/api/members/blocked/' + id, { method: 'DELETE', credentials: 'include' });
                btn.closest('div.flex').remove();
                showToasty('‚úÖ Compte d√©bloqu√©');
            } catch { btn.textContent = 'D√©bloquer'; }
        }

        // ‚îÄ‚îÄ Export data ‚îÄ‚îÄ
        function requestDataExport() {
            showToasty('üìß Un email d\'export vous sera envoy√© sous 48h (RGPD)');
        }

        // ‚îÄ‚îÄ Delete account confirm ‚îÄ‚îÄ
        function confirmDeleteAccount() {
            showConfirmModal(
                '‚ö†Ô∏è Supprimer mon compte',
                'Cette action est <strong>IRR√âVERSIBLE</strong>.<br>Toutes tes donn√©es seront effac√©es dans les 30 jours.<br><br>Es-tu s√ªr de vouloir continuer ?',
                () => {
                    showConfirmModal(
                        'üö® Derni√®re confirmation',
                        'Ton compte SwellSync et toutes tes donn√©es seront d√©finitivement supprim√©s. Cette action ne peut pas √™tre annul√©e.',
                        () => {
                            showToast('üóëÔ∏è Demande de suppression envoy√©e. Tu recevras un email de confirmation.', 'info', 5000);
                        },
                        { danger: true, confirmText: 'Supprimer d√©finitivement' }
                    );
                },
                { danger: true, confirmText: 'Oui, supprimer' }
            );
        }

        // ‚îÄ‚îÄ Authorizations ‚îÄ‚îÄ
        function requestLocation(row) {
            const toggle = row.querySelector('.toggle-switch');
            if (!toggle) return origToggleRow(row, 'Localisation');
            const isOn = !toggle.classList.contains('on');
            if (isOn) {
                navigator.geolocation.getCurrentPosition(
                    () => { toggle.classList.add('on'); localStorage.setItem('sw_perm_geo', '1'); showToasty('üìç Localisation autoris√©e'); },
                    () => { toggle.classList.remove('on'); showToasty('‚ùå Permission refus√©e ‚Äî activez-la dans les r√©glages du t√©l√©phone'); }
                );
            } else {
                toggle.classList.remove('on');
                localStorage.setItem('sw_perm_geo', '0');
                showToasty('üìç Localisation d√©sactiv√©e');
            }
        }

        async function requestPushNotif(row) {
            const toggle = row.querySelector('.toggle-switch');
            if (!toggle) return origToggleRow(row, 'Notifications Push');
            const isOn = !toggle.classList.contains('on');
            if (isOn) {
                const perm = await Notification.requestPermission();
                if (perm === 'granted') { toggle.classList.add('on'); localStorage.setItem('sw_perm_notif', '1'); showToasty('üîî Notifications activ√©es'); }
                else { toggle.classList.remove('on'); showToasty('‚ùå Permission refus√©e dans les r√©glages'); }
            } else {
                toggle.classList.remove('on');
                localStorage.setItem('sw_perm_notif', '0');
                showToasty('üîï Notifications d√©sactiv√©es');
            }
        }

        // ‚îÄ‚îÄ Lang sheet ‚îÄ‚îÄ
        function openLangSheet() {
            document.getElementById('langSheet').classList.replace('hidden', 'flex');
        }

        // ‚îÄ‚îÄ Text size sheet ‚îÄ‚îÄ
        function openTextSizeSheet() {
            const sheet = document.createElement('div');
            sheet.className = 'fixed inset-0 z-[300] flex items-end justify-center bg-black/70 backdrop-blur-sm';
            sheet.id = 'textSizeSheet';
            const current = localStorage.getItem('sw_text_size') || 'normal';
            sheet.innerHTML = `
                <div class="w-full max-w-md bg-[#0f2438] rounded-t-3xl p-6 border-t border-[#00bad6]/10 pb-10">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-black text-base">üî§ Taille du texte</h3>
                        <button onclick="closeSheet('textSizeSheet')" class="text-slate-400"><span class="material-symbols-outlined">close</span></button>
                    </div>
                    <div class="space-y-2">
                        ${['small|Petit|text-xs', 'normal|Normal|text-sm', 'large|Grand|text-base'].map(s => {
                const [val, label, cls] = s.split('|');
                return `<label class="flex items-center gap-3 p-3 rounded-xl bg-[#080f1a] border border-[#00bad6]/10 cursor-pointer hover:bg-[#0b1a2e]">
                                <input type="radio" name="textSize" value="${val}" class="accent-[#00bad6]" ${current === val ? 'checked' : ''} onchange="setTextSize('${val}')" />
                                <span class="${cls} font-semibold">${label}</span>
                            </label>`;
            }).join('')}
                    </div>
                </div>`;
            document.body.appendChild(sheet);
            sheet.addEventListener('click', e => { if (e.target === sheet) sheet.remove(); });
        }
        function setTextSize(size) {
            localStorage.setItem('sw_text_size', size);
            const html = document.documentElement;
            html.classList.remove('text-size-small', 'text-size-normal', 'text-size-large');
            html.classList.add('text-size-' + size);
            showToasty('‚úÖ Taille du texte mise √† jour');
            setTimeout(() => document.getElementById('textSizeSheet')?.remove(), 400);
        }

        // ‚îÄ‚îÄ Accessibility sheet ‚îÄ‚îÄ
        function openAccessibilitySheet() {
            const sheet = document.createElement('div');
            sheet.className = 'fixed inset-0 z-[300] flex items-end justify-center bg-black/70 backdrop-blur-sm';
            sheet.id = 'accessSheet';
            const contrast = localStorage.getItem('sw_high_contrast') === '1';
            const reducedMotion = localStorage.getItem('sw_reduced_motion') === '1';
            sheet.innerHTML = `
                <div class="w-full max-w-md bg-[#0f2438] rounded-t-3xl p-6 border-t border-[#00bad6]/10 pb-10">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-black text-base">‚ôø Accessibilit√©</h3>
                        <button onclick="closeSheet('accessSheet')" class="text-slate-400"><span class="material-symbols-outlined">close</span></button>
                    </div>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between p-3 rounded-xl bg-[#080f1a] border border-[#00bad6]/10">
                            <div>
                                <p class="font-semibold text-sm">Contraste √©lev√©</p>
                                <p class="text-[10px] text-slate-500">Am√©liore la lisibilit√©</p>
                            </div>
                            <div class="toggle-switch ${contrast ? 'on' : ''}" onclick="toggleAccessibility(this, 'sw_high_contrast')"></div>
                        </div>
                        <div class="flex items-center justify-between p-3 rounded-xl bg-[#080f1a] border border-[#00bad6]/10">
                            <div>
                                <p class="font-semibold text-sm">R√©duire les animations</p>
                                <p class="text-[10px] text-slate-500">Moins de transitions et effets</p>
                            </div>
                            <div class="toggle-switch ${reducedMotion ? 'on' : ''}" onclick="toggleAccessibility(this, 'sw_reduced_motion')"></div>
                        </div>
                    </div>
                </div>`;
            document.body.appendChild(sheet);
            sheet.addEventListener('click', e => { if (e.target === sheet) sheet.remove(); });
        }
        function toggleAccessibility(el, key) {
            const isOn = el.classList.toggle('on');
            localStorage.setItem(key, isOn ? '1' : '0');
            showToasty(isOn ? '‚úÖ Activ√©' : '‚ùå D√©sactiv√©');
        }

        // ‚îÄ‚îÄ Units sheet ‚îÄ‚îÄ
        function openUnitsSheet() {
            const curr = localStorage.getItem('sw_units_wave') || 'm';
            const currWind = localStorage.getItem('sw_units_wind') || 'kmh';
            document.getElementById('unitWaveM').checked = curr === 'm';
            document.getElementById('unitWaveFt').checked = curr === 'ft';
            document.getElementById('unitWindKmh').checked = currWind === 'kmh';
            document.getElementById('unitWindKts').checked = currWind === 'kts';
            document.getElementById('unitsSheet').classList.replace('hidden', 'flex');
        }
        function applyUnits() {
            localStorage.setItem('sw_units_wave', document.getElementById('unitWaveFt').checked ? 'ft' : 'm');
            localStorage.setItem('sw_units_wind', document.getElementById('unitWindKts').checked ? 'kts' : 'kmh');
            closeSheet('unitsSheet');
            showToasty('‚úÖ Unit√©s mises √† jour');
        }

        // ‚îÄ‚îÄ Level sheet ‚îÄ‚îÄ
        function openLevelSheet() {
            const curr = localStorage.getItem('sw_surf_level') || 'intermediaire';
            document.querySelectorAll('[name="surfLevel"]').forEach(r => { r.checked = r.value === curr; });
            document.getElementById('levelSheet').classList.replace('hidden', 'flex');
        }
        function applyLevel() {
            const sel = document.querySelector('[name="surfLevel"]:checked');
            if (sel) {
                localStorage.setItem('sw_surf_level', sel.value);
                API.auth.updateProfile({ level: sel.value }).catch(() => { });
            }
            closeSheet('levelSheet');
            showToasty('‚úÖ Niveau mis √† jour');
        }

        // ‚îÄ‚îÄ Default spot sheet ‚îÄ‚îÄ
        function openDefaultSpotSheet() {
            const list = document.getElementById('defaultSpotList');
            list.innerHTML = '<p class="text-slate-500 text-sm text-center py-3">Chargement des favoris‚Ä¶</p>';
            document.getElementById('defaultSpotSheet').classList.replace('hidden', 'flex');
            API.favorites.list()
                .then(favs => {
                    const spots = (favs || []).map(f => f.spots || f);
                    if (!spots.length) { list.innerHTML = '<p class="text-slate-400 text-xs text-center py-4">Aucun spot favori. Ajoutes-en depuis la carte !</p>'; return; }
                    const curr = localStorage.getItem('sw_default_spot') || '';
                    list.innerHTML = spots.map(s => `
                        <label class="flex items-center gap-3 p-3 border-b border-white/5 cursor-pointer hover:bg-white/3">
                            <input type="radio" name="defaultSpot" value="${s.spot_id || s.id}" ${(s.name || '') === curr ? 'checked' : ''} class="accent-[#00bad6]"/>
                            <div><p class="font-bold text-sm">${s.name || ''}</p><p class="text-[11px] text-slate-500">${s.location || ''}</p></div>
                        </label>`).join('');
                }).catch(() => { list.innerHTML = '<p class="text-red-400 text-xs text-center py-4">Erreur</p>'; });
        }
        function applyDefaultSpot() {
            const sel = document.querySelector('[name="defaultSpot"]:checked');
            if (sel) localStorage.setItem('sw_default_spot', sel.value);
            closeSheet('defaultSpotSheet');
            showToasty('‚úÖ Spot par d√©faut mis √† jour');
        }

        // ‚îÄ‚îÄ Toast notification ‚îÄ‚îÄ
        function showToasty(msg) {
            let t = document.getElementById('settingsToast');
            if (!t) {
                t = document.createElement('div');
                t.id = 'settingsToast';
                t.style.cssText = 'position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#1e3a5f;color:#f1f5f9;border:1px solid rgba(0,186,214,.3);border-radius:16px;padding:10px 18px;font-size:12px;font-weight:700;z-index:9999;transition:opacity .3s;white-space:nowrap;';
                document.body.appendChild(t);
            }
            t.textContent = msg; t.style.opacity = '1';
            clearTimeout(t._timer);
            t._timer = setTimeout(() => { t.style.opacity = '0'; }, 3000);
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // 2FA FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let is2FAEnabled = false;

        async function check2FAStatus() {
            try {
                const r = await fetch('/api/auth/2fa-status', { credentials: 'include' }).then(x => x.json());
                is2FAEnabled = r.is_2fa_enabled;
                update2FADisplay();
            } catch {
                document.getElementById('2faStatus').textContent = 'Non dispo';
            }
        }

        function update2FADisplay() {
            const statusEl = document.getElementById('2faStatus');
            if (is2FAEnabled) {
                statusEl.textContent = '‚úÖ Activ√©';
                statusEl.className = 'text-[10px] font-bold text-emerald-400 mr-1';
            } else {
                statusEl.textContent = '‚ùå D√©sactiv√©';
                statusEl.className = 'text-[10px] font-bold text-red-400 mr-1';
            }
            // Also update modal
            const txt = document.getElementById('twoFA_statusText');
            const desc = document.getElementById('twoFA_statusDesc');
            const btn = document.getElementById('twoFA_sendBtn');
            if (txt) {
                if (is2FAEnabled) {
                    txt.textContent = 'Statut : ‚úÖ Activ√©';
                    desc.textContent = 'Le 2FA prot√®ge ton compte. Tu peux le d√©sactiver ci-dessous.';
                    btn.innerHTML = '<span class="material-symbols-outlined text-sm">mail</span> D√©sactiver le 2FA';
                    btn.className = btn.className.replace('bg-amber-500', 'bg-red-500').replace('hover:bg-amber-400', 'hover:bg-red-400');
                } else {
                    txt.textContent = 'Statut : ‚ùå D√©sactiv√©';
                    desc.textContent = 'Active le 2FA pour renforcer la s√©curit√© de ton compte.';
                    btn.innerHTML = '<span class="material-symbols-outlined text-sm">mail</span> Envoyer le code de v√©rification';
                    btn.className = btn.className.replace('bg-red-500', 'bg-amber-500').replace('hover:bg-red-400', 'hover:bg-amber-400');
                }
            }
        }

        function open2FAModal() {
            reset2FAModal();
            document.getElementById('twoFASheet').classList.replace('hidden', 'flex');
            check2FAStatus();
        }

        function reset2FAModal() {
            hideAllPanels();
            // Reset email panel
            const sendBtn = document.getElementById('email_sendBtn');
            if (sendBtn) { sendBtn.classList.remove('hidden'); sendBtn.innerHTML = 'Envoyer le code'; }
            const codeInput = document.getElementById('email_codeInput');
            if (codeInput) codeInput.classList.add('hidden');
            const emailCode = document.getElementById('email_code');
            if (emailCode) emailCode.value = '';
            // Reset TOTP panel
            const totpQr = document.getElementById('totp_qr');
            if (totpQr) totpQr.innerHTML = '';
            const totpSecret = document.getElementById('totp_secret_display');
            if (totpSecret) totpSecret.textContent = '';
            const totpVerify = document.getElementById('totp_verifySection');
            if (totpVerify) totpVerify.classList.add('hidden');
            const totpCode = document.getElementById('totp_code');
            if (totpCode) totpCode.value = '';
            const totpBtn = document.getElementById('totp_generateBtn');
            if (totpBtn) totpBtn.textContent = 'G√©n√©rer le QR Code';
            // Reset SMS panel
            const smsPhone = document.getElementById('sms_phoneSection');
            if (smsPhone) smsPhone.classList.remove('hidden');
            const smsCode = document.getElementById('sms_codeSection');
            if (smsCode) smsCode.classList.add('hidden');
            const smsInput = document.getElementById('sms_code');
            if (smsInput) smsInput.value = '';
            // Reset disable section visibility
            const disableSection = document.getElementById('twoFA_disableSection');
            if (disableSection) {
                if (is2FAEnabled) disableSection.classList.remove('hidden');
                else disableSection.classList.add('hidden');
            }
            // Hide all errors/debug
            ['email_error', 'email_debug', 'totp_error', 'sms_error', 'sms_debug', 'passkey_error'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // EMAIL SEND CODE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        async function send2FACode() {
            const btn = document.getElementById('email_sendBtn');
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Envoi en cours...';
            try {
                const r = await fetch('/api/auth/2fa-send-code', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                }).then(x => x.json());
                if (r.success) {
                    btn.classList.add('hidden');
                    document.getElementById('email_codeInput').classList.remove('hidden');
                    if (r.debug_code) {
                        const dbg = document.getElementById('email_debug');
                        dbg.textContent = `üîë Code (dev) : ${r.debug_code}`;
                        dbg.classList.remove('hidden');
                    }
                    document.getElementById('email_code').focus();
                }
            } catch (e) {
                showToasty('‚ùå Erreur lors de l\'envoi du code');
            }
            btn.disabled = false;
            btn.innerHTML = 'Envoyer le code';
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // 2FA METHOD SELECTION & PANEL MANAGEMENT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function select2FAMethod(method) {
            // Hide all panels first
            hideAllPanels();
            // Show selected panel
            const panel = document.getElementById('twoFA_panel_' + method);
            if (panel) panel.classList.remove('hidden');
            // Highlight selected method
            ['email', 'totp', 'sms', 'passkey'].forEach(m => {
                const el = document.getElementById('method_' + m);
                if (el) {
                    if (m === method) {
                        el.classList.add('border-[#00bad6]/40');
                        el.classList.remove('border-transparent');
                    } else {
                        el.classList.remove('border-[#00bad6]/40');
                        el.classList.add('border-transparent');
                    }
                }
            });
            // If passkey, load existing keys
            if (method === 'passkey') loadPasskeyList();
        }

        function hideAllPanels() {
            ['email', 'totp', 'sms', 'passkey'].forEach(m => {
                const panel = document.getElementById('twoFA_panel_' + m);
                if (panel) panel.classList.add('hidden');
            });
            // Reset method highlights
            ['email', 'totp', 'sms', 'passkey'].forEach(m => {
                const el = document.getElementById('method_' + m);
                if (el) {
                    el.classList.remove('border-[#00bad6]/40');
                    el.classList.add('border-transparent');
                }
            });
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // EMAIL OTP (panel-specific verify)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        async function verifyEmailCode() {
            const code = document.getElementById('email_code').value.trim();
            const errorEl = document.getElementById('email_error');
            errorEl.classList.add('hidden');
            if (code.length !== 6) {
                errorEl.textContent = 'Le code doit contenir 6 chiffres';
                errorEl.classList.remove('hidden');
                return;
            }
            try {
                const action = is2FAEnabled ? 'disable' : 'enable';
                const r = await fetch('/api/auth/2fa-verify', {
                    method: 'POST', credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, action })
                }).then(x => x.json());
                if (r.success) {
                    is2FAEnabled = r.is_2fa_enabled;
                    update2FADisplay();
                    closeSheet('twoFASheet');
                    showToasty(is2FAEnabled ? 'üîê 2FA Email activ√© !' : 'üîì 2FA d√©sactiv√©');
                } else {
                    errorEl.textContent = r.error || 'Code incorrect';
                    errorEl.classList.remove('hidden');
                }
            } catch {
                errorEl.textContent = 'Erreur serveur';
                errorEl.classList.remove('hidden');
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // TOTP (Google Authenticator)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        async function setupTOTP() {
            const btn = document.getElementById('totp_generateBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ G√©n√©ration...';
            try {
                const r = await fetch('/api/auth/totp-setup', {
                    method: 'POST', credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                }).then(x => x.json());
                if (r.success) {
                    // Display QR code
                    document.getElementById('totp_qr').innerHTML =
                        `<img src="${r.qrCode}" alt="QR Code" class="w-48 h-48 rounded-xl border border-white/10" />`;
                    // Display secret key for manual entry
                    document.getElementById('totp_secret_display').textContent =
                        `Cl√© manuelle : ${r.secret}`;
                    // Show verify section
                    document.getElementById('totp_verifySection').classList.remove('hidden');
                    btn.textContent = '‚úÖ QR Code g√©n√©r√©';
                } else {
                    showToasty('‚ùå ' + (r.error || 'Erreur'));
                    btn.textContent = 'G√©n√©rer le QR Code';
                }
            } catch {
                showToasty('‚ùå Erreur serveur');
                btn.textContent = 'G√©n√©rer le QR Code';
            }
            btn.disabled = false;
        }

        async function verifyTOTP() {
            const code = document.getElementById('totp_code').value.trim();
            const errorEl = document.getElementById('totp_error');
            errorEl.classList.add('hidden');
            if (code.length !== 6) {
                errorEl.textContent = 'Le code doit contenir 6 chiffres';
                errorEl.classList.remove('hidden');
                return;
            }
            try {
                const action = is2FAEnabled ? 'disable' : 'enable';
                const r = await fetch('/api/auth/totp-verify', {
                    method: 'POST', credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, action })
                }).then(x => x.json());
                if (r.success) {
                    is2FAEnabled = r.is_2fa_enabled;
                    update2FADisplay();
                    closeSheet('twoFASheet');
                    showToasty(is2FAEnabled ? 'üîê TOTP activ√© avec succ√®s !' : 'üîì TOTP d√©sactiv√©');
                } else {
                    errorEl.textContent = r.error || 'Code TOTP invalide';
                    errorEl.classList.remove('hidden');
                }
            } catch {
                errorEl.textContent = 'Erreur serveur';
                errorEl.classList.remove('hidden');
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SMS OTP
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        async function setupSMS() {
            const phone = document.getElementById('sms_phone').value.trim();
            if (!phone || phone.length < 8) {
                showToasty('‚ùå Num√©ro de t√©l√©phone invalide');
                return;
            }
            try {
                // Step 1: Register phone number
                const setup = await fetch('/api/auth/sms-setup', {
                    method: 'POST', credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone })
                }).then(x => x.json());
                if (!setup.success) {
                    showToasty('‚ùå ' + (setup.error || 'Erreur enregistrement'));
                    return;
                }
                // Step 2: Send verification code
                const send = await fetch('/api/auth/sms-send-code', {
                    method: 'POST', credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                }).then(x => x.json());
                if (send.success) {
                    document.getElementById('sms_phoneSection').classList.add('hidden');
                    document.getElementById('sms_codeSection').classList.remove('hidden');
                    // Show debug code in dev
                    if (send.debug_code) {
                        const dbg = document.getElementById('sms_debug');
                        dbg.textContent = `üîë Code (dev) : ${send.debug_code}`;
                        dbg.classList.remove('hidden');
                    }
                    showToasty('üì± Code envoy√© !');
                } else {
                    showToasty('‚ùå ' + (send.error || 'Erreur envoi SMS'));
                }
            } catch {
                showToasty('‚ùå Erreur serveur');
            }
        }

        async function verifySMS() {
            const code = document.getElementById('sms_code').value.trim();
            const errorEl = document.getElementById('sms_error');
            errorEl.classList.add('hidden');
            if (code.length !== 6) {
                errorEl.textContent = 'Le code doit contenir 6 chiffres';
                errorEl.classList.remove('hidden');
                return;
            }
            try {
                const action = is2FAEnabled ? 'disable' : 'enable';
                const r = await fetch('/api/auth/sms-verify', {
                    method: 'POST', credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, action })
                }).then(x => x.json());
                if (r.success) {
                    is2FAEnabled = r.is_2fa_enabled;
                    update2FADisplay();
                    closeSheet('twoFASheet');
                    showToasty(is2FAEnabled ? 'üîê 2FA SMS activ√© !' : 'üîì 2FA SMS d√©sactiv√©');
                } else {
                    errorEl.textContent = r.error || 'Code incorrect';
                    errorEl.classList.remove('hidden');
                }
            } catch {
                errorEl.textContent = 'Erreur serveur';
                errorEl.classList.remove('hidden');
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PASSKEYS (WebAuthn)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        async function loadPasskeyList() {
            const list = document.getElementById('passkey_list');
            list.innerHTML = '<p class="text-slate-500 text-xs text-center py-2">Chargement‚Ä¶</p>';
            try {
                const r = await fetch('/api/auth/2fa-status', { credentials: 'include' }).then(x => x.json());
                if (r.passkeys && r.passkeys.length > 0) {
                    list.innerHTML = r.passkeys.map(pk => `
                        <div class="flex items-center gap-3 p-3 rounded-xl bg-[#080f1a] border border-cyan-500/10">
                            <span class="material-symbols-outlined text-cyan-400 text-lg">key</span>
                            <div class="flex-1">
                                <p class="font-bold text-xs">${pk.device_name || 'Passkey'}</p>
                                <p class="text-[9px] text-slate-500">${new Date(pk.created_at).toLocaleDateString('fr-FR')}</p>
                            </div>
                            <button onclick="deletePasskey(${pk.id}, this)"
                                class="text-[10px] text-red-400 border border-red-400/20 px-2 py-1 rounded-lg font-bold hover:bg-red-400/10">
                                Supprimer
                            </button>
                        </div>`).join('');
                    const countEl = document.getElementById('passkey_count');
                    if (countEl) { countEl.textContent = r.passkeys.length + ' cl√©(s)'; countEl.classList.remove('hidden'); }
                } else {
                    list.innerHTML = '<p class="text-slate-500 text-xs text-center py-2">Aucune passkey enregistr√©e</p>';
                }
            } catch {
                list.innerHTML = '<p class="text-red-400 text-xs text-center py-2">Erreur de chargement</p>';
            }
        }

        async function registerPasskey() {
            const errorEl = document.getElementById('passkey_error');
            errorEl.classList.add('hidden');
            try {
                // Step 1: Get registration options from server
                const optionsRes = await fetch('/api/auth/passkey-register-options', {
                    method: 'POST', credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                }).then(x => x.json());
                if (optionsRes.error) {
                    errorEl.textContent = optionsRes.error;
                    errorEl.classList.remove('hidden');
                    return;
                }

                // Step 2: Create credential with browser WebAuthn API
                const credential = await navigator.credentials.create({
                    publicKey: {
                        ...optionsRes,
                        challenge: Uint8Array.from(atob(optionsRes.challenge.replace(/-/g, '+').replace(/_/g, '/')), c => c.charCodeAt(0)),
                        user: {
                            ...optionsRes.user,
                            id: Uint8Array.from(atob(optionsRes.user.id.replace(/-/g, '+').replace(/_/g, '/')), c => c.charCodeAt(0))
                        },
                        excludeCredentials: (optionsRes.excludeCredentials || []).map(c => ({
                            ...c,
                            id: Uint8Array.from(atob(c.id.replace(/-/g, '+').replace(/_/g, '/')), ch => ch.charCodeAt(0))
                        }))
                    }
                });

                // Step 3: Send credential to server for verification
                const credData = {
                    id: credential.id,
                    rawId: btoa(String.fromCharCode(...new Uint8Array(credential.rawId))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, ''),
                    type: credential.type,
                    response: {
                        attestationObject: btoa(String.fromCharCode(...new Uint8Array(credential.response.attestationObject))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, ''),
                        clientDataJSON: btoa(String.fromCharCode(...new Uint8Array(credential.response.clientDataJSON))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '')
                    }
                };

                const verify = await fetch('/api/auth/passkey-register-verify', {
                    method: 'POST', credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ credential: credData, deviceName: navigator.platform || 'Appareil' })
                }).then(x => x.json());

                if (verify.success) {
                    is2FAEnabled = true;
                    update2FADisplay();
                    loadPasskeyList();
                    showToasty('üîë Passkey enregistr√©e avec succ√®s !');
                } else {
                    errorEl.textContent = verify.error || 'Erreur de v√©rification';
                    errorEl.classList.remove('hidden');
                }
            } catch (e) {
                if (e.name === 'NotAllowedError') {
                    errorEl.textContent = 'Enregistrement annul√© par l\'utilisateur';
                } else {
                    errorEl.textContent = 'Erreur : ' + (e.message || 'WebAuthn non support√©');
                }
                errorEl.classList.remove('hidden');
            }
        }

        async function deletePasskey(id, btn) {
            btn.textContent = '‚è≥';
            btn.disabled = true;
            try {
                const r = await fetch('/api/auth/passkey/' + id, {
                    method: 'DELETE', credentials: 'include'
                }).then(x => x.json());
                if (r.success) {
                    btn.closest('div.flex').remove();
                    showToasty('üóëÔ∏è Passkey supprim√©e');
                    // Reload status
                    check2FAStatus();
                    loadPasskeyList();
                } else {
                    btn.textContent = 'Supprimer';
                    btn.disabled = false;
                }
            } catch {
                btn.textContent = 'Supprimer';
                btn.disabled = false;
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // DISABLE 2FA
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        async function disable2FA() {
            // Send email code first, then verify to disable
            try {
                const r = await fetch('/api/auth/2fa-send-code', {
                    method: 'POST', credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                }).then(x => x.json());
                if (r.success) {
                    // Show the email panel for verification
                    select2FAMethod('email');
                    document.getElementById('email_sendBtn').classList.add('hidden');
                    document.getElementById('email_codeInput').classList.remove('hidden');
                    if (r.debug_code) {
                        const dbg = document.getElementById('email_debug');
                        dbg.textContent = `üîë Code (dev) : ${r.debug_code}`;
                        dbg.classList.remove('hidden');
                    }
                    showToasty('üìß Code de v√©rification envoy√© pour d√©sactiver le 2FA');
                }
            } catch {
                showToasty('‚ùå Erreur serveur');
            }
        }

        // Init 2FA status on page load
        check2FAStatus();
    </script>

    <!-- Bottom Nav -->
    <nav class="fixed bottom-0 left-0 right-0 border-t border-[#00bad6]/20 pb-6 pt-2 px-2 flex justify-between items-center z-50 backdrop-blur-lg transition-colors duration-300"
        style="background: var(--nav-bg, rgba(8,15,26,0.95))">
        <a class="flex flex-col items-center gap-1 text-slate-500 flex-1" href="home.html"><span
                class="material-symbols-outlined">home</span><span class="text-[10px]">Home</span>
        </a>
        <a class="flex flex-col items-center gap-1 text-slate-500 flex-1" href="map.html"><span
                class="material-symbols-outlined">travel_explore</span><span class="text-[10px]">Spots</span>
        </a>
        <a class="flex flex-col items-center gap-1 text-slate-500 flex-1" href="alerts.html"><span
                style="position:relative;display:inline-block;"><span
                    class="material-symbols-outlined">notifications</span><span
                    style="position:absolute;top:-1px;left:-3px;font-size:8px;line-height:1;z-index:2;display:inline-flex;align-items:center;justify-content:center;background:#f59e0b;border-radius:50%;width:11px;height:11px;font-weight:900;color:#080f1a;">‚≠ê</span></span><span
                class="text-[10px]">Alertes</span>
        </a>
        <a class="flex flex-col items-center gap-1 text-slate-500 flex-1" href="community.html"><span
                class="material-symbols-outlined">groups</span><span class="text-[10px]">Communaut√©</span>
        </a>
        <a class="flex flex-col items-center gap-1 text-[#00bad6] flex-1" href="profile.html"><span
                class="material-symbols-outlined" style="font-variation-settings:'FILL' 1">person</span><span
                class="text-[10px] font-bold">Profil</span>
            <div class="w-1 h-1 bg-[#00bad6] rounded-full mt-0.5 active:scale-95 transition-transform"></div>
        </a>
    </nav>

    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(() => { });
        }
    </script>
    <script src="js/adsense.js"></script>
    <script src="js/share-social.js"></script>
    <script src="js/ui-components.js"></script>
    <script src="js/notif-badge.js"></script>
    <script src="/js/i18n.js"></script>
    <script src="/js/push_notifs.js" defer></script>
</body>

</html>