<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mes Statistiques Surf ‚Äî SwellSync</title>
    <meta name="description"
        content="Consultez vos statistiques de surf d√©taill√©es: sessions, distance, vagues, score moyen et progression sur 30 jours.">
    <link rel="icon" href="/assets/icons/icon-192.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0
        }

        :root {
            --bg: #0a0f1e;
            --text: #f1f5f9;
            --sub: #94a3b8;
            --muted: #64748b;
            --border: rgba(255, 255, 255, .07);
            --blue: #0ea5e9;
            --green: #10b981;
            --surface: rgba(255, 255, 255, .04)
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            padding-bottom: 80px
        }

        .header {
            padding: 20px 20px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px
        }

        .header h1 {
            font-size: 24px;
            font-weight: 900
        }

        .period-tabs {
            display: flex;
            gap: 0;
            background: rgba(255, 255, 255, .04);
            border-radius: 12px;
            padding: 2px;
            margin: 0 20px 20px
        }

        .period-tab {
            flex: 1;
            padding: 7px;
            border: none;
            border-radius: 10px;
            background: none;
            color: var(--muted);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all .2s
        }

        .period-tab.active {
            background: rgba(14, 165, 233, .15);
            color: var(--blue)
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            padding: 0 20px;
            margin-bottom: 20px
        }

        @media(min-width:640px) {
            .stats-grid {
                grid-template-columns: repeat(4, 1fr)
            }
        }

        .stat-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 16px
        }

        .stat-icon {
            font-size: 24px;
            margin-bottom: 6px
        }

        .stat-value {
            font-size: 28px;
            font-weight: 900;
            color: var(--text);
            line-height: 1
        }

        .stat-label {
            font-size: 11px;
            color: var(--muted);
            margin-top: 4px
        }

        .stat-trend {
            font-size: 11px;
            margin-top: 4px;
            font-weight: 600
        }

        .trend-up {
            color: var(--green)
        }

        .trend-down {
            color: #ef4444
        }

        .section {
            padding: 0 20px;
            margin-bottom: 24px
        }

        .section-title {
            font-size: 16px;
            font-weight: 800;
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 8px
        }

        .chart-container {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 16px;
            height: 200px
        }

        .session-list {
            display: flex;
            flex-direction: column;
            gap: 10px
        }

        .session-item {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 14px;
            display: flex;
            align-items: center;
            gap: 12px
        }

        .session-score {
            font-size: 24px;
            font-weight: 900
        }

        .session-info {
            flex: 1
        }

        .session-name {
            font-weight: 700;
            font-size: 14px
        }

        .session-meta {
            font-size: 12px;
            color: var(--muted);
            margin-top: 2px
        }

        .export-btn {
            margin: 0 20px;
            width: calc(100% - 40px);
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 13px;
            color: var(--text);
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px
        }

        .export-btn:hover {
            border-color: rgba(14, 165, 233, .3);
            background: rgba(14, 165, 233, .05)
        }

        .heatmap {
            display: grid;
            grid-template-columns: repeat(26, 1fr);
            gap: 2px;
            margin-top: 10px
        }

        .heatmap-cell {
            aspect-ratio: 1;
            border-radius: 2px;
            min-width: 8px
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(10, 15, 30, .95);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            padding: 10px 0 16px
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            text-decoration: none;
            color: var(--muted);
            font-size: 10px;
            font-weight: 600
        }

        .nav-item.active {
            color: var(--blue)
        }

        .nav-icon {
            font-size: 22px
        }
    </style>
</head>

<body>
    <div id="app">
        <div class="header">
            <div>
                <h1>üìä Mes Stats</h1>
                <div id="stats-subtitle" style="font-size:13px;color:var(--muted)">Chargement...</div>
            </div>
            <div id="level-mini" style="font-size:24px">üèÑ</div>
        </div>

        <!-- Onglets p√©riode -->
        <div class="period-tabs">
            <button class="period-tab active" onclick="loadStats('month',this)">Ce mois</button>
            <button class="period-tab" onclick="loadStats('quarter',this)">3 mois</button>
            <button class="period-tab" onclick="loadStats('year',this)">Cette ann√©e</button>
            <button class="period-tab" onclick="loadStats('all',this)">Tout</button>
        </div>

        <!-- KPI Cards (T81-84) -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üèÑ</div>
                <div class="stat-value" id="stat-sessions">‚Äî</div>
                <div class="stat-label">Sessions</div>
                <div class="stat-trend" id="trend-sessions"></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üåä</div>
                <div class="stat-value" id="stat-waves">‚Äî</div>
                <div class="stat-label">Vagues</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìè</div>
                <div class="stat-value" id="stat-distance">‚Äî</div>
                <div class="stat-label">Km parcourus</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚≠ê</div>
                <div class="stat-value" id="stat-score">‚Äî</div>
                <div class="stat-label">Score moyen</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚è±Ô∏è</div>
                <div class="stat-value" id="stat-hours">‚Äî</div>
                <div class="stat-label">Heures en eau</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìÖ</div>
                <div class="stat-value" id="stat-streak">‚Äî</div>
                <div class="stat-label">Sem. cons√©cutives</div>
            </div>
            <div class="stat-card" style="grid-column:span 2">
                <div class="stat-icon">üèÜ</div>
                <div class="stat-value" id="stat-best-spot" style="font-size:16px">‚Äî</div>
                <div class="stat-label">Spot pr√©f√©r√©</div>
            </div>
        </div>

        <!-- Graphique score T22 -->
        <div class="section">
            <div class="section-title">üìà √âvolution score moyen</div>
            <div class="chart-container"><canvas id="score-chart"></canvas></div>
        </div>

        <!-- Carte thermique des jours (T86) -->
        <div class="section">
            <div class="section-title">üóìÔ∏è Activit√© (52 semaines)</div>
            <div class="chart-container" style="height:auto;padding:12px">
                <div style="font-size:11px;color:var(--muted);margin-bottom:8px;display:flex;gap:20px">
                    <span>Jan</span><span>Mar</span><span>Mai</span><span>Juil</span><span>Sep</span><span>Nov</span>
                </div>
                <div id="heatmap" class="heatmap"></div>
                <div style="display:flex;align-items:center;gap:6px;margin-top:8px;font-size:11px;color:var(--muted)">
                    Moins <div style="display:flex;gap:2px">
                        ${['rgba(255,255,255,.04)','rgba(14,165,233,.15)','rgba(14,165,233,.3)','rgba(14,165,233,.6)','#0ea5e9'].map(c=>`
                        <div style="width:10px;height:10px;border-radius:2px;background:${c}"></div>`).join('')}</div>
                    Plus
                </div>
            </div>
        </div>

        <!-- Sessions r√©centes (T85) -->
        <div class="section">
            <div class="section-title">üïê Sessions r√©centes</div>
            <div class="session-list" id="sessions-list">
                <div style="text-align:center;padding:20px;color:var(--muted)">‚è≥ Chargement...</div>
            </div>
        </div>

        <!-- Export PDF T88 -->
        <button class="export-btn" id="export-btn" onclick="exportStats()">
            üìÑ Exporter le bilan de saison (PDF)
            <span id="export-pro-badge"
                style="display:none;background:rgba(245,158,11,.15);color:#f59e0b;border-radius:8px;padding:2px 8px;font-size:11px;font-weight:700">Pro</span>
        </button>

        <!-- Comparaison communaut√© T87 -->
        <div class="section" style="margin-top:20px">
            <div class="section-title">üë• Toi vs. la communaut√©</div>
            <div id="community-compare"
                style="background:var(--surface);border:1px solid var(--border);border-radius:18px;padding:16px">
                <div style="text-align:center;padding:20px;color:var(--muted)">‚è≥ Chargement...</div>
            </div>
        </div>
    </div>

    <!-- Bottom nav -->
    <nav class="bottom-nav">
        <a href="/index.html" class="nav-item"><span class="nav-icon">üè†</span>Accueil</a>
        <a href="/pages/session-live.html" class="nav-item"><span class="nav-icon">üèÑ</span>Session</a>
        <a href="/pages/community.html" class="nav-item"><span class="nav-icon">üë•</span>Communaut√©</a>
        <a href="/pages/stats.html" class="nav-item active"><span class="nav-icon">üìä</span>Stats</a>
        <a href="/pages/profile.html" class="nav-item"><span class="nav-icon">üë§</span>Profil</a>
    </nav>

    <script src="/js/supabase-client.js"></script>
    <script src="/js/profile-advanced.js"></script>
    <script>
        const SUPABASE_URL = 'https://bsxpwsmxwpqkbzlauigy.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJzeHB3c214d3Bxa2J6bGF1aWd5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA2Nzg5MzUsImV4cCI6MjA1NjI1NDkzNX0.Cx24BjKjBF_6-nLRTY5iy6DflHQ7Y00fGGxnJbEiN3A';
        const supabase = window.supabase?.createClient ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;

        let currentPeriod = 'month';
        let allSessions = [];

        async function loadStats(period = 'month', btn) {
            currentPeriod = period;
            document.querySelectorAll('.period-tab').forEach(t => t.classList.remove('active'));
            if (btn) btn.classList.add('active');
            if (!supabase) { renderMockData(); return; }
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) { renderMockData(); return; }
                const { data: member } = await supabase.from('members').select('id, level, is_pro').eq('auth_id', user.id).single();
                const since = getSinceDate(period);
                const { data: sessions } = await supabase.from('surf_sessions').select('*').eq('user_id', member.id).gte('started_at', since.toISOString()).order('started_at', { ascending: false });
                allSessions = sessions || [];
                renderStats(allSessions, member);
            } catch { renderMockData(); }
        }

        function getSinceDate(period) {
            const d = new Date();
            if (period === 'month') d.setMonth(d.getMonth() - 1);
            else if (period === 'quarter') d.setMonth(d.getMonth() - 3);
            else if (period === 'year') d.setFullYear(d.getFullYear() - 1);
            else d.setFullYear(2020);
            return d;
        }

        function renderStats(sessions, member) {
            const totalSessions = sessions.length;
            const totalWaves = sessions.reduce((s, x) => s + (x.wave_count || 0), 0);
            const totalDist = sessions.reduce((s, x) => s + (x.distance_km || 0), 0);
            const totalHours = sessions.reduce((s, x) => s + (x.duration_minutes || 0), 0) / 60;
            const avgScore = sessions.length ? (sessions.reduce((s, x) => s + (x.score || 0), 0) / sessions.length).toFixed(1) : '‚Äî';
            const spotCounts = {};
            sessions.forEach(s => { if (s.spot_name) spotCounts[s.spot_name] = (spotCounts[s.spot_name] || 0) + 1; });
            const bestSpot = Object.entries(spotCounts).sort((a, b) => b[1] - a[1])[0]?.[0] || '‚Äî';

            document.getElementById('stat-sessions').textContent = totalSessions;
            document.getElementById('stat-waves').textContent = totalWaves;
            document.getElementById('stat-distance').textContent = totalDist.toFixed(1);
            document.getElementById('stat-hours').textContent = totalHours.toFixed(1);
            document.getElementById('stat-score').textContent = avgScore;
            document.getElementById('stat-best-spot').textContent = bestSpot;
            document.getElementById('stats-subtitle').textContent = `${totalSessions} sessions ¬∑ ${totalWaves} vagues`;

            const streak = ProfileAdvanced.calculateStreak(sessions);
            document.getElementById('stat-streak').textContent = streak;

            const level = ProfileAdvanced.calculateLevel({ sessions_count: totalSessions, avg_score: parseFloat(avgScore) || 0, total_distance_km: totalDist, streak_weeks: streak });
            document.getElementById('level-mini').textContent = level.emoji;

            renderScoreChart(sessions);
            renderHeatmap(sessions);
            renderSessionList(sessions.slice(0, 5));
            renderCommunityCompare(totalSessions, avgScore, totalDist);

            if (member?.is_pro) document.getElementById('export-pro-badge').style.display = 'none';
            else document.getElementById('export-pro-badge').style.display = 'inline-block';
        }

        function renderMockData() {
            // Donn√©es d√©mo si pas connect√©
            document.getElementById('stat-sessions').textContent = '47';
            document.getElementById('stat-waves').textContent = '312';
            document.getElementById('stat-distance').textContent = '89.4';
            document.getElementById('stat-hours').textContent = '38.5';
            document.getElementById('stat-score').textContent = '6.8';
            document.getElementById('stat-streak').textContent = '4';
            document.getElementById('stat-best-spot').textContent = 'Hossegor';
            document.getElementById('stats-subtitle').textContent = '47 sessions ¬∑ 312 vagues ¬∑ Donn√©es d√©mo';
            renderScoreChart([]);
            renderHeatmap([]);
            renderSessionList([]);
            renderCommunityCompare(47, 6.8, 89.4);
        }

        function renderScoreChart(sessions) {
            const existing = Chart.getChart('score-chart');
            if (existing) existing.destroy();
            const last30 = [];
            for (let i = 29; i >= 0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                const ds = sessions.filter(s => s.started_at?.slice(0, 10) === d.toISOString().slice(0, 10));
                last30.push({ label: d.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' }), score: ds.length ? ds.reduce((s, x) => s + (x.score || 0), 0) / ds.length : null });
            }
            new Chart(document.getElementById('score-chart'), {
                type: 'line',
                data: { labels: last30.map(d => d.label), datasets: [{ data: last30.map(d => d.score || null), borderColor: '#0ea5e9', backgroundColor: 'rgba(14,165,233,.08)', borderWidth: 2, pointRadius: 3, fill: true, tension: 0.4, spanGaps: true }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: '#64748b', font: { size: 10 }, maxTicksLimit: 7 }, grid: { display: false } }, y: { min: 0, max: 10, ticks: { color: '#64748b' }, grid: { color: 'rgba(255,255,255,.04)' } } } }
            });
        }

        function renderHeatmap(sessions) {
            const el = document.getElementById('heatmap');
            if (!el) return;
            const sessionDates = new Set(sessions.map(s => s.started_at?.slice(0, 10)));
            const cells = [];
            const d = new Date(); d.setDate(d.getDate() - 182);
            for (let i = 0; i < 182; i++) {
                const date = new Date(d); date.setDate(d.getDate() + i);
                const ds = date.toISOString().slice(0, 10);
                const has = sessionDates.has(ds);
                const sessionsOnDay = sessions.filter(s => s.started_at?.slice(0, 10) === ds).length;
                const intensity = sessionsOnDay === 0 ? 'rgba(255,255,255,.04)' : sessionsOnDay === 1 ? 'rgba(14,165,233,.25)' : sessionsOnDay === 2 ? 'rgba(14,165,233,.5)' : '#0ea5e9';
                cells.push(`<div class="heatmap-cell" style="background:${intensity}" title="${ds}${sessionsOnDay ? ': ' + sessionsOnDay + ' session(s)' : ''}"></div>`);
            }
            el.innerHTML = cells.join('');
        }

        function renderSessionList(sessions) {
            const el = document.getElementById('sessions-list');
            if (!el) return;
            if (!sessions.length) { el.innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted)">üåä Aucune session ‚Äî commence √† surfer !</div>'; return; }
            el.innerHTML = sessions.map(s => {
                const scoreColor = s.score >= 8 ? '#10b981' : s.score >= 5 ? '#f59e0b' : '#ef4444';
                return `<div class="session-item">
      <div class="session-score" style="color:${scoreColor}">${s.score || '?'}</div>
      <div class="session-info">
        <div class="session-name">${s.spot_name || 'Spot inconnu'}</div>
        <div class="session-meta">${new Date(s.started_at).toLocaleDateString('fr-FR')} ¬∑ ${s.duration_minutes || 0} min ¬∑ ${s.wave_count || 0} vagues</div>
      </div>
    </div>`;
            }).join('');
        }

        function renderCommunityCompare(sessions, avgScore, dist) {
            const el = document.getElementById('community-compare');
            if (!el) return;
            const avgCommunity = { sessions: 32, score: 6.2, dist: 62 };
            const rows = [
                ['üèÑ Sessions', sessions, avgCommunity.sessions],
                ['‚≠ê Score moyen', parseFloat(avgScore) || 0, avgCommunity.score],
                ['üìè Distance (km)', parseFloat(dist) || 0, avgCommunity.dist]
            ];
            el.innerHTML = rows.map(([label, me, avg]) => {
                const better = me >= avg;
                return `<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.05)">
      <div style="width:80px;font-size:12px;color:var(--sub)">${label}</div>
      <div style="flex:1;font-size:15px;font-weight:800;color:${better ? '#10b981' : 'var(--text)'}">
        ${typeof me === 'number' ? me.toFixed(me % 1 === 0 ? 0 : 1) : me}
        ${better ? '‚Üë' : '‚Üì'}
      </div>
      <div style="font-size:12px;color:var(--muted)">Moy: ${avg}</div>
    </div>`;
            }).join('');
        }

        async function exportStats() {
            try {
                const { data: { user } } = await supabase?.auth.getUser() || {};
                const { data: member } = user ? await supabase.from('members').select('is_pro').eq('auth_id', user.id).single() : {};
                if (!member?.is_pro) {
                    if (confirm('Export PDF est une fonctionnalit√© Pro. Passer √† Pro pour 4,99‚Ç¨/mois ?')) window.location.href = '/tarifs.html';
                    return;
                }
                // G√©n√©rer un PDF simple via l'API print du navigateur
                window.print();
            } catch { window.print(); }
        }

        // Initialiser
        document.addEventListener('DOMContentLoaded', () => loadStats('month'));
    </script>
</body>

</html>